{% load tz %}
{% for workout in workouts %}
  {% with discipline=workout.ride_detail.fitness_discipline|default_if_none:""|lower %}
  <div class="group rounded-2xl border border-gray-200/70 dark:border-gray-700/80 bg-white/80 dark:bg-gray-800/80 backdrop-blur shadow-sm hover:shadow-lg transition-all overflow-hidden">
    <div class="p-4 sm:p-5">

      <!-- Top row -->
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            {% if workout.actual_duration_minutes > 0 %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-900 text-white dark:bg-white dark:text-gray-900">
                {{ workout.actual_duration_minutes }} min
              </span>
            {% elif workout.duration_minutes > 0 %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-900 text-white dark:bg-white dark:text-gray-900">
                {{ workout.duration_minutes }} min
              </span>
            {% endif %}

            {% if workout.ride_detail and workout.ride_detail.peloton_ride_id and 'manual_' in workout.ride_detail.peloton_ride_id %}
              <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold border border-orange-200 dark:border-orange-900/50 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300">
                <span class="h-1.5 w-1.5 rounded-full bg-orange-500"></span>
                Manual
              </span>
            {% endif %}

            {% if workout.card_chart %}
              <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold border border-blue-200 dark:border-blue-900/50 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300">
                <span class="h-1.5 w-1.5 rounded-full bg-blue-500"></span>
                Chart
              </span>
            {% endif %}
          </div>

          <!-- Title -->
          <h3 class="mt-3 text-base sm:text-lg font-bold tracking-tight text-gray-900 dark:text-white line-clamp-2">
            {{ workout.title }}
          </h3>

          <!-- Instructor / label -->
          <div class="mt-1 text-sm text-gray-600 dark:text-gray-400 truncate">
            {% if workout.ride_detail and workout.ride_detail.peloton_ride_id and 'manual_' in workout.ride_detail.peloton_ride_id %}
              Manual
            {% elif workout.instructor %}
              {{ workout.instructor.name }}
            {% else %}
              &nbsp;
            {% endif %}
          </div>
        </div>

        <!-- Type icon -->
        {% if workout.workout_type %}
          <div class="shrink-0 inline-flex items-center justify-center h-10 w-10 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900/30">
            <span class="text-lg" aria-hidden="true">
              {% if workout.workout_type.slug == 'cycling' or workout.workout_type.slug == 'ride' %}
                üö¥
              {% elif workout.workout_type.slug == 'running' or workout.workout_type.slug == 'run' %}
                üèÉ
              {% elif workout.workout_type.slug == 'walking' %}
                üö∂
              {% elif workout.workout_type.slug == 'yoga' %}
                üßò
              {% elif workout.workout_type.slug == 'strength' %}
                üí™
              {% elif workout.workout_type.slug == 'rowing' %}
                üö£
              {% else %}
                üèãÔ∏è
              {% endif %}
            </span>
          </div>
        {% endif %}
      </div>

      <!-- Dates -->
      <div class="mt-3 flex flex-col gap-1 text-xs text-gray-500 dark:text-gray-400">
        <div class="flex items-center justify-between gap-2">
          <span>Recorded</span>
          <span class="font-medium text-gray-700 dark:text-gray-300 tabular-nums">
            {% if workout.ride_detail and workout.ride_detail.original_air_date %}
              {{ workout.ride_detail.original_air_date|date:"d/m/Y" }}
            {% else %}
              {{ workout.recorded_date|date:"d/m/Y" }}
            {% endif %}
          </span>
        </div>
        <div class="flex items-center justify-between gap-2">
          <span>Completed</span>
          <span class="font-medium text-gray-700 dark:text-gray-300 tabular-nums">
            {{ workout.completed_date|date:"d/m/Y" }}
          </span>
        </div>
      </div>

      <!-- Metrics -->
      <div class="mt-4">
        {% if discipline == "cycling" or discipline == "ride" or discipline == "bike" or discipline == "bike_bootcamp" or discipline == "circuit" %}
          <div class="grid grid-cols-4 gap-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/30 p-3">
            <div class="text-center">
              <div class="text-gray-900 dark:text-white font-semibold text-sm tabular-nums">
                {% if workout.details and workout.details.tss %}
                  {% if workout.details.tss_target %}
                    {{ workout.details.tss|floatformat:0 }}/{{ workout.details.tss_target|floatformat:0 }}
                  {% else %}
                    {{ workout.details.tss|floatformat:0 }}
                  {% endif %}
                {% elif workout.derived_tss %}
                  {{ workout.derived_tss|floatformat:0 }}
                {% else %}
                  ‚Äî
                {% endif %}
              </div>
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">TSS</div>
            </div>

            <div class="text-center">
              <div class="text-gray-900 dark:text-white font-semibold text-sm tabular-nums">
                {% if workout.details and workout.details.avg_output %}{{ workout.details.avg_output|floatformat:0 }}W{% else %}‚Äî{% endif %}
              </div>
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Avg</div>
            </div>

            <div class="text-center">
              <div class="text-gray-900 dark:text-white font-semibold text-sm tabular-nums">
                {% if workout.details and workout.details.total_output %}{{ workout.details.total_output|floatformat:0 }} kJ{% else %}‚Äî{% endif %}
              </div>
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Total</div>
            </div>

            <div class="text-center">
              <div class="text-gray-900 dark:text-white font-semibold text-sm tabular-nums">
                {% if workout.details and workout.details.total_calories %}{{ workout.details.total_calories }}{% else %}‚Äî{% endif %}
              </div>
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Cals</div>
            </div>
          </div>

        {% elif discipline == "running" or discipline == "run" or discipline == "walking" or discipline == "walk" %}
          <div class="grid grid-cols-3 gap-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/30 p-3">
            <div class="text-center">
              <div class="text-gray-900 dark:text-white font-semibold text-sm tabular-nums">
                {% if workout.details and workout.details.distance %}{{ workout.details.distance|floatformat:2 }} mi{% else %}‚Äî{% endif %}
              </div>
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Distance</div>
            </div>

            <div class="text-center">
              <div class="text-gray-900 dark:text-white font-semibold text-sm tabular-nums">
                {% if workout.details and workout.details.avg_speed %}
                  {{ workout.details.avg_speed|floatformat:1 }} mph
                {% elif workout.derived_avg_speed %}
                  {{ workout.derived_avg_speed|floatformat:1 }} mph
                {% else %}
                  ‚Äî
                {% endif %}
              </div>
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Avg mph</div>
            </div>

            <div class="text-center">
              <div class="text-gray-900 dark:text-white font-semibold text-sm tabular-nums">
                {% if workout.details and workout.details.total_calories %}{{ workout.details.total_calories }}{% else %}‚Äî{% endif %}
              </div>
              <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Cals</div>
            </div>
          </div>

        {% else %}
          {% if workout.details %}
            {% if workout.details.total_calories or workout.details.avg_heart_rate %}
              <div class="grid grid-cols-{% if workout.details.total_calories and workout.details.avg_heart_rate %}2{% else %}1{% endif %} gap-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/30 p-3">
                {% if workout.details.total_calories %}
                  <div class="text-center">
                    <div class="text-gray-900 dark:text-white font-semibold text-sm tabular-nums">{{ workout.details.total_calories }}</div>
                    <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Cals</div>
                  </div>
                {% endif %}
                {% if workout.details.avg_heart_rate %}
                  <div class="text-center">
                    <div class="text-gray-900 dark:text-white font-semibold text-sm tabular-nums">{{ workout.details.avg_heart_rate }} bpm</div>
                    <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Avg HR</div>
                  </div>
                {% endif %}
              </div>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>

      <!-- Actions -->
      <div class="mt-4 flex flex-wrap gap-2">
        <a href="{% url 'workouts:detail' workout.id %}"
           class="flex-1 min-w-[160px] inline-flex items-center justify-center gap-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900/20 px-4 py-2 text-sm font-semibold text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
          View details
        </a>

        {% if workout.peloton_url %}
          <a href="{{ workout.peloton_url }}" target="_blank" rel="noopener noreferrer"
             class="flex-1 min-w-[160px] inline-flex items-center justify-center gap-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900/20 px-4 py-2 text-sm font-semibold text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
            Peloton
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 3h7v7m0-7L10 14"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 14v7H3V3h7"></path>
            </svg>
          </a>
        {% elif workout.ride_detail and workout.ride_detail.peloton_class_url %}
          <a href="{{ workout.ride_detail.peloton_class_url }}" target="_blank" rel="noopener noreferrer"
             class="flex-1 min-w-[160px] inline-flex items-center justify-center gap-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900/20 px-4 py-2 text-sm font-semibold text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
            Peloton
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 3h7v7m0-7L10 14"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 14v7H3V3h7"></path>
            </svg>
          </a>
        {% else %}
          <span class="flex-1 min-w-[160px] inline-flex items-center justify-center gap-2 rounded-xl border border-gray-200 dark:border-gray-700 px-4 py-2 text-sm font-semibold text-gray-400 dark:text-gray-600 bg-gray-50 dark:bg-gray-900/10 cursor-not-allowed">
            Peloton
          </span>
        {% endif %}
      </div>
    </div>
  </div>
  {% endwith %}
{% endfor %}

<!-- Infinite Scroll Trigger for next page -->
{% if workouts.has_next %}
  <div
    id="infinite-scroll-trigger"
    hx-get="?page={{ workouts.next_page_number }}&infinite=true"
    hx-trigger="intersect once"
    hx-swap="outerHTML"
    class="col-span-full text-center py-10"
  >
    <div class="inline-flex flex-col items-center gap-2">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      <p class="text-sm text-gray-600 dark:text-gray-400">Loading more workouts‚Ä¶</p>
    </div>
  </div>
{% endif %}
