{% extends "base_app.html" %}
{% load playlist_filters %}
{% block title %}{{ workout.title }}{% endblock %}
{% block page_title %}{{ workout.title }}{% endblock %}

{% block content %}

<!-- Header card -->
<div class="mb-6 rounded-2xl border border-gray-200/70 dark:border-gray-700/80 bg-white/80 dark:bg-gray-800/80 backdrop-blur shadow-sm overflow-hidden">
  <div class="p-4 sm:p-6">
    <!-- Back + actions -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
      <a href="{% url 'workouts:history' %}"
         class="inline-flex items-center gap-2 text-sm font-semibold text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
        <span aria-hidden="true">‚Üê</span>
        Back to history
      </a>

      <div class="flex flex-wrap gap-2">
        {% if workout.peloton_url %}
          <a href="{{ workout.peloton_url }}" target="_blank" rel="noopener noreferrer"
             class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold text-white bg-primary hover:bg-primary-dark transition-colors">
            Workout
            <span aria-hidden="true">‚Üó</span>
          </a>
        {% endif %}

        {% if workout.ride_detail and workout.ride_detail.peloton_class_url %}
          <a href="{{ workout.ride_detail.peloton_class_url }}" target="_blank" rel="noopener noreferrer"
             class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold text-gray-800 dark:text-gray-200 bg-gray-100 dark:bg-gray-700/70 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors border border-gray-200 dark:border-gray-700">
            Class
            <span aria-hidden="true">‚Üó</span>
          </a>
        {% endif %}

        {% if workout.ride_detail %}
          <a href="{% url 'classes:detail' workout.ride_detail.pk %}"
             class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold text-gray-800 dark:text-gray-200 bg-gray-100 dark:bg-gray-700/70 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors border border-gray-200 dark:border-gray-700">
            Library
          </a>
        {% endif %}
      </div>
    </div>

    <!-- Title + badges -->
    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
      <div class="min-w-0">
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-900 text-white dark:bg-white dark:text-gray-900">
            {{ workout.duration_minutes }} min
          </span>

          {% if workout.ride_detail and workout.ride_detail.workout_type %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/30 text-gray-700 dark:text-gray-300">
              {{ workout.ride_detail.workout_type.name }}
            </span>
          {% endif %}

          {# Only show Power Zone badge if this actually is PZ (adjust if you have a boolean) #}
          {% if workout.title|lower|slice:":11" == "power zone " %}
            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold border border-yellow-200 dark:border-yellow-900/40 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-300">
              Power Zone
            </span>
          {% endif %}
        </div>

        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-gray-900 dark:text-white">
          {{ workout.title }}
        </h1>

        <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
          {% if workout.instructor %}
            <span class="font-semibold text-gray-900 dark:text-white">{{ workout.instructor.name }}</span>
          {% else %}
            <span>No instructor</span>
          {% endif %}
          <span class="mx-2 text-gray-400">‚Ä¢</span>
          Recorded <span class="font-medium text-gray-800 dark:text-gray-200">{{ workout.recorded_date|date:"F d, Y" }}</span>
          <span class="mx-2 text-gray-400">‚Ä¢</span>
          Completed <span class="font-medium text-gray-800 dark:text-gray-200">{{ workout.completed_date|date:"F d, Y" }}</span>
        </div>
      </div>
    </div>
  </div>

  {% if workout_summary %}

  <!-- KPI grid -->
  <div class="p-4 sm:p-6">
    <div id="workoutSummaryMetrics" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">

      {% if workout_summary.avg_output_w %}
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/20 p-3">
          <div class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">{{ workout_summary.avg_output_w|floatformat:0 }} W</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Avg Output</div>
        </div>
      {% endif %}

      {% if workout_summary.total_output_kj %}
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/20 p-3">
          <div class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">{{ workout_summary.total_output_kj|floatformat:0 }} kJ</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Total Output</div>
        </div>
      {% endif %}

      {% if workout_summary.max_output_w %}
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/20 p-3">
          <div class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">{{ workout_summary.max_output_w|floatformat:0 }} W</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Max Output</div>
        </div>
      {% endif %}

      {% if workout_summary.distance_mi %}
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/20 p-3">
          <div class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">{{ workout_summary.distance_mi|floatformat:2 }}</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Distance (mi)</div>
        </div>
      {% endif %}

      {% if workout.details and workout.details.avg_cadence %}
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/20 p-3">
          <div class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">{{ workout.details.avg_cadence }}</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Avg Cadence (rpm)</div>
        </div>
      {% endif %}

      {% if workout.details and workout.details.avg_resistance %}
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/20 p-3">
          <div class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">{{ workout.details.avg_resistance|floatformat:0 }}</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Avg Resistance</div>
        </div>
      {% endif %}

      {% if workout_summary.total_calories %}
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/20 p-3">
          <div class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">{{ workout_summary.total_calories }}</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Calories</div>
        </div>
      {% endif %}

      {% if workout_summary.tss %}
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/20 p-3">
          <div class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">{{ workout_summary.tss|floatformat:0 }}</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">TSS</div>
        </div>
      {% endif %}

      {% if if_value %}
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-900/20 p-3">
          <div class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">{{ if_value }}</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">IF</div>
        </div>
      {% endif %}

    </div>
  </div>
</div>
{% endif %}




<!-- Power Zone Timeline Chart -->
{% if performance_data or target_metrics %}
<div class="bg-white dark:bg-gray-800 shadow-sm p-6 sm:p-8 rounded-lg border border-gray-200 dark:border-gray-700 mb-6">
  <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-4">
    <div>
      <h2 class="text-xl sm:text-xl md:text-2xl font-semibold text-gray-900 dark:text-white leading-tight mb-1">Power Zone Timeline</h2>
      <p class="text-sm text-gray-600 dark:text-gray-400">Your output vs class plan target, mapped to FTP zones.</p>
    </div>
    {% if playlist and playlist.songs %}
    <label class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer">
      <input type="checkbox" id="showMusicTimeline" checked class="rounded border-gray-600 text-primary focus:ring-primary bg-gray-700">
      <span>Show Music Timeline</span>
    </label>
    {% endif %}
  </div>

  <div class="power-zone-chart relative">
    {% if playlist and playlist.songs %}
    <div id="musicTimeline" class="mb-3 h-12 relative bg-gray-950 rounded border border-gray-600 overflow-hidden"></div>
    {% endif %}
    <div class="relative bg-gray-900 rounded-lg min-h-[320px] w-full">
      <canvas id="powerZoneChart"></canvas>
    </div>
  </div>

  <div class="flex flex-wrap items-center justify-end gap-2 mt-4">
    <button id="toggleTargetLine" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors border border-gray-300 dark:border-gray-600">
      Hide Target
    </button>
    <button id="saveChart" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors border border-gray-300 dark:border-gray-600 inline-flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
      </svg>
      Share
    </button>
    <label class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors border border-gray-300 dark:border-gray-600 cursor-pointer">
      <input type="checkbox" id="toggleZoneColors" checked class="rounded border-gray-400 text-primary focus:ring-primary">
      <span>Zone Colors</span>
    </label>
  </div>
</div>
{% endif %}

<!-- Sub cards (match pace-target layout) -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 mb-6">
  <!-- Class Info -->
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 sm:p-6 shadow-sm">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Class Info</h3>
    <div class="space-y-3">
      <div>
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Discipline</div>
        <div class="text-lg font-bold text-gray-900 dark:text-white">{{ workout.fitness_discipline }}</div>
      </div>
      <div>
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Type</div>
        <div class="text-lg font-bold text-gray-900 dark:text-white">Power Zone</div>
      </div>
      {% if user_ftp %}
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">FTP (at workout)</div>
          <div class="text-lg font-bold text-gray-900 dark:text-white">{{ user_ftp }} W</div>
        </div>
      {% endif %}
      {% if if_value %}
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">IF (Intensity Factor)</div>
          <div class="text-lg font-bold text-gray-900 dark:text-white">{{ if_value }}</div>
        </div>
      {% endif %}
      {% if workout_summary.tss %}
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">TSS</div>
          <div class="text-lg font-bold text-gray-900 dark:text-white">{{ workout_summary.tss|floatformat:0 }}</div>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Instructor -->
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 sm:p-6 shadow-sm">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Instructor</h3>
    {% if workout.instructor %}
      <div class="flex items-center gap-3">
        {% if workout.instructor.image_url %}
          <img src="{{ workout.instructor.image_url }}" alt="{{ workout.instructor.name }}" class="w-12 h-12 rounded-full object-cover">
        {% else %}
          <div class="w-12 h-12 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
            <span class="text-gray-600 dark:text-gray-400 text-xl">üë§</span>
          </div>
        {% endif %}
        <div class="text-lg font-semibold text-gray-900 dark:text-white">{{ workout.instructor.name }}</div>
      </div>
    {% else %}
      <div class="text-gray-600 dark:text-gray-400">No instructor information</div>
    {% endif %}
  </div>

  <!-- Zone Distribution -->
  {% if zone_targets %}
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 sm:p-6 shadow-sm">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Zone Distribution</h3>

    <div class="mb-4">
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-10 relative overflow-hidden">
        <div class="bg-gradient-to-r from-orange-500 to-yellow-400 h-full rounded-full flex items-center justify-center"
             style="width: {{ zone_targets.overall_percentage }}%">
          <span class="text-white font-bold text-base">{{ zone_targets.overall_percentage|floatformat:0 }}%</span>
        </div>
      </div>
    </div>

    <div class="space-y-3">
      {% for zone_info in zone_targets.zones %}
        <div class="flex items-center justify-between gap-3">
          <div class="min-w-[120px] text-sm font-medium text-gray-700 dark:text-gray-300">Zone {{ zone_info.zone }}</div>
          <div class="flex-1">
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
              <div class="h-full zone-color-{{ zone_info.zone }}" style="width: {{ zone_info.percentage }}%"></div>
            </div>
          </div>
          <div class="text-xs text-gray-600 dark:text-gray-400 min-w-[92px] text-right">
            {{ zone_info.target_time_str }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 sm:p-6 shadow-sm">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Zone Distribution</h3>
    <div class="text-sm text-gray-600 dark:text-gray-400">No zone distribution data available</div>
  </div>
  {% endif %}
</div>

<!-- Playlist -->
{% if playlist and playlist.songs %}
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 sm:p-6 shadow-sm mb-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Class Playlist</h3>
        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          {{ playlist.songs|length }} song{{ playlist.songs|length|pluralize }}
        </div>
      </div>
    </div>
    
    <!-- Songs List -->
    <div class="space-y-2 max-h-96 overflow-y-auto">
      {% for song in playlist.songs %}
        <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors group">
          <!-- Song Number -->
          <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-sm font-semibold text-gray-600 dark:text-gray-400 bg-gray-200 dark:bg-gray-600 rounded-full">
            {{ forloop.counter }}
          </div>
          
          <!-- Album Art -->
          {% if song.album.image_url %}
            <img src="{{ song.album.image_url }}" alt="{{ song.album.name }}" class="w-12 h-12 rounded object-cover flex-shrink-0">
          {% else %}
            <div class="w-12 h-12 rounded bg-gray-300 dark:bg-gray-600 flex items-center justify-center flex-shrink-0">
              <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
              </svg>
            </div>
          {% endif %}
          
          <!-- Song Info -->
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-gray-900 dark:text-white truncate">{{ song.title }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 truncate">
              {% for artist in song.artists %}
                {% if not forloop.first %}, {% endif %}{{ artist.artist_name }}
              {% endfor %}
            </div>
            {% if song.album.name %}
              <div class="text-xs text-gray-500 dark:text-gray-500 truncate">{{ song.album.name }}</div>
            {% endif %}
          </div>
          
          <!-- Song Timing -->
          <div class="flex-shrink-0 text-sm text-gray-500 dark:text-gray-400 mr-2">
            {% if song.start_time_offset %}
              {{ song.start_time_offset|format_song_time }}
            {% endif %}
          </div>
          
          <!-- Spotify Link -->
          {% with spotify_url=song|spotify_search_url %}
            {% if spotify_url %}
              <a href="{{ spotify_url }}" target="_blank" rel="noopener noreferrer" 
                 class="flex-shrink-0 p-2 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors opacity-0 group-hover:opacity-100"
                 title="Open in Spotify">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.42 1.56-.299.421-1.02.599-1.559.3z"/>
                </svg>
              </a>
            {% endif %}
          {% endwith %}
          
          <!-- Explicit Badge -->
          {% if song.explicit_rating == 1 %}
            <div class="flex-shrink-0 px-2 py-1 text-xs font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded">
              E
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
    
    <!-- Top Artists -->
    {% if playlist.top_artists %}
      <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
        <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Top Artists</h4>
        <div class="flex flex-wrap gap-2">
          {% for artist in playlist.top_artists %}
            <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
              {% if artist.image_url %}
                <img src="{{ artist.image_url }}" alt="{{ artist.artist_name }}" class="w-8 h-8 rounded-full object-cover">
              {% endif %}
              <span class="text-sm text-gray-700 dark:text-gray-300">{{ artist.artist_name }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}

{% endblock %}

{% block extra_body %}
<style>
.zone-color-1 { background: linear-gradient(to right, #a855f7, #9333ea); }
.zone-color-2 { background: linear-gradient(to right, #3b82f6, #2563eb); }
.zone-color-3 { background: linear-gradient(to right, #10b981, #059669); }
.zone-color-4 { background: linear-gradient(to right, #f59e0b, #d97706); }
.zone-color-5 { background: linear-gradient(to right, #f97316, #ea580c); }
.zone-color-6 { background: linear-gradient(to right, #ef4444, #dc2626); }
.zone-color-7 { background: linear-gradient(to right, #ec4899, #db2777); }
</style>

{% if performance_data or target_metrics %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6"></script>
{% if spin_up_intervals is not None %}
{{ spin_up_intervals|json_script:"spin-up-intervals-json" }}
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const performanceData = [
    {% for data in performance_data %}
      {
        timestamp: {{ data.timestamp }},
        output: {{ data.output|default:"null" }}
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  
  const userFTP = {{ user_ftp|default:"null" }};
  const targetMetrics = {% if target_metrics_json %}{{ target_metrics_json|safe }}{% else %}null{% endif %};
  const targetLineData = {% if target_line_data %}{{ target_line_data|safe }}{% else %}null{% endif %};
  const rideDetailDurationSeconds = {% if workout.ride_detail and workout.ride_detail.duration_seconds %}{{ workout.ride_detail.duration_seconds }}{% else %}null{% endif %};
  let workoutDuration = rideDetailDurationSeconds || 0;
  if (!workoutDuration || workoutDuration <= 0) {
    if (Array.isArray(performanceData) && performanceData.length > 0) {
      let maxTs = 0;
      for (const p of performanceData) {
        const ts = (p && typeof p.timestamp === 'number') ? p.timestamp : null;
        if (ts !== null && ts > maxTs) maxTs = ts;
      }
      if (maxTs > 0) workoutDuration = maxTs;
    }
  }
  if (!workoutDuration || workoutDuration <= 0) workoutDuration = 1800;
  
  const SPIN_UP_TIME_SHIFT = 0;  // Highlight in-place relative to workout timeline
  function withSpinUpShift(rawStartValue, rawEndValue) {
    const rawStartNumber = Number(rawStartValue ?? 0);
    const rawEndNumber = Number(rawEndValue ?? rawStartNumber);
    if (!Number.isFinite(rawStartNumber) || !Number.isFinite(rawEndNumber)) {
      return null;
    }
    const duration = Math.max(0, rawEndNumber - rawStartNumber);
    if (duration <= 0) {
      return null;
    }
    const shiftedStartRaw = rawStartNumber + SPIN_UP_TIME_SHIFT;
    const clampedStart = Math.max(0, shiftedStartRaw);
    const unclampedEnd = clampedStart + duration;
    const clampedEnd = workoutDuration ? Math.min(workoutDuration, unclampedEnd) : unclampedEnd;
    if (clampedEnd <= clampedStart) {
      return null;
    }
    return { start: clampedStart, end: clampedEnd };
  }
  let spinUpIntervals = [];
  try {
    const spinUpScript = document.getElementById('spin-up-intervals-json');
    if (spinUpScript) {
      const parsed = JSON.parse(spinUpScript.textContent);
      if (Array.isArray(parsed)) {
        spinUpIntervals = parsed
          .map(interval => {
            if (!interval) {
              return null;
            }
            const rawStart = interval.start ?? interval.offset ?? 0;
            const rawEnd = interval.end ?? interval.start ?? 0;
            return withSpinUpShift(rawStart, rawEnd);
          })
          .filter(Boolean)
          .sort((a, b) => a.start - b.start);
      }
    }
  } catch (err) {
    console.warn('[PowerZoneChart][workout-detail] failed parsing spin-up intervals payload', err);
    spinUpIntervals = [];
  }

  if (!spinUpIntervals.length && targetMetrics && Array.isArray(targetMetrics.segments)) {
    targetMetrics.segments.forEach(segment => {
      const rawType = (segment.segment_type || segment.type || '').toLowerCase();
      if (!rawType.includes('spin') || !rawType.includes('up')) {
        return;
      }
      const rawStart = Number(segment.start ?? 0);
      const rawEnd = segment.end !== undefined ? Number(segment.end) : (rawStart + Number(segment.duration || 0));
      const shifted = withSpinUpShift(rawStart, rawEnd);
      if (shifted) {
        spinUpIntervals.push(shifted);
      }
    });
  }

  if (spinUpIntervals.length > 1) {
    spinUpIntervals.sort((a, b) => a.start - b.start);
  }

  if (spinUpIntervals.length > 0) {
    console.debug('[PowerZoneChart][workout-detail] spin-up intervals detected', spinUpIntervals);
  } else if (targetMetrics && Array.isArray(targetMetrics.segments)) {
    console.debug('[PowerZoneChart][workout-detail] no spin-up intervals detected', {
      segmentCount: targetMetrics.segments.length,
      sampleTypes: targetMetrics.segments.slice(0, 5).map(seg => seg.segment_type || seg.type || 'unknown')
    });
  }
  
  function overlapsSpinUpWindow(startTime, endTime) {
    if (!spinUpIntervals.length) return false;
    if (typeof startTime !== 'number' || typeof endTime !== 'number') return false;
    const windowStart = Math.min(startTime, endTime);
    const windowEnd = Math.max(startTime, endTime);
    return spinUpIntervals.some(interval => windowEnd > interval.start && windowStart < interval.end);
  }
  
  // Playlist data for music timeline
  const playlistData = {% if playlist and playlist.songs %}[
    {% for song in playlist.songs %}
    {
      title: "{{ song.title|escapejs }}",
      artists: [{% for artist in song.artists %}"{{ artist.artist_name|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
      start_time: {{ song.start_time_offset|default:0 }},
      duration: {{ song.duration|default:0 }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]{% else %}null{% endif %};
  
  // Calculate song durations
  if (playlistData && playlistData.length > 0) {
    for (let i = 0; i < playlistData.length; i++) {
      const song = playlistData[i];
      if (!song.duration || song.duration <= 0) {
        if (i < playlistData.length - 1) {
          song.duration = playlistData[i + 1].start_time - song.start_time;
        } else {
          song.duration = Math.max(180, workoutDuration - song.start_time);
        }
      }
    }
  }

  // Power Zone colors + labels
  // Match history page palette (mirrors Peloton zone colors)
  const zoneColors = {
    1: '#6f42c1',
    2: '#17a2b8',
    3: '#28a745',
    4: '#ffc107',
    5: '#fd7e14',
    6: '#dc3545',
    7: '#6610f2'
  };
  const zoneShortLabels = { 1: 'Zone 1', 2: 'Zone 2', 3: 'Zone 3', 4: 'Zone 4', 5: 'Zone 5', 6: 'Zone 6', 7: 'Zone 7' };

  // Build zone ranges from target metrics (preferred), otherwise compute from FTP
  let zoneRanges = null;
  if (targetMetrics && targetMetrics.zone_ranges) {
    zoneRanges = targetMetrics.zone_ranges;
  } else if (userFTP && userFTP > 0) {
    zoneRanges = {
      '1': [0, userFTP * 0.55],
      '2': [userFTP * 0.55, userFTP * 0.75],
      '3': [userFTP * 0.75, userFTP * 0.90],
      '4': [userFTP * 0.90, userFTP * 1.05],
      '5': [userFTP * 1.05, userFTP * 1.20],
      '6': [userFTP * 1.20, userFTP * 1.50],
      '7': [userFTP * 1.50, null]
    };
  }

  // Helper: format time from seconds
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // Build datasets
  const datasets = [];
  if (Array.isArray(targetLineData) && targetLineData.length > 0) {
    const targetSeries = targetLineData
      .filter(p => p && typeof p.timestamp === 'number')
      .map(p => ({ x: p.timestamp, y: (typeof p.target_output === 'number' ? p.target_output : null) }));
    const TARGET_LINE_COLOR = '#93c5fd';
    const SPIN_UP_TARGET_COLOR = '#fb7185';
    const targetDataset = {
      label: 'Target',
      data: targetSeries,
      borderColor: TARGET_LINE_COLOR,
      backgroundColor: 'rgba(147, 197, 253, 0.12)',
      borderWidth: 2,
      fill: false,
      tension: 0,
      stepped: true,
      pointRadius: 0,
      pointHoverRadius: 5,
      pointHitRadius: 20,
      spanGaps: true,
      order: 1,
      parsing: { xAxisKey: 'x', yAxisKey: 'y' }
    };
    if (spinUpIntervals.length > 0) {
      let spinUpColorLogged = false;
      targetDataset.segment = {
        borderColor: ctx => {
          if (!ctx || ctx.p0?.skip || ctx.p1?.skip) {
            return undefined;
          }
          const startTime = ctx.p0?.parsed?.x;
          const endTime = ctx.p1?.parsed?.x;
          if (overlapsSpinUpWindow(startTime, endTime)) {
            if (!spinUpColorLogged) {
              console.debug('[PowerZoneChart][workout-detail] applying spin-up highlight', { startTime, endTime });
              spinUpColorLogged = true;
            }
            return SPIN_UP_TARGET_COLOR;
          }
          return TARGET_LINE_COLOR;
        }
      };
    }
    datasets.push(targetDataset);
  }

  const actualSeries = (Array.isArray(performanceData) ? performanceData : [])
    .filter(p => p && typeof p.timestamp === 'number')
    .map(p => ({ x: p.timestamp, y: (typeof p.output === 'number' ? p.output : null) }));
  datasets.push({
    label: 'Actual',
    data: actualSeries,
    borderColor: '#e0fe48', // lime
    backgroundColor: 'rgba(224, 254, 72, 0.10)',
    borderWidth: 2.5,
    fill: false,
    tension: 0.15,
    stepped: false,
    pointRadius: 0,
    pointHoverRadius: 6,
    pointHitRadius: 20,
    spanGaps: true,
    order: 2,
    parsing: { xAxisKey: 'x', yAxisKey: 'y' }
  });

  // Zone bands plugin (colors toggleable, labels always on)
  let zoneBandsEnabled = true;
  const zoneBandsPlugin = {
    id: 'zoneBands',
    beforeDatasetsDraw(chart, args, opts) {
      if (!zoneBandsEnabled) return;
      if (!zoneRanges) return;
      const { ctx, chartArea, scales } = chart;
      ctx.save();
      ctx.globalAlpha = 0.18;
      for (let z = 1; z <= 7; z++) {
        const key = String(z);
        const range = zoneRanges[key];
        if (!range || !Array.isArray(range)) continue;
        const lo = (typeof range[0] === 'number') ? range[0] : null;
        const hi = (typeof range[1] === 'number') ? range[1] : null;
        if (lo === null) continue;

        const yTop = scales.y.getPixelForValue(hi !== null ? hi : scales.y.max);
        const yBot = scales.y.getPixelForValue(lo);

        ctx.fillStyle = zoneColors[z] || '#888';
        ctx.fillRect(chartArea.left, Math.min(yTop, yBot), chartArea.right - chartArea.left, Math.abs(yBot - yTop));
      }
      ctx.restore();
    },
    afterDraw(chart, args, opts) {
      if (!zoneRanges) return;
      const { ctx, chartArea, scales } = chart;
      ctx.save();
      ctx.font = '12px sans-serif';
      ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      for (let z = 1; z <= 7; z++) {
        const key = String(z);
        const range = zoneRanges[key];
        if (!range || !Array.isArray(range)) continue;
        const lo = (typeof range[0] === 'number') ? range[0] : null;
        const hi = (typeof range[1] === 'number') ? range[1] : null;
        if (lo === null) continue;
        const mid = (hi !== null && typeof hi === 'number') ? ((lo + hi) / 2) : lo;
        const yPos = scales.y.getPixelForValue(mid);
        ctx.fillText(zoneShortLabels[z] || `Zone ${z}`, chartArea.left + 8, yPos);
      }
      ctx.restore();
    }
  };
  
  const ctx = document.getElementById('powerZoneChart');
  let powerZoneChartInstance = null;
  if (ctx) {
    powerZoneChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        layout: {
          padding: 0
        },
        interaction: {
          mode: 'index',
          intersect: false,
          axis: 'x'
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: 'rgba(255, 255, 255, 0.8)',
              font: { size: 14, family: "'Inter', sans-serif" },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                const seconds = context[0].parsed.x;
                return formatTime(seconds);
              },
              afterLabel: function(context) {
                if (context.dataset && context.dataset.label === 'Actual' && userFTP && context.parsed && typeof context.parsed.y === 'number') {
                  const output = context.parsed.y;
                  const pct = Math.round((output / userFTP) * 100);
                  // Derive zone by %FTP
                  let zone = null;
                  if (pct < 55) zone = 1;
                  else if (pct < 75) zone = 2;
                  else if (pct < 90) zone = 3;
                  else if (pct < 105) zone = 4;
                  else if (pct < 120) zone = 5;
                  else if (pct < 150) zone = 6;
                  else zone = 7;
                  return `Zone ${zone} (${pct}% FTP)`;
                }
                return '';
              }
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            min: 0,
            max: workoutDuration,
            display: false,
            grid: { display: false, drawBorder: false },
            ticks: { display: false },
            border: { display: false }
          },
          y: {
            type: 'linear',
            position: 'left',
            display: false,
            grid: { display: false, drawOnChartArea: false, drawTicks: false },
            ticks: { display: false },
            border: { display: false }
          }
        }
      },
      plugins: [zoneBandsPlugin]
    });
  }

  // Music timeline rendering
  if (playlistData && playlistData.length > 0) {
    const musicTimelineEl = document.getElementById('musicTimeline');
    const showMusicCheckbox = document.getElementById('showMusicTimeline');

    function renderMusicTimeline() {
      if (!musicTimelineEl || !showMusicCheckbox) return;
      if (!showMusicCheckbox.checked) {
        musicTimelineEl.classList.add('hidden');
        return;
      }
      musicTimelineEl.classList.remove('hidden');
      musicTimelineEl.innerHTML = '';

      const maxTime = workoutDuration;
      const songColors = [
        'rgba(91, 124, 250, 0.4)', 'rgba(34, 197, 94, 0.4)',
        'rgba(234, 179, 8, 0.4)', 'rgba(239, 68, 68, 0.4)',
        'rgba(168, 85, 247, 0.4)', 'rgba(236, 72, 153, 0.4)',
        'rgba(20, 184, 166, 0.4)', 'rgba(251, 146, 60, 0.4)'
      ];

      playlistData.forEach((song, idx) => {
        const startTime = song.start_time || 0;
        const duration = song.duration || 180;

        const startPercent = maxTime > 0 ? (startTime / maxTime) * 100 : 0;
        const widthPercent = maxTime > 0 ? (duration / maxTime) * 100 : 0;

        const actualStartPercent = Math.max(0, Math.min(startPercent, 100));
        const actualWidthPercent = Math.max(0, Math.min(widthPercent, 100 - actualStartPercent));
        if (actualWidthPercent < 0.5 || actualStartPercent >= 100) return;

        const segment = document.createElement('div');
        const color = songColors[idx % songColors.length];
        const artistName = song.artists && song.artists.length > 0 ? song.artists[0] : '';

        segment.style.cssText = `
          position: absolute;
          left: ${actualStartPercent}%;
          width: ${actualWidthPercent}%;
          height: 100%;
          background: ${color};
          border-right: 1px solid rgba(255,255,255,0.25);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: flex-start;
          padding: 2px 6px;
          font-size: 10px;
          line-height: 1.2;
          color: rgba(255,255,255,0.95);
          overflow: hidden;
          cursor: pointer;
          transition: opacity 0.2s, background 0.2s;
          min-width: 60px;
        `;

        segment.onmouseenter = () => {
          segment.style.opacity = '0.85';
          segment.style.background = color.replace('0.4', '0.6');
        };
        segment.onmouseleave = () => {
          segment.style.opacity = '1';
          segment.style.background = color;
        };

        const titleEl = document.createElement('div');
        titleEl.style.cssText = 'font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; font-size: 10px;';
        titleEl.textContent = song.title || 'Unknown';

        if (artistName && actualWidthPercent > 5) {
          const artistEl = document.createElement('div');
          artistEl.style.cssText = 'font-size: 9px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; margin-top: 1px;';
          artistEl.textContent = artistName;
          segment.appendChild(artistEl);
        }

        segment.insertBefore(titleEl, segment.firstChild);
        segment.title = `${song.title}${artistName ? ' ‚Ä¢ ' + artistName : ''}`;
        musicTimelineEl.appendChild(segment);
      });
    }

    if (showMusicCheckbox) {
      showMusicCheckbox.addEventListener('change', renderMusicTimeline);
      setTimeout(renderMusicTimeline, 200);
    }
  }

  // Chart controls
  const toggleTargetBtn = document.getElementById('toggleTargetLine');
  const toggleZoneColorsCheckbox = document.getElementById('toggleZoneColors');
  const saveChartBtn = document.getElementById('saveChart');

  if (toggleTargetBtn && powerZoneChartInstance) {
    toggleTargetBtn.addEventListener('click', function() {
      const targetDataset = powerZoneChartInstance.data.datasets.find(ds => ds.label === 'Target');
      if (targetDataset) {
        targetDataset.hidden = !targetDataset.hidden;
        this.textContent = targetDataset.hidden ? 'Show Target' : 'Hide Target';
        powerZoneChartInstance.update();
      }
    });
  }

  if (toggleZoneColorsCheckbox && powerZoneChartInstance) {
    toggleZoneColorsCheckbox.addEventListener('change', function() {
      zoneBandsEnabled = !!this.checked;
      powerZoneChartInstance.update('none');
    });
  }

  // Share chart image (or download fallback)
  if (saveChartBtn && powerZoneChartInstance) {
    saveChartBtn.addEventListener('click', async function() {
      try {
        const chartCanvas = powerZoneChartInstance.canvas;
        if (!chartCanvas) return;

        const headerEl = document.getElementById('shareHeader');
        const metricsEl = document.getElementById('workoutSummaryMetrics');

        const width = chartCanvas.width;
        const height = chartCanvas.height;

        const pad = 28;
        const headerHeight = headerEl ? 72 : 0;
        const metricsHeight = metricsEl ? 96 : 0;
        const gap = (headerEl || metricsEl) ? 18 : 0;
        const topBlockHeight = headerHeight + metricsHeight + gap;

        const outCanvas = document.createElement('canvas');
        outCanvas.width = width;
        outCanvas.height = height + topBlockHeight;

        const outCtx = outCanvas.getContext('2d');
        if (!outCtx) return;

        outCtx.save();
        outCtx.fillStyle = '#121212';
        outCtx.fillRect(0, 0, outCanvas.width, outCanvas.height);

        outCtx.strokeStyle = 'rgba(224, 254, 72, 0.9)';
        outCtx.lineWidth = 3;
        outCtx.strokeRect(1.5, 1.5, outCanvas.width - 3, outCanvas.height - 3);

        let y = pad;
        if (headerEl) {
          const title = headerEl.querySelector('h2')?.textContent?.trim() || '';
          const sub = headerEl.querySelector('.text-sm')?.textContent?.replace(/\s+/g, ' ')?.trim() || '';
          const date = headerEl.querySelector('.text-xs')?.textContent?.trim() || '';

          outCtx.fillStyle = 'rgba(255,255,255,0.95)';
          outCtx.font = '700 26px Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
          outCtx.fillText(title, pad, y + 26);

          outCtx.fillStyle = 'rgba(255,255,255,0.75)';
          outCtx.font = '500 16px Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
          outCtx.fillText(sub, pad, y + 52);

          if (date) {
            outCtx.fillStyle = 'rgba(255,255,255,0.55)';
            outCtx.font = '500 14px Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
            const dateWidth = outCtx.measureText(date).width;
            outCtx.fillText(date, outCanvas.width - pad - dateWidth, y + 18);
          }

          y += headerHeight;
        }

        if (metricsEl) {
          const tiles = Array.from(metricsEl.querySelectorAll(':scope > div')).slice(0, 6);
          const cols = Math.min(6, Math.max(3, tiles.length || 0));
          const tileGap = 14;
          const tileW = (outCanvas.width - pad * 2 - tileGap * (cols - 1)) / cols;
          const tileH = 66;

          tiles.slice(0, cols).forEach((tile, i) => {
            const value = tile.querySelector('.text-xl')?.textContent?.trim() || tile.querySelector('.text-lg')?.textContent?.trim() || '';
            const label = tile.querySelector('.text-xs')?.textContent?.trim() || tile.querySelector('.text-sm')?.textContent?.trim() || '';
            const x = pad + i * (tileW + tileGap);

            outCtx.fillStyle = 'rgba(255,255,255,0.06)';
            outCtx.strokeStyle = 'rgba(255,255,255,0.12)';
            outCtx.lineWidth = 1;
            outCtx.beginPath();
            outCtx.roundRect(x, y, tileW, tileH, 10);
            outCtx.fill();
            outCtx.stroke();

            outCtx.fillStyle = 'rgba(255,255,255,0.9)';
            outCtx.font = '700 18px Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
            outCtx.fillText(value, x + 12, y + 28);

            outCtx.fillStyle = 'rgba(255,255,255,0.65)';
            outCtx.font = '500 12px Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
            outCtx.fillText(label, x + 12, y + 48);
          });

          y += metricsHeight + gap;
        } else if (headerEl) {
          y += gap;
        }

        outCtx.drawImage(chartCanvas, 0, y);
        outCtx.restore();

        const dataUrl = outCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'power-zone-chart.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        const dataUrl = powerZoneChartInstance.toBase64Image();
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'power-zone-chart.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    });
  }
});
</script>
{% endif %}
{% endblock %}
