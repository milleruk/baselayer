{% extends "base.html" %}
{% block title %}Class Library{% endblock %}
{% block page_title %}Class Library{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Class Library</h1>
  <p class="text-gray-600 dark:text-gray-400">Browse and filter all available Peloton classes.</p>
</div>

<!-- Filters and Search -->
<div class="mb-6 space-y-4">
  <!-- Search Bar -->
  <form method="get" action="{% url 'workouts:library' %}" class="flex flex-col sm:flex-row gap-3">
    <div class="flex-1 relative">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
      <input type="text" name="search" value="{{ search_query }}" placeholder="Search classes by title or instructor" 
             class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent">
    </div>
    
    <!-- Filter Dropdowns -->
    <div class="flex flex-wrap gap-2">
      <!-- TSS Filter -->
      <div class="relative">
        <input type="number" name="tss" value="{{ tss_filter }}" placeholder="TSS" min="0" step="0.1"
               class="w-20 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent">
      </div>
      
      <!-- Instructor Filter -->
      <div class="relative min-w-[140px]">
        <select name="instructor" 
                class="w-full appearance-none bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 pr-8 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent cursor-pointer text-sm filter-select">
          <option value="">Add Instructor</option>
          {% for instructor in instructors %}
            <option value="{{ instructor.id }}" {% if instructor_filter == instructor.id|stringformat:"s" %}selected{% endif %}>
              {{ instructor.name }}
            </option>
          {% endfor %}
        </select>
        <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
          <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      
      <!-- Duration Filter -->
      <div class="relative min-w-[120px]">
        <select name="duration" 
                class="w-full appearance-none bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 pr-8 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent cursor-pointer text-sm filter-select">
          <option value="">Add Duration</option>
          {% for duration in durations %}
            <option value="{{ duration }}" {% if duration_filter == duration|stringformat:"s" %}selected{% endif %}>
              {{ duration }} min
            </option>
          {% endfor %}
        </select>
        <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
          <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      
      <!-- Preserve workout type filter -->
      {% if workout_type_filter %}
        <input type="hidden" name="type" value="{{ workout_type_filter }}">
      {% endif %}
      
      <!-- Preserve order by -->
      {% if order_by and order_by != '-original_air_time' %}
        <input type="hidden" name="order_by" value="{{ order_by }}">
      {% endif %}
      
      <button type="submit" id="filter-submit-btn" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-dark rounded-lg transition-colors whitespace-nowrap">
        Search
      </button>
    </div>
  </form>
  
  <!-- Workout Type Tabs -->
  <div class="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0">
    <div class="flex gap-1 border-b border-gray-200 dark:border-gray-700 min-w-max sm:min-w-0">
      <a href="#" data-type="" class="workout-type-tab px-4 py-2 text-sm font-medium {% if not workout_type_filter %}text-primary border-b-2 border-primary{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white{% endif %} transition-colors">
        All
      </a>
      {% for workout_type in workout_types %}
        <a href="#" data-type="{{ workout_type.slug }}" class="workout-type-tab px-4 py-2 text-sm font-medium {% if workout_type_filter == workout_type.slug %}text-primary border-b-2 border-primary{% else %}text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white{% endif %} transition-colors">
          {{ workout_type.name }}
        </a>
      {% endfor %}
    </div>
  </div>
  
  <!-- Active Filters Display -->
  {% if search_query or instructor_filter or duration_filter or tss_filter %}
    <div class="flex flex-wrap gap-2 items-center">
      <span class="text-sm text-gray-600 dark:text-gray-400">Active filters:</span>
      {% if search_query %}
        <span class="inline-flex items-center gap-1 px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full">
          Search: "{{ search_query }}"
          <a href="?{% if workout_type_filter %}type={{ workout_type_filter }}&{% endif %}{% if instructor_filter %}instructor={{ instructor_filter }}&{% endif %}{% if duration_filter %}duration={{ duration_filter }}&{% endif %}{% if tss_filter %}tss={{ tss_filter }}{% endif %}{% if order_by and order_by != '-original_air_time' %}&order_by={{ order_by }}{% endif %}" class="hover:text-gray-900 dark:hover:text-white">Ã—</a>
        </span>
      {% endif %}
      {% if instructor_filter %}
        {% for instructor in instructors %}
          {% if instructor.id|stringformat:"s" == instructor_filter %}
            <span class="inline-flex items-center gap-1 px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full">
              Instructor: {{ instructor.name }}
              <a href="?{% if workout_type_filter %}type={{ workout_type_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if duration_filter %}duration={{ duration_filter }}&{% endif %}{% if tss_filter %}tss={{ tss_filter }}{% endif %}{% if order_by and order_by != '-original_air_time' %}&order_by={{ order_by }}{% endif %}" class="hover:text-gray-900 dark:hover:text-white">Ã—</a>
            </span>
          {% endif %}
        {% endfor %}
      {% endif %}
      {% if duration_filter %}
        <span class="inline-flex items-center gap-1 px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full">
          Duration: {{ duration_filter }} min
          <a href="?{% if workout_type_filter %}type={{ workout_type_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if instructor_filter %}instructor={{ instructor_filter }}&{% endif %}{% if tss_filter %}tss={{ tss_filter }}{% endif %}{% if order_by and order_by != '-original_air_time' %}&order_by={{ order_by }}{% endif %}" class="hover:text-gray-900 dark:hover:text-white">Ã—</a>
        </span>
      {% endif %}
      {% if tss_filter %}
        <span class="inline-flex items-center gap-1 px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full">
          TSS: â‰¥{{ tss_filter }}
          <a href="?{% if workout_type_filter %}type={{ workout_type_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if instructor_filter %}instructor={{ instructor_filter }}&{% endif %}{% if duration_filter %}duration={{ duration_filter }}{% endif %}{% if order_by and order_by != '-original_air_time' %}&order_by={{ order_by }}{% endif %}" class="hover:text-gray-900 dark:hover:text-white">Ã—</a>
        </span>
      {% endif %}
    </div>
  {% endif %}
</div>

<!-- Class Count and Pagination Info -->
<div id="class-count-info" class="mb-4 text-sm text-gray-600 dark:text-gray-400">
  {% if rides_with_metrics %}
    Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count }} class{{ page_obj.paginator.count|pluralize:"es" }}
  {% endif %}
</div>

<!-- Class List (Card Layout) -->
<div id="class-list-container">
{% if rides_with_metrics %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
    {% for ride_data in rides_with_metrics %}
      {% with ride=ride_data.ride %}
      <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 shadow-sm hover:shadow-md transition-all">
        <!-- Top Section: Duration Badge and Activity Icon -->
        <div class="flex items-start justify-between mb-3">
          <span class="px-3 py-1 text-sm font-bold text-gray-900 bg-yellow-400 rounded-full">
            {{ ride.duration_minutes }}min
          </span>
          {% if ride.workout_type %}
            <div class="text-primary dark:text-primary-light">
              {% if ride.workout_type.slug == 'cycling' %}
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
              {% elif ride.workout_type.slug == 'running' %}
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
              {% elif ride.workout_type.slug == 'walking' %}
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                </svg>
              {% else %}
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                </svg>
              {% endif %}
            </div>
          {% endif %}
        </div>
        
        <!-- Title -->
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1 line-clamp-2">
          {{ ride.title }}
        </h3>
        
        <!-- Instructor and Date -->
        <div class="mb-3 space-y-0.5">
          {% if ride.instructor %}
            <p class="text-sm text-gray-700 dark:text-gray-300">{{ ride.instructor.name }}</p>
          {% endif %}
          {% if ride.original_air_date and ride.original_air_time and ride.original_air_time > 1000000 %}
            <p class="text-xs text-gray-500 dark:text-gray-500">Recorded: {{ ride.original_air_date|date:"m/d/Y" }}</p>
          {% endif %}
        </div>
        
        <!-- Metrics Section: TSS/IF or Difficulty -->
        <div class="flex items-center justify-center gap-4 mb-3 py-2 border-y border-gray-200 dark:border-gray-700">
          {% if ride.class_type == 'power_zone' or ride.is_power_zone_class %}
            {% if ride_data.tss %}
              <div class="text-center">
                <div class="text-xl font-bold text-gray-900 dark:text-white">{{ ride_data.tss|floatformat:0 }}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">TSS</div>
              </div>
            {% endif %}
            {% if ride_data.if_value %}
              <div class="w-px h-8 bg-gray-300 dark:bg-gray-700"></div>
              <div class="text-center">
                <div class="text-xl font-bold text-gray-900 dark:text-white">{{ ride_data.if_value|floatformat:2 }}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">IF</div>
              </div>
            {% endif %}
          {% else %}
            {% if ride_data.difficulty %}
              <div class="text-center">
                <div class="text-xl font-bold text-gray-900 dark:text-white">{{ ride_data.difficulty }}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">Difficulty</div>
              </div>
            {% endif %}
          {% endif %}
        </div>
        
        <!-- Class Plan Chart -->
        {% if ride_data.chart_data %}
          <div class="mb-3 h-32 relative bg-gray-50 dark:bg-gray-900 rounded overflow-hidden p-2">
            <canvas id="chart-{{ ride.id }}"></canvas>
            <script type="application/json" id="chart-data-{{ ride.id }}">{{ ride_data.chart_data|safe }}</script>
          </div>
        {% elif ride_data.zone_data %}
          <!-- Fallback: Zone Distribution Bars -->
          <div class="mb-3 h-24 relative bg-gray-50 dark:bg-gray-900 rounded overflow-hidden">
            {% if ride.class_type == 'power_zone' or ride.is_power_zone_class %}
              <!-- Power Zone Chart - Stacked from bottom (Zone 1) to top (Zone 7) -->
              <div class="absolute inset-0 flex flex-col-reverse">
                {% for zone_info in ride_data.zone_data %}
                  {% if zone_info.zone == 1 %}
                    <div class="bg-purple-600" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 2 %}
                    <div class="bg-blue-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 3 %}
                    <div class="bg-teal-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 4 %}
                    <div class="bg-green-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 5 %}
                    <div class="bg-yellow-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 6 %}
                    <div class="bg-orange-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 7 %}
                    <div class="bg-red-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% endif %}
                {% endfor %}
              </div>
            {% else %}
              <!-- Pace Target Intensity Chart - Stacked from bottom (Recovery) to top (Max) -->
              <div class="absolute inset-0 flex flex-col-reverse">
                {% for zone_info in ride_data.zone_data %}
                  {% if zone_info.zone == 'recovery' %}
                    <div class="bg-purple-600" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 'easy' %}
                    <div class="bg-blue-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 'moderate' %}
                    <div class="bg-teal-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 'challenging' %}
                    <div class="bg-green-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 'hard' %}
                    <div class="bg-orange-500" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 'very_hard' %}
                    <div class="bg-orange-600" style="height: {{ zone_info.percentage }}%"></div>
                  {% elif zone_info.zone == 'max' %}
                    <div class="bg-red-600" style="height: {{ zone_info.percentage }}%"></div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% endif %}
        
        <!-- Action Buttons -->
        <div class="flex gap-2">
          <a href="{% url 'workouts:class_detail' ride.id %}" 
             class="flex-1 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-center">
            View Details
          </a>
          {% if ride.peloton_class_url %}
            <a href="{{ ride.peloton_class_url }}" target="_blank" rel="noopener noreferrer" 
               class="flex-1 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-center flex items-center justify-center gap-1">
              View on Peloton
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
            </a>
          {% else %}
            <span class="flex-1 px-3 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg text-center cursor-not-allowed opacity-50">
              View on Peloton
            </span>
          {% endif %}
        </div>
      </div>
      {% endwith %}
    {% endfor %}
  </div>
{% else %}
  <div class="text-center py-12">
    <div class="text-5xl mb-4">ðŸ“š</div>
    <p class="text-gray-600 dark:text-gray-400 text-lg mb-2">No classes found</p>
    <p class="text-gray-500 dark:text-gray-500 text-sm">Try adjusting your filters or search query.</p>
  </div>
{% endif %}
</div>
  
  <!-- Pagination -->
<div id="pagination-container">
  {% if rides_with_metrics and is_paginated %}
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-6">
      <div class="text-sm text-gray-600 dark:text-gray-400">
        Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count }} class{{ page_obj.paginator.count|pluralize:"es" }}
      </div>
      
      <div class="flex items-center gap-2">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if workout_type_filter %}&type={{ workout_type_filter }}{% endif %}{% if instructor_filter %}&instructor={{ instructor_filter }}{% endif %}{% if duration_filter %}&duration={{ duration_filter }}{% endif %}{% if order_by != '-original_air_time' %}&order_by={{ order_by }}{% endif %}" 
             class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            Previous
          </a>
        {% else %}
          <span class="px-4 py-2 text-sm font-medium text-gray-400 dark:text-gray-600 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg cursor-not-allowed opacity-50">
            Previous
          </span>
        {% endif %}
        
        <span class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
        
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if workout_type_filter %}&type={{ workout_type_filter }}{% endif %}{% if instructor_filter %}&instructor={{ instructor_filter }}{% endif %}{% if duration_filter %}&duration={{ duration_filter }}{% endif %}{% if order_by != '-original_air_time' %}&order_by={{ order_by }}{% endif %}" 
             class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            Next
          </a>
        {% else %}
          <span class="px-4 py-2 text-sm font-medium text-gray-400 dark:text-gray-600 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg cursor-not-allowed opacity-50">
            Next
          </span>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize mini charts for class cards
  {% for ride_data in rides_with_metrics %}
    {% if ride_data.chart_data %}
      (function() {
        const chartDataScript = document.getElementById('chart-data-{{ ride_data.ride.id }}');
        if (!chartDataScript) return;
        
        let chartData;
        try {
          chartData = JSON.parse(chartDataScript.textContent || '{}');
        } catch (e) {
          console.error('Error parsing chart data for ride {{ ride_data.ride.id }}:', e);
          return;
        }
        if (!chartData.segments || !chartData.zones) return;
        
        const canvas = document.getElementById('chart-{{ ride_data.ride.id }}');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const isDark = document.documentElement.classList.contains('dark');
        const textColor = isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.05)';
        
        // Build time series data
        const timePoints = [];
        const targetSeries = [];
        let segmentTime = 0;
        
        chartData.segments.forEach(segment => {
          const duration = segment.duration;
          let target = segment.zone;
          
          if (chartData.type === 'power_zone') {
            target = Math.max(1, Math.min(7, target || 1));
          } else {
            target = Math.max(0, Math.min(6, target || 0));
          }
          
          for (let i = 0; i < duration && (segmentTime + i) < chartData.total_duration; i += 10) {
            timePoints.push(segmentTime + i);
            targetSeries.push(target);
          }
          segmentTime += duration;
        });
        
        if (chartData.total_duration > 0 && (timePoints.length === 0 || timePoints[timePoints.length - 1] < chartData.total_duration)) {
          timePoints.push(chartData.total_duration);
          targetSeries.push(targetSeries[targetSeries.length - 1] || (chartData.type === 'power_zone' ? 1 : 0));
        }
        
        // Create zone bands
        const zoneBands = chartData.zones.map((zone, index) => {
          const zoneNum = chartData.type === 'power_zone' ? index + 1 : index;
          return {
            label: zone.name,
            lower: zoneNum - 0.5,
            upper: zoneNum + 0.5,
            color: zone.color
          };
        });
        
        // Zone band plugin
        const bandPlugin = {
          id: 'zoneBands',
          beforeDatasetsDraw(chart, args, opts) {
            const {ctx, chartArea, scales} = chart;
            if (!opts || !Array.isArray(opts.bands)) return;
            const toY = (zone) => scales.y.getPixelForValue(zone);
            ctx.save();
            (opts.bands || []).forEach(b => {
              const yTop = toY(b.upper);
              const yBot = toY(b.lower);
              if (yTop == null || yBot == null) return;
              ctx.fillStyle = b.color;
              ctx.globalAlpha = 0.15;
              ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBot - yTop);
            });
            ctx.restore();
          }
        };
        
        // Create chart
        new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Target',
              data: timePoints.map((time, index) => ({ x: time, y: targetSeries[index] })),
              borderWidth: 2,
              pointRadius: 0,
              borderColor: '#5b7cfa',
              backgroundColor: 'rgba(91, 124, 250, 0.1)',
              fill: true,
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
              zoneBands: { bands: zoneBands }
            },
            scales: {
              x: {
                type: 'linear',
                min: 0,
                max: chartData.total_duration,
                display: false,
                grid: { display: false }
              },
              y: {
                min: chartData.type === 'power_zone' ? 0.5 : -0.5,
                max: chartData.type === 'power_zone' ? 7.5 : 6.5,
                display: false,
                grid: { display: false }
              }
            }
          },
          plugins: [bandPlugin]
        });
      })();
    {% endif %}
  {% endfor %}
  
  // AJAX Filter Handling for Class Library
  const filterForm = document.querySelector('form[action="{% url 'workouts:library' %}"]');
  
  if (filterForm) {
    filterForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(filterForm);
      const params = new URLSearchParams();
      
      for (const [key, value] of formData.entries()) {
        if (value) {
          params.append(key, value);
        }
      }
      
      const newUrl = '{% url "workouts:library" %}?' + params.toString();
      window.location.href = newUrl;
    });
  }
  
  // Workout Type Tabs (matching history page)
  document.querySelectorAll('.workout-type-tab').forEach(tab => {
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      const type = this.getAttribute('data-type');
      const form = filterForm;
      const formData = new FormData(form);
      
      // Update or remove type filter
      if (type) {
        formData.set('type', type);
      } else {
        formData.delete('type');
      }
      
      // Build URL with all current filters
      const params = new URLSearchParams();
      for (const [key, value] of formData.entries()) {
        if (value) {
          params.append(key, value);
        }
      }
      
      window.location.href = '{% url "workouts:library" %}?' + params.toString();
    });
  });
  
  // Handle filter removal
  document.querySelectorAll('a[href*="workouts:library"]').forEach(link => {
    link.addEventListener('click', function(e) {
      // Let the link work normally
    });
  });
});
</script>
{% endblock %}
