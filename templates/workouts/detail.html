{% extends "base.html" %}
{% load playlist_filters %}
{% block title %}{{ workout.title }}{% endblock %}
{% block page_title %}{{ workout.title }}{% endblock %}

{% block content %}
<!-- Back Button -->
<a href="{% url 'workouts:history' %}" class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white mb-6 transition-colors">
  <span>←</span> Back to Workout History
</a>

<!-- Workout Header -->
<div class="mb-6">
  <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-4">
    <div class="flex-1">
      <div class="flex items-center gap-3 mb-3">
        <span class="px-3 py-1 text-sm font-semibold text-gray-900 dark:text-white bg-primary/20 dark:bg-primary/30 rounded-lg">
          {{ workout.duration_minutes }}min
        </span>
        {% if workout.ride_detail and workout.ride_detail.workout_type %}
        <span class="px-3 py-1 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg">
          {{ workout.ride_detail.workout_type.name }}
        </span>
        {% elif workout.workout_type %}
        <span class="px-3 py-1 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg">
          {{ workout.workout_type.name }}
        </span>
        {% endif %}
      </div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">{{ workout.title }}</h1>
      {% if workout.instructor %}
        <p class="text-gray-600 dark:text-gray-400">{{ workout.instructor.name }}</p>
      {% endif %}
    </div>
    <div class="flex flex-wrap gap-2">
      {% if workout.peloton_url %}
        <a href="{{ workout.peloton_url }}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-dark rounded-lg transition-colors">
          View Workout ↗
        </a>
      {% endif %}
      {% if workout.ride_detail and workout.ride_detail.peloton_class_url %}
        <a href="{{ workout.ride_detail.peloton_class_url }}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors">
          View Class ↗
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Dates -->
  <div class="flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400">
    <div>
      <strong class="font-semibold">Recorded:</strong> {{ workout.recorded_date|date:"F d, Y" }}
    </div>
    <div>
      <strong class="font-semibold">Completed:</strong> {{ workout.completed_date|date:"F d, Y" }}
    </div>
  </div>
</div>

<!-- Metrics Section -->
{% if workout.details %}
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm mb-6">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Workout Metrics</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
      {% if workout.details.tss %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Training Stress Score</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">
            {% if workout.details.tss_target %}
              {{ workout.details.tss|floatformat:0 }}/{{ workout.details.tss_target|floatformat:0 }}
            {% else %}
              {{ workout.details.tss|floatformat:0 }}
            {% endif %}
          </div>
        </div>
      {% endif %}
      {% if workout.details.avg_output %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Average Output</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ workout.details.avg_output|floatformat:0 }}W</div>
        </div>
      {% endif %}
      {% if workout.details.total_output %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Total Output</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ workout.details.total_output|floatformat:0 }} kJ</div>
        </div>
      {% endif %}
      {% if workout.details.max_output %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Max Output</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ workout.details.max_output|floatformat:0 }}W</div>
        </div>
      {% endif %}
      {% if workout.details.avg_speed %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Average Speed</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ workout.details.avg_speed|floatformat:1 }} mph</div>
        </div>
      {% endif %}
      {% if workout.details.max_speed %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Max Speed</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ workout.details.max_speed|floatformat:1 }} mph</div>
        </div>
      {% endif %}
      {% if workout.details.distance %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Distance</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ workout.details.distance|floatformat:2 }} mi</div>
        </div>
      {% endif %}
      {% if workout.details.avg_heart_rate %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Avg Heart Rate</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ workout.details.avg_heart_rate }} bpm</div>
        </div>
      {% endif %}
      {% if workout.details.max_heart_rate %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Max Heart Rate</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ workout.details.max_heart_rate }} bpm</div>
        </div>
      {% endif %}
      {% if workout.details.total_calories %}
        <div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Calories</div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ workout.details.total_calories }}</div>
        </div>
      {% endif %}
    </div>
  </div>
{% endif %}

<!-- Performance Graph -->
{% if performance_data %}
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-3 sm:p-6 shadow-sm mb-6">
    {% if target_metrics and target_metrics.type == 'power_zone' %}
    <div class="mb-3 sm:mb-4">
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-2">
        <div>
          <h2 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-1">Power Zone Timeline</h2>
          <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">Coach cues mapped against your effort.</p>
        </div>
        {% if playlist and playlist.songs %}
        <label class="flex items-center gap-2 text-xs sm:text-sm text-gray-600 dark:text-gray-400 cursor-pointer">
          <input type="checkbox" id="showMusicTimeline" checked class="rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary bg-white dark:bg-gray-700">
          <span>Show Music Timeline</span>
        </label>
        {% endif %}
      </div>
    </div>
    <div class="pace-target-chart relative px-1 sm:px-3 pt-2 overflow-x-auto">
      {% if playlist and playlist.songs %}
      <!-- Music Timeline Overlay - Above Chart -->
      <div id="musicTimeline" class="mb-2 sm:mb-3 h-10 sm:h-12 relative bg-gray-800 dark:bg-gray-950 rounded border border-gray-700 dark:border-gray-600 overflow-hidden"></div>
      {% endif %}
      <div class="relative bg-gray-50 dark:bg-gray-900 rounded-lg min-h-[240px] sm:min-h-[320px] w-full">
        <canvas id="performanceChart"></canvas>
      </div>
      <div id="powerChartReadout" class="mt-2 px-1 sm:px-3 text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-400 opacity-85 break-words"></div>
      
      <!-- Chart Controls (only for power zone workouts) -->
      {% if target_metrics and target_metrics.type == 'power_zone' %}
      <div class="chart-controls mt-3 sm:mt-4">
        <button id="toggle-target-line" class="chart-control-btn text-xs sm:text-sm">Hide Target</button>
        <button id="save-chart" class="chart-control-btn text-xs sm:text-sm">
          <svg class="w-3 h-3 sm:w-4 sm:h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
          </svg>
          Save
        </button>
        <label class="chart-control-checkbox text-xs sm:text-sm">
          <input type="checkbox" id="toggle-zone-colors" checked class="w-3 h-3 sm:w-4 sm:h-4">
          <span>Zone Colors</span>
        </label>
      </div>
      {% endif %}
    </div>
    {% else %}
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Performance Graph</h2>
    <div class="relative bg-gray-50 dark:bg-gray-900 p-4 rounded-lg min-h-[400px]">
      <canvas id="performanceChart"></canvas>
    </div>
    {% endif %}
  </div>
  
  <!-- Power Profile and Zone Cards (only for power zone workouts) -->
  {% if target_metrics and target_metrics.type == 'power_zone' %}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Power Profile Card -->
    {% if power_profile %}
    <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 text-center">Power Profile</h3>
      <div class="grid grid-cols-2 gap-4">
        {% if power_profile.5_second %}
        <div class="text-center">
          <div class="bg-gradient-to-b from-purple-600 to-purple-400 rounded-lg p-4 mb-2">
            <div class="text-3xl font-bold text-white mb-1">5</div>
            <div class="text-xs font-semibold text-white uppercase">SECOND POWER</div>
          </div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ power_profile.5_second }} w</div>
        </div>
        {% endif %}
        {% if power_profile.1_minute %}
        <div class="text-center">
          <div class="bg-gradient-to-b from-purple-600 to-purple-400 rounded-lg p-4 mb-2">
            <div class="text-3xl font-bold text-white mb-1">1</div>
            <div class="text-xs font-semibold text-white uppercase">MINUTE POWER</div>
          </div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ power_profile.1_minute }} w</div>
        </div>
        {% endif %}
        {% if power_profile.5_minute %}
        <div class="text-center">
          <div class="bg-gradient-to-b from-purple-600 to-purple-400 rounded-lg p-4 mb-2">
            <div class="text-3xl font-bold text-white mb-1">5</div>
            <div class="text-xs font-semibold text-white uppercase">MINUTE POWER</div>
          </div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ power_profile.5_minute }} w</div>
        </div>
        {% endif %}
        {% if power_profile.20_minute %}
        <div class="text-center">
          <div class="bg-gradient-to-b from-purple-600 to-purple-400 rounded-lg p-4 mb-2">
            <div class="text-3xl font-bold text-white mb-1">20</div>
            <div class="text-xs font-semibold text-white uppercase">MINUTE POWER</div>
          </div>
          <div class="text-xl font-bold text-gray-900 dark:text-white">{{ power_profile.20_minute }} w</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    <!-- Main Set Zone Targets Card -->
    {% if zone_targets %}
    <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Main Set Zone Targets</h3>
      
      <!-- Overall Progress Bar -->
      <div class="mb-4">
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-8 relative overflow-hidden">
          <div class="bg-gradient-to-r from-orange-500 to-yellow-400 h-full rounded-full flex items-center justify-center transition-all duration-300" style="width: {{ zone_targets.overall_percentage }}%">
            <span class="text-white font-bold text-sm">{{ zone_targets.overall_percentage|floatformat:2 }}%</span>
          </div>
        </div>
      </div>
      
      <!-- Zone Details -->
      <div class="space-y-3">
        {% for zone_info in zone_targets.zones %}
        <div class="flex items-center gap-3">
          <div class="flex-1 min-w-0">
            <div class="text-sm font-medium text-gray-900 dark:text-white mb-1">{{ zone_info.name }}</div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 relative overflow-hidden">
              {% if zone_info.zone == 5 %}
                <div class="bg-orange-500 h-full rounded-full" style="width: {{ zone_info.percentage }}%"></div>
              {% elif zone_info.zone == 4 %}
                <div class="bg-yellow-400 h-full rounded-full" style="width: {{ zone_info.percentage }}%"></div>
              {% elif zone_info.zone == 3 %}
                <div class="bg-green-500 h-full rounded-full" style="width: {{ zone_info.percentage }}%"></div>
              {% elif zone_info.zone == 2 %}
                <div class="bg-teal-500 h-full rounded-full" style="width: {{ zone_info.percentage }}%"></div>
              {% elif zone_info.zone == 1 %}
                <div class="bg-purple-500 h-full rounded-full" style="width: {{ zone_info.percentage }}%"></div>
              {% elif zone_info.zone == 6 %}
                <div class="bg-red-500 h-full rounded-full" style="width: {{ zone_info.percentage }}%"></div>
              {% elif zone_info.zone == 7 %}
                <div class="bg-pink-500 h-full rounded-full" style="width: {{ zone_info.percentage }}%"></div>
              {% endif %}
            </div>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">
            {{ zone_info.target_time_str }} ({{ zone_info.percentage|floatformat:1 }}%)
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    
    <!-- Class Notes Card -->
    {% if class_notes %}
    <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Class Notes</h3>
      <ul class="space-y-2">
        {% for note in class_notes %}
        <li class="text-sm text-gray-900 dark:text-white">
          <span class="font-semibold">{{ note.zone_label }}</span> • 
          <span>{{ note.name }}</span> — 
          <span>{{ note.total_time_str }} total</span>
          {% if note.blocks > 1 %}
            <span>({{ note.blocks }} blocks)</span>
          {% else %}
            <span>({{ note.blocks }} block)</span>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm mb-6">
    <p class="text-gray-600 dark:text-gray-400">
      Performance data not available for this workout. Please sync your workouts to see performance graphs.
    </p>
  </div>
{% endif %}

<!-- Playlist Section -->
{% if playlist and playlist.songs %}
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm mb-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Class Playlist</h2>
        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          {{ playlist.song_count }} song{{ playlist.song_count|pluralize }}
        </div>
      </div>
    </div>
    
    <!-- Songs List -->
    <div class="space-y-2 max-h-96 overflow-y-auto">
      {% for song in playlist.songs %}
        <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors group">
          <!-- Song Number -->
          <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-sm font-semibold text-gray-600 dark:text-gray-400 bg-gray-200 dark:bg-gray-600 rounded-full">
            {{ song.index|add:1 }}
          </div>
          
          <!-- Album Art -->
          {% if song.album.image_url %}
            <img src="{{ song.album.image_url }}" alt="{{ song.album.name }}" class="w-12 h-12 rounded object-cover flex-shrink-0">
          {% else %}
            <div class="w-12 h-12 rounded bg-gray-300 dark:bg-gray-600 flex items-center justify-center flex-shrink-0">
              <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
              </svg>
            </div>
          {% endif %}
          
          <!-- Song Info -->
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-gray-900 dark:text-white truncate">{{ song.title }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 truncate">
              {% for artist in song.artists %}
                {% if not forloop.first %}, {% endif %}{{ artist.artist_name }}
              {% endfor %}
            </div>
            {% if song.album.name %}
              <div class="text-xs text-gray-500 dark:text-gray-500 truncate">{{ song.album.name }}</div>
            {% endif %}
          </div>
          
          <!-- Song Timing -->
          <div class="flex-shrink-0 text-sm text-gray-500 dark:text-gray-400 mr-2">
            {% if song.start_time_offset %}
              {{ song.start_time_offset|format_song_time }}
            {% endif %}
          </div>
          
          <!-- Spotify Link -->
          {% with spotify_url=song|spotify_search_url %}
            {% if spotify_url %}
              <a href="{{ spotify_url }}" target="_blank" rel="noopener noreferrer" 
                 class="flex-shrink-0 p-2 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors opacity-0 group-hover:opacity-100"
                 title="Open in Spotify">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.42 1.56-.299.421-1.02.599-1.559.3z"/>
                </svg>
              </a>
            {% endif %}
          {% endwith %}
          
          <!-- Explicit Badge -->
          {% if song.explicit_rating == 1 %}
            <div class="flex-shrink-0 px-2 py-1 text-xs font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded">
              E
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
    
    <!-- Top Artists -->
    {% if playlist.top_artists %}
      <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
        <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Top Artists</h4>
        <div class="flex flex-wrap gap-2">
          {% for artist in playlist.top_artists %}
            <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
              {% if artist.image_url %}
                <img src="{{ artist.image_url }}" alt="{{ artist.artist_name }}" class="w-8 h-8 rounded-full object-cover">
              {% endif %}
              <span class="text-sm text-gray-700 dark:text-gray-300">{{ artist.artist_name }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}

<!-- Description -->
{% if workout.description %}
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Description</h2>
    <p class="text-gray-600 dark:text-gray-400 leading-relaxed">{{ workout.description }}</p>
  </div>
{% endif %}

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

{% if performance_data %}
<!-- Performance Graph Script -->
<script>
  // Performance data from Django
  const performanceData = [
    {% for data in performance_data %}
    {
      timestamp: {{ data.timestamp }},
      output: {{ data.output|default:"null" }},
      speed: {{ data.speed|default:"null" }},
      heart_rate: {{ data.heart_rate|default:"null" }},
      power_zone: {{ data.power_zone|default:"null" }},
      intensity_zone: "{{ data.intensity_zone|default:"" }}",
      cadence: {{ data.cadence|default:"null" }},
      resistance: {{ data.resistance|default:"null" }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Target line data (for power zone classes)
  const targetLineData = {% if target_line_data %}{{ target_line_data }}{% else %}null{% endif %};
  
  const workoutType = "{% if workout.ride_detail and workout.ride_detail.workout_type %}{{ workout.ride_detail.workout_type.slug }}{% elif workout.workout_type %}{{ workout.workout_type.slug }}{% else %}other{% endif %}";
  // Check if this is a power zone class - check both target_metrics and ride_detail
  const isPowerZone = {% if target_metrics and target_metrics.type == 'power_zone' %}true{% elif workout.ride_detail and workout.ride_detail.is_power_zone_class %}true{% elif workout.ride_detail and workout.ride_detail.class_type == 'power_zone' %}true{% else %}false{% endif %};
  const workoutDuration = {{ workout.duration_minutes|default:30 }} * 60; // Convert to seconds
  const userFTP = {% if user_ftp %}{{ user_ftp }}{% else %}null{% endif %};
  // Get target metrics JSON (includes zone_ranges)
  const targetMetricsJson = {% if target_metrics_json %}{{ target_metrics_json|safe }}{% else %}null{% endif %};
  // Extract zone_ranges from target_metrics_json if available
  const zoneRanges = (targetMetricsJson && targetMetricsJson.zone_ranges) ? targetMetricsJson.zone_ranges : null;
  
  // Playlist data for music timeline
  const playlistData = {% if playlist and playlist.songs %}[
    {% for song in playlist.songs %}
    {
      title: "{{ song.title|escapejs }}",
      artists: [{% for artist in song.artists %}"{{ artist.artist_name|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
      start_time: {{ song.start_time_offset|default:0 }},
      duration: {{ song.duration|default:0 }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]{% else %}null{% endif %};
  
  // Calculate song durations if not provided (from next song's start time)
  if (playlistData && playlistData.length > 0) {
    for (let i = 0; i < playlistData.length; i++) {
      const song = playlistData[i];
      if (!song.duration || song.duration <= 0) {
        // Calculate duration from next song's start time
        if (i < playlistData.length - 1) {
          song.duration = playlistData[i + 1].start_time - song.start_time;
        } else {
          // Last song - use workout duration minus start time
          song.duration = Math.max(180, workoutDuration - song.start_time);
        }
      }
    }
  }
  
  // Debug logging
  console.log('Performance data count:', performanceData.length);
  console.log('Target line data:', targetLineData ? targetLineData.length : 'null');
  console.log('Is Power Zone:', isPowerZone);
  console.log('User FTP:', userFTP);
  console.log('Zone ranges:', zoneRanges);
  console.log('Target metrics:', {% if target_metrics_json %}{{ target_metrics_json|safe }}{% else %}null{% endif %});

  // Format time from seconds to MM:SS
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // Prepare chart data - use timestamps directly for x-axis (like reference)
  const timeSeconds = performanceData.map(d => d.timestamp);
  const labels = performanceData.map(d => formatTime(d.timestamp));
  const outputData = performanceData.map(d => d.output !== null && d.output !== undefined ? d.output : null);
  const speedData = performanceData.map(d => d.speed !== null && d.speed !== undefined ? d.speed : null);
  const heartRateData = performanceData.map(d => d.heart_rate !== null && d.heart_rate !== undefined ? d.heart_rate : null);
  
  // Helper function to convert watts to zone (1-7) based on FTP
  function wattsToZone(watts, ftp) {
    if (!watts || !ftp || watts <= 0 || ftp <= 0) return 1;
    const percentage = watts / ftp;
    if (percentage < 0.55) return 1;  // Zone 1: < 55% FTP
    if (percentage < 0.75) return 2;  // Zone 2: 55-75% FTP
    if (percentage < 0.90) return 3;  // Zone 3: 75-90% FTP
    if (percentage < 1.05) return 4;  // Zone 4: 90-105% FTP
    if (percentage < 1.20) return 5;  // Zone 5: 105-120% FTP
    if (percentage < 1.50) return 6;  // Zone 6: 120-150% FTP
    return 7;  // Zone 7: >= 150% FTP
  }
  
  // Calculate y-axis range for power zone charts (like reference)
  let ymin = 0;
  let ymax = null;
  if (isPowerZone && (workoutType === 'cycling' || workoutType === 'ride')) {
    const pool = [...outputData.filter(v => v !== null)];
    if (targetLineData && targetLineData.length > 0) {
      pool.push(...targetLineData.map(item => item.target_output).filter(v => v !== null));
    }
    if (pool.length > 0) {
      ymin = Math.min(...pool);
      ymax = Math.max(...pool);
      if (Math.abs(ymax - ymin) < 10) {
        ymax = ymin + 10;
      }
      // Add padding (6% like reference)
      const pad = Math.max((ymax - ymin) * 0.06, 10);
      ymin = Math.max(0, ymin - pad);
      ymax = ymax + pad;
    } else {
      ymax = 300;  // Default max
    }
  }
  
  // Debug: Check if we have any output data
  const hasOutputData = outputData.some(v => v !== null && v !== undefined);
  console.log('Has output data:', hasOutputData, 'Output data sample:', outputData.slice(0, 10));
  console.log('Y-axis range:', ymin, '-', ymax);

  // Power Zone colors matching reference implementation
  const POWER_ZONE_COLORS = {
    1: "#6f42c1",  // Purple - Z1 • Active Recovery
    2: "#17a2b8",  // Teal - Z2 • Endurance
    3: "#28a745",  // Green - Z3 • Tempo
    4: "#ffc107",  // Yellow - Z4 • Threshold
    5: "#fd7e14",  // Orange - Z5 • VO2 Max
    6: "#dc3545",  // Red - Z6 • Anaerobic
    7: "#6610f2"   // Dark Purple - Z7 • Neuromuscular
  };
  
  const POWER_ZONE_NAMES = {
    1: "Z1 • Active Recovery",
    2: "Z2 • Endurance",
    3: "Z3 • Tempo",
    4: "Z4 • Threshold",
    5: "Z5 • VO2 Max",
    6: "Z6 • Anaerobic",
    7: "Z7 • Neuromuscular"
  };

  // Determine chart type and data based on workout type
  let datasets = [];
  let yAxisLabel = '';
  let powerZoneBands = [];
  let showTargetLine = true;  // Track target line visibility

  // Build power zone bands for background (like reference implementation)
  // Build in order Zone 1 to Zone 7, but they'll be drawn reversed (Zone 7 on top)
  let showZoneColors = true;
  if (zoneRanges && userFTP && isPowerZone) {
    for (let zone = 1; zone <= 7; zone++) {
      const zoneKey = String(zone);
      if (zoneRanges[zoneKey]) {
        const range = zoneRanges[zoneKey];
        const lower = Array.isArray(range) ? range[0] : null;
        const upper = Array.isArray(range) ? range[1] : null;
        powerZoneBands.push({
          zone: zone,
          label: POWER_ZONE_NAMES[zone] || `Zone ${zone}`,
          color: POWER_ZONE_COLORS[zone] || '#888',
          lower: lower !== null && lower !== undefined ? lower : null,
          upper: upper !== null && upper !== undefined ? upper : null
        });
      }
    }
  }

  if (workoutType === 'cycling' || workoutType === 'ride') {
    if (isPowerZone && userFTP) {
      // For power zone charts, use zones (1-7) on Y-axis instead of watts
      yAxisLabel = 'Zone';
      
      // Convert actual output (watts) to zones with correct boundaries
      // Map to decimal zones (1.0-7.0) for smooth curves, using proper zone boundaries
      let actualZoneData = outputData.map(watts => {
        if (watts === null || watts === undefined) return null;
        const percentage = watts / userFTP;
        // Use correct zone boundaries and map to decimal zones for smooth interpolation
        // Zone 1: 0-55% FTP -> 1.0 to 1.5
        if (percentage < 0.55) {
          return 1.0 + (percentage / 0.55) * 0.5;
        }
        // Zone 2: 55-75% FTP -> 1.5 to 2.5
        if (percentage < 0.75) {
          return 1.5 + ((percentage - 0.55) / 0.20) * 1.0;
        }
        // Zone 3: 75-90% FTP -> 2.5 to 3.5
        if (percentage < 0.90) {
          return 2.5 + ((percentage - 0.75) / 0.15) * 1.0;
        }
        // Zone 4: 90-105% FTP -> 3.5 to 4.5
        if (percentage < 1.05) {
          return 3.5 + ((percentage - 0.90) / 0.15) * 1.0;
        }
        // Zone 5: 105-120% FTP -> 4.5 to 5.5
        if (percentage < 1.20) {
          return 4.5 + ((percentage - 1.05) / 0.15) * 1.0;
        }
        // Zone 6: 120-150% FTP -> 5.5 to 6.5
        if (percentage < 1.50) {
          return 5.5 + ((percentage - 1.20) / 0.30) * 1.0;
        }
        // Zone 7: >=150% FTP -> 6.5 to 7.0
        return 6.5 + Math.min((percentage - 1.50) / 0.50, 1.0) * 0.5;
      });
      
      // Apply light smoothing to actual data to reduce noise while maintaining flow
      // Use a smaller window and weighted average to preserve the flowing nature
      if (targetLineData && targetLineData.length > 0) {
        const smoothedZoneData = [];
        const windowSize = 3; // Smaller window to preserve variations
        for (let i = 0; i < actualZoneData.length; i++) {
          if (actualZoneData[i] === null) {
            smoothedZoneData.push(null);
            continue;
          }
          
          // Weighted moving average (center point has more weight)
          let sum = 0;
          let weightSum = 0;
          for (let j = Math.max(0, i - Math.floor(windowSize / 2)); j <= Math.min(actualZoneData.length - 1, i + Math.floor(windowSize / 2)); j++) {
            if (actualZoneData[j] !== null) {
              const distance = Math.abs(j - i);
              const weight = distance === 0 ? 2.0 : (distance === 1 ? 1.0 : 0.5); // Center point weighted more
              sum += actualZoneData[j] * weight;
              weightSum += weight;
            }
          }
          
          if (weightSum > 0) {
            smoothedZoneData.push(sum / weightSum);
          } else {
            smoothedZoneData.push(actualZoneData[i]);
          }
        }
        actualZoneData = smoothedZoneData;
      }
      
      // Actual performance line (yellow like reference) - flowing and smooth with curves
      datasets.push({
        label: 'Actual',
        data: actualZoneData.map((zone, index) => ({ x: timeSeconds[index], y: zone })),
        borderColor: '#fbbf24',  // Yellow like reference
        backgroundColor: 'rgba(251, 191, 36, 0.1)',
        borderWidth: 2.8,
        fill: false,
        tension: 1.0,  // Maximum smoothness for very flowing, curved lines
        stepped: false,  // Explicitly disable stepped lines
        pointRadius: 0,
        pointHoverRadius: 4,
        spanGaps: false  // Don't span gaps to show actual data variations
      });
      
      // Target output line (light blue, stepped) for power zone classes
      if (targetLineData && targetLineData.length > 0) {
        // Convert target output (watts) to zones using the same decimal conversion as actual
        const targetZoneData = [];
        for (let i = 0; i < performanceData.length; i++) {
          if (i < targetLineData.length && targetLineData[i].target_output) {
            const targetWatts = targetLineData[i].target_output;
            const percentage = targetWatts / userFTP;
            // Use the same decimal zone mapping as actual for consistency
            let targetZone;
            if (percentage < 0.55) {
              targetZone = 1.0 + (percentage / 0.55) * 0.5;
            } else if (percentage < 0.75) {
              targetZone = 1.5 + ((percentage - 0.55) / 0.20) * 1.0;
            } else if (percentage < 0.90) {
              targetZone = 2.5 + ((percentage - 0.75) / 0.15) * 1.0;
            } else if (percentage < 1.05) {
              targetZone = 3.5 + ((percentage - 0.90) / 0.15) * 1.0;
            } else if (percentage < 1.20) {
              targetZone = 4.5 + ((percentage - 1.05) / 0.15) * 1.0;
            } else if (percentage < 1.50) {
              targetZone = 5.5 + ((percentage - 1.20) / 0.30) * 1.0;
            } else {
              targetZone = 6.5 + Math.min((percentage - 1.50) / 0.50, 1.0) * 0.5;
            }
            targetZoneData.push({ x: timeSeconds[i], y: targetZone });
          } else {
            targetZoneData.push({ x: timeSeconds[i], y: null });
          }
        }
        
        datasets.push({
          label: 'Target',
          data: targetZoneData,
          borderColor: '#93c5fd',  // Light blue like reference
          backgroundColor: 'rgba(147, 197, 253, 0.1)',
          borderWidth: 2.8,
          fill: false,
          tension: 0,  // Stepped line (no smoothing)
          stepped: 'before',  // Stepped line
          pointRadius: 0,
          pointHoverRadius: 4,
          spanGaps: true,
          hidden: !showTargetLine
        });
      }
    } else {
      // Non-power zone cycling charts - use watts
      yAxisLabel = 'Output (Watts)';
      
      datasets.push({
        label: 'Actual',
        data: outputData,
        borderColor: '#5b7cfa',
        backgroundColor: 'rgba(91, 124, 250, 0.1)',
        borderWidth: 2.8,
        fill: false,
        cubicInterpolationMode: 'monotone',
        pointRadius: 0,
        pointHoverRadius: 4,
        spanGaps: true
      });
    }
  } else if (workoutType === 'running' || workoutType === 'run') {
    yAxisLabel = 'Speed (mph)';
    datasets = [
      {
        label: 'Speed',
        data: speedData,
        borderColor: 'rgb(234, 179, 8)',
        backgroundColor: 'rgba(234, 179, 8, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.1,
        pointRadius: 0,
        pointHoverRadius: 4,
        spanGaps: true
      }
    ];
  } else {
    yAxisLabel = 'Heart Rate (bpm)';
    datasets = [
      {
        label: 'Heart Rate',
        data: heartRateData,
        borderColor: 'rgb(34, 197, 94)',
        backgroundColor: 'rgba(34, 197, 94, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.1,
        pointRadius: 0,
        pointHoverRadius: 4,
        spanGaps: true
      }
    ];
  }

  // Zone bands plugin (like reference implementation) - can be toggled on/off
  const zoneBandsPlugin = {
    id: 'zoneBands',
    beforeDatasetsDraw(chart, args, opts) {
      if (!showZoneColors) return;
      const {ctx, chartArea, scales} = chart;
      ctx.save();
      
      if (isPowerZone && userFTP) {
        // For power zone charts with zone-based Y-axis, draw bands by zone number (1-7)
        // Draw bands across the full range from 0.5 to 7.5
        for (let zone = 1; zone <= 7; zone++) {
          const zoneColor = POWER_ZONE_COLORS[zone] || '#888';
          // Each zone spans from (zone - 0.5) to (zone + 0.5)
          const yTop = scales.y.getPixelForValue(zone - 0.5);
          const yBot = scales.y.getPixelForValue(zone + 0.5);
          ctx.fillStyle = zoneColor;
          ctx.globalAlpha = 0.18;  // Match reference opacity
          ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBot - yTop);
        }
      } else {
        // For watt-based charts, use the bands from opts
        const bands = opts?.bands || [];
        [...bands].reverse().forEach(b => {
          if (b.lower == null && b.upper == null) return;
          const yTop = scales.y.getPixelForValue(b.upper ?? scales.y.max);
          const yBot = scales.y.getPixelForValue(b.lower ?? scales.y.min);
          ctx.fillStyle = b.color;
          ctx.globalAlpha = 0.18;
          ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBot - yTop);
        });
      }
      ctx.restore();
    },
    afterDraw(chart, args, opts) {
      // Overlay zone labels on the chart (on the left side of the chart area)
      if (isPowerZone && userFTP) {
        const {ctx, chartArea, scales} = chart;
        ctx.save();
        ctx.font = '12px sans-serif';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        
        // Draw zone labels (ZONE 1 through ZONE 7) overlaid on the chart
        for (let zone = 1; zone <= 7; zone++) {
          const yPos = scales.y.getPixelForValue(zone);
          // Position labels on the left side of the chart area
          ctx.fillText(`ZONE ${zone}`, chartArea.left + 8, yPos);
        }
        ctx.restore();
      }
    }
  };
  
  // External tooltip/readout handler - now using built-in tooltip instead
  // Keep readout for backward compatibility but tooltip will handle display
  const readout = document.getElementById('powerChartReadout');
  
  // Legend removed - users can see output values on hover via tooltip

  // Initialize chart when DOM is ready
  function initChart() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
      console.error('Chart.js library not loaded');
      return;
    }
    
    // Create chart
    const ctx = document.getElementById('performanceChart');
    if (!ctx) {
      console.error('Performance chart canvas not found');
      return;
    }
    
    // Check if we have data
    if (performanceData.length === 0) {
      console.error('No performance data available');
      return;
    }
    
    // Create chart configuration matching reference exactly
    // For power zone charts, use time_seconds array as labels with linear scale
    const chartConfig = {
    type: 'line',
    data: {
      labels: isPowerZone && userFTP ? [] : (isPowerZone ? timeSeconds : labels),  // Empty labels for power zone when using x/y data points
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,  // Disable animation like reference
      interaction: {
        intersect: false,
        mode: 'index'
      },
      elements: {
        line: {
          tension: 1.0  // Maximum smoothness at element level
        }
      },
      plugins: {
        legend: {
          display: false  // Hide legend (we show custom legend below)
        },
        tooltip: {
          enabled: true,  // Enable tooltip for all charts
          mode: 'index',
          intersect: false,
          callbacks: {
            title: function(context) {
              if (context.length > 0 && context[0].parsed) {
                const timestamp = isPowerZone ? context[0].parsed.x : performanceData[context[0].dataIndex]?.timestamp || 0;
                return formatTime(timestamp);
              }
              return '';
            },
            label: function(context) {
              if (isPowerZone && userFTP) {
                const datasetLabel = context.dataset.label;
                const zoneValue = context.parsed.y;
                const dataIndex = context.dataIndex;
                
                if (datasetLabel === 'Actual') {
                  const watts = outputData[dataIndex];
                  if (watts !== null && watts !== undefined) {
                    const zone = Math.round(zoneValue);
                    return `Actual: ${Math.round(watts)} watts (Zone ${zone})`;
                  }
                } else if (datasetLabel === 'Target') {
                  if (targetLineData && dataIndex < targetLineData.length && targetLineData[dataIndex].target_output) {
                    const targetWatts = targetLineData[dataIndex].target_output;
                    const zone = Math.round(zoneValue);
                    return `Target: ${Math.round(targetWatts)} watts (Zone ${zone})`;
                  }
                }
              }
              return context.dataset.label + ': ' + context.parsed.y;
            }
          },
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: 'rgba(255, 255, 255, 0.9)',
          bodyColor: 'rgba(255, 255, 255, 0.9)',
          borderColor: 'rgba(255, 255, 255, 0.2)',
          borderWidth: 1,
          padding: 12
        },
        zoneBands: (isPowerZone && userFTP) ? { bands: [] } : (powerZoneBands.length > 0 ? { bands: powerZoneBands } : undefined)
      },
      scales: {
        x: {
          type: isPowerZone ? 'linear' : 'category',  // Linear scale for power zone (time-based)
          min: isPowerZone ? 0 : undefined,
          max: isPowerZone && timeSeconds.length > 0 ? timeSeconds[timeSeconds.length - 1] : undefined,
          grid: {
            color: 'rgba(255,255,255,0.06)'  // Match reference
          },
          ticks: {
            autoSkip: true,
            maxTicksLimit: 9,
            callback: function(value, index) {
              if (isPowerZone) {
                // For linear scale, value is the timestamp
                return formatTime(value);
              } else {
                // For category scale, use index
                if (index >= 0 && index < performanceData.length) {
                  return formatTime(performanceData[index].timestamp);
                }
                return formatTime(value);
              }
            },
            color: 'rgba(255,255,255,0.7)'
          }
        },
        y: {
          min: isPowerZone ? 0.5 : ((ymax) ? ymin : 0),
          max: isPowerZone ? 7.5 : ((ymax) ? ymax : undefined),
          title: {
            display: false,  // Hide y-axis title
            text: yAxisLabel.toLowerCase(),
            color: 'rgba(255,255,255,0.7)'
          },
          grid: {
            color: 'rgba(255,255,255,0.1)',
            drawOnChartArea: true,
            drawTicks: false
          },
          ticks: {
            stepSize: isPowerZone ? 1 : undefined,
            maxTicksLimit: isPowerZone ? 8 : undefined,
            display: false,  // Hide ticks on left - we'll overlay zone labels on chart
            callback: function(value) {
              if (isPowerZone) {
                const zone = Math.round(value);
                // Show labels for all zones (1-7)
                if (zone >= 1 && zone <= 7) {
                  return `ZONE ${zone}`;
                }
                return '';
              } else {
                return value.toFixed(0);
              }
            },
            color: 'rgba(255,255,255,0.7)'
          }
        }
      }
    },
    plugins: (isPowerZone && userFTP) ? [zoneBandsPlugin] : (powerZoneBands.length > 0 ? [zoneBandsPlugin] : [])
  };
  
    const chart = new Chart(ctx, chartConfig);
    
    // Chart control handlers
    const toggleTargetLineBtn = document.getElementById('toggle-target-line');
    const toggleZoneColorsCheckbox = document.getElementById('toggle-zone-colors');
    const saveChartBtn = document.getElementById('save-chart');
    
    // Toggle target line visibility
    if (toggleTargetLineBtn && isPowerZone) {
        toggleTargetLineBtn.addEventListener('click', function() {
            showTargetLine = !showTargetLine;
            const targetDataset = chart.data.datasets.find(d => d.label === 'Target');
            if (targetDataset) {
                targetDataset.hidden = !showTargetLine;
                chart.update('none');
                this.textContent = showTargetLine ? 'Hide Target' : 'Show Target';
            }
        });
    }
    
    // Toggle zone colors visibility
    if (toggleZoneColorsCheckbox && isPowerZone) {
        toggleZoneColorsCheckbox.addEventListener('change', function() {
            showZoneColors = this.checked;
            chart.update('none');
        });
    }
    
    // Save chart functionality
    if (saveChartBtn) {
        saveChartBtn.addEventListener('click', function() {
            // Convert chart to image and download
            const url = chart.toBase64Image();
            const link = document.createElement('a');
            link.download = 'power-zone-chart.png';
            link.href = url;
            link.click();
        });
    }
    
    // Music timeline overlay
    if (playlistData && playlistData.length > 0 && isPowerZone) {
      const musicTimelineEl = document.getElementById('musicTimeline');
      const showMusicCheckbox = document.getElementById('showMusicTimeline');
      
      function renderMusicTimeline() {
        if (!musicTimelineEl || !showMusicCheckbox) return;
        
        if (!showMusicCheckbox.checked) {
          musicTimelineEl.classList.add('hidden');
          return;
        }
        
        musicTimelineEl.classList.remove('hidden');
        musicTimelineEl.innerHTML = '';
        
        // Get max time from chart or workout duration
        const maxTime = timeSeconds.length > 0 ? timeSeconds[timeSeconds.length - 1] : workoutDuration;
        const timelineWidth = musicTimelineEl.offsetWidth || 800;
        
        // Color palette for different songs (like reference)
        const songColors = [
          'rgba(91, 124, 250, 0.4)',   // Blue
          'rgba(34, 197, 94, 0.4)',    // Green
          'rgba(234, 179, 8, 0.4)',    // Yellow
          'rgba(239, 68, 68, 0.4)',    // Red
          'rgba(168, 85, 247, 0.4)',   // Purple
          'rgba(236, 72, 153, 0.4)',   // Pink
          'rgba(20, 184, 166, 0.4)',   // Teal
          'rgba(251, 146, 60, 0.4)',   // Orange
        ];
        
        playlistData.forEach((song, idx) => {
          const startTime = song.start_time || 0;
          const duration = song.duration || 180;
          
          // Calculate percentages based on max time (align with chart's time axis)
          const startPercent = maxTime > 0 ? (startTime / maxTime) * 100 : 0;
          const widthPercent = maxTime > 0 ? (duration / maxTime) * 100 : 0;
          
          // Ensure we don't go beyond 100%
          const actualStartPercent = Math.max(0, Math.min(startPercent, 100));
          const actualWidthPercent = Math.max(0, Math.min(widthPercent, 100 - actualStartPercent));
          
          // Skip if segment is too small or outside bounds
          if (actualWidthPercent < 0.5 || actualStartPercent >= 100) {
            return;
          }
          
          const segment = document.createElement('div');
          const color = songColors[idx % songColors.length];
          const artistName = song.artists && song.artists.length > 0 ? song.artists[0] : '';
          
          segment.style.cssText = `
            position: absolute;
            left: ${actualStartPercent}%;
            width: ${actualWidthPercent}%;
            height: 100%;
            background: ${color};
            border-right: 1px solid rgba(255,255,255,0.25);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding: 2px 6px;
            font-size: 10px;
            line-height: 1.2;
            color: rgba(255,255,255,0.95);
            overflow: hidden;
            cursor: pointer;
            transition: opacity 0.2s, background 0.2s;
            min-width: 60px;
          `;
          
          segment.onmouseenter = () => {
            segment.style.opacity = '0.85';
            segment.style.background = color.replace('0.4', '0.6');
          };
          segment.onmouseleave = () => {
            segment.style.opacity = '1';
            segment.style.background = color;
          };
          
          // Create title element (truncate if too long)
          const titleEl = document.createElement('div');
          titleEl.style.cssText = 'font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; font-size: 10px;';
          titleEl.textContent = song.title || 'Unknown';
          
          // Create artist element (only if there's space)
          if (artistName && actualWidthPercent > 5) {
            const artistEl = document.createElement('div');
            artistEl.style.cssText = 'font-size: 9px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; margin-top: 1px;';
            artistEl.textContent = artistName;
            segment.appendChild(artistEl);
          }
          
          segment.insertBefore(titleEl, segment.firstChild);
          
          // Tooltip with full info
          const fullInfo = `${song.title}${artistName ? ' • ' + artistName : ''}`;
          segment.title = fullInfo;
          
          musicTimelineEl.appendChild(segment);
        });
      }
      
      if (showMusicCheckbox) {
        showMusicCheckbox.addEventListener('change', renderMusicTimeline);
        // Initial render after a short delay to ensure chart is rendered
        setTimeout(renderMusicTimeline, 200);
      }
    }
    
    console.log('Chart initialized successfully');
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChart);
  } else {
    initChart();
  }
</script>

<style>
/* Chart Controls */
.chart-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
  justify-content: center;
  margin-top: 1rem;
  padding: 0.5rem 0;
}

@media (min-width: 640px) {
  .chart-controls {
    gap: 0.75rem;
    justify-content: flex-end;
  }
}

.chart-control-btn {
  padding: 0.375rem 0.75rem;
  background: rgb(55 65 81); /* dark:bg-gray-700 */
  color: white;
  border: 1px solid rgb(75 85 99); /* dark:border-gray-600 */
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

@media (min-width: 640px) {
  .chart-control-btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }
}

.chart-control-btn:hover {
  background: rgb(75 85 99); /* dark:hover:bg-gray-600 */
  border-color: rgb(107 114 128); /* dark:hover:border-gray-500 */
}

@media (prefers-color-scheme: light) {
  .chart-control-btn {
    background: rgb(229 231 235); /* bg-gray-200 */
    color: rgb(17 24 39); /* text-gray-900 */
    border-color: rgb(209 213 219); /* border-gray-300 */
  }
  
  .chart-control-btn:hover {
    background: rgb(209 213 219); /* hover:bg-gray-300 */
    border-color: rgb(156 163 175); /* hover:border-gray-400 */
  }
}

.dark .chart-control-btn {
  background: rgb(55 65 81); /* dark:bg-gray-700 */
  color: white;
  border-color: rgb(75 85 99); /* dark:border-gray-600 */
}

.dark .chart-control-btn:hover {
  background: rgb(75 85 99); /* dark:hover:bg-gray-600 */
  border-color: rgb(107 114 128); /* dark:hover:border-gray-500 */
}

.chart-control-checkbox {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.375rem 0.75rem;
  background: rgb(55 65 81); /* dark:bg-gray-700 */
}

@media (min-width: 640px) {
  .chart-control-checkbox {
    gap: 0.5rem;
    padding: 0.5rem 1rem;
  }
}
  border: 1px solid rgb(75 85 99); /* dark:border-gray-600 */
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 500;
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
}

.chart-control-checkbox:hover {
  background: rgb(75 85 99); /* dark:hover:bg-gray-600 */
  border-color: rgb(107 114 128); /* dark:hover:border-gray-500 */
}

.chart-control-checkbox input[type="checkbox"] {
  width: 16px;
  height: 16px;
  cursor: pointer;
  accent-color: rgb(59 130 246); /* accent-blue-500 */
}

@media (min-width: 640px) {
  .chart-control-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
  }
}

@media (prefers-color-scheme: light) {
  .chart-control-checkbox {
    background: rgb(229 231 235); /* bg-gray-200 */
    color: rgb(17 24 39); /* text-gray-900 */
    border-color: rgb(209 213 219); /* border-gray-300 */
  }
  
  .chart-control-checkbox:hover {
    background: rgb(209 213 219); /* hover:bg-gray-300 */
    border-color: rgb(156 163 175); /* hover:border-gray-400 */
  }
}

.dark .chart-control-checkbox {
  background: rgb(55 65 81); /* dark:bg-gray-700 */
  color: white;
  border-color: rgb(75 85 99); /* dark:border-gray-600 */
}

.dark .chart-control-checkbox:hover {
  background: rgb(75 85 99); /* dark:hover:bg-gray-600 */
  border-color: rgb(107 114 128); /* dark:hover:border-gray-500 */
}
</style>
{% endif %}
{% endblock %}
