<!doctype html>
<html
  lang="en"
  class="overflow-x-hidden"
  x-data="{
    sidebarOpen: false,
    sidebarCollapsed: $persist(false).as('ctz_sidebar_collapsed'),
    darkMode: $persist(true).as('ctz_dark'),

    init() {
      document.documentElement.classList.toggle('dark', this.darkMode);

      // Close mobile sidebar when entering lg+
      const mq = window.matchMedia('(min-width: 1024px)');
      const onChange = () => { if (mq.matches) this.sidebarOpen = false; };
      mq.addEventListener?.('change', onChange);
      onChange();

      // ESC closes mobile sidebar
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') this.sidebarOpen = false;
      });
    },

    toggleDark() {
      this.darkMode = !this.darkMode;
      document.documentElement.classList.toggle('dark', this.darkMode);
    },

    toggleSidebar() { this.sidebarOpen = !this.sidebarOpen; },
    toggleCollapse() { this.sidebarCollapsed = !this.sidebarCollapsed; }
  }"
>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Chase The Zones - {% block title %}Fitness & Health is a Mentality{% endblock %}</title>
  {% load static %}

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{% static 'img/fav.png' %}" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="{% static 'site.webmanifest' %}" />

  <!-- Theme Color -->
  <meta name="theme-color" content="#465fff" />
  <meta name="msapplication-TileColor" content="#465fff" />

  <!-- iOS App Icons -->
  <link rel="apple-touch-icon" sizes="20x20" href="{% static 'img/icons/ios/AppIcon-20@2x.png' %}" />
  <link rel="apple-touch-icon" sizes="20x20" href="{% static 'img/icons/ios/AppIcon-20@3x.png' %}" />
  <link rel="apple-touch-icon" sizes="29x29" href="{% static 'img/icons/ios/AppIcon-29@2x.png' %}" />
  <link rel="apple-touch-icon" sizes="29x29" href="{% static 'img/icons/ios/AppIcon-29@3x.png' %}" />
  <link rel="apple-touch-icon" sizes="40x40" href="{% static 'img/icons/ios/AppIcon-40@2x.png' %}" />
  <link rel="apple-touch-icon" sizes="40x40" href="{% static 'img/icons/ios/AppIcon-40@3x.png' %}" />
  <link rel="apple-touch-icon" sizes="60x60" href="{% static 'img/icons/ios/AppIcon-60@2x.png' %}" />
  <link rel="apple-touch-icon" sizes="60x60" href="{% static 'img/icons/ios/AppIcon-60@3x.png' %}" />
  <link rel="apple-touch-icon" sizes="1024x1024" href="{% static 'img/icons/ios/AppIcon-1024.png' %}" />

  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Chase The Zones" />

  <!-- PWA Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'img/icons/pwa/pwa-192.png' %}" />
  <link rel="icon" type="image/png" sizes="256x256" href="{% static 'img/icons/pwa/pwa-256.png' %}" />
  <link rel="icon" type="image/png" sizes="384x384" href="{% static 'img/icons/pwa/pwa-384.png' %}" />
  <link rel="icon" type="image/png" sizes="512x512" href="{% static 'img/icons/pwa/pwa-512.png' %}" />

  <!-- Android Icons -->
  <link rel="icon" type="image/png" sizes="48x48" href="{% static 'img/icons/android/mipmap-mdpi.png' %}" />
  <link rel="icon" type="image/png" sizes="72x72" href="{% static 'img/icons/android/mipmap-hdpi.png' %}" />
  <link rel="icon" type="image/png" sizes="96x96" href="{% static 'img/icons/android/mipmap-xhdpi.png' %}" />
  <link rel="icon" type="image/png" sizes="144x144" href="{% static 'img/icons/android/mipmap-xxhdpi.png' %}" />
  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'img/icons/android/mipmap-xxxhdpi.png' %}" />

  <!-- Apply dark mode immediately to prevent flash -->
  <script src="{% static 'js/dark-mode-init.js' %}"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="{% static 'js/tailwind-config.js' %}"></script>

  <!-- TailAdmin Theme CSS -->
  <link rel="stylesheet" href="{% static 'css/tailadmin.css' %}" />

  <!-- Base CSS -->
  <link rel="stylesheet" href="{% static 'css/base.css' %}" />

  <!-- Alpine plugins (before Alpine) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>

  <!-- Alpine -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x/dist/cdn.min.js"></script>

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>
  <script src="{% static 'js/htmx-config.js' %}"></script>

  <!-- Alpine Components -->
  <script src="{% static 'js/alpine-components.js' %}"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="{% static 'js/chartjs-init.js' %}"></script>

  <!-- Video modal -->
  <script src="{% static 'js/video-modal.js' %}"></script>

  <!-- Mobile navbar scroll -->
  <script src="{% static 'js/navbar-scroll.js' %}"></script>

  <style>
    [x-cloak]{ display:none !important; }

    /* nicer scrollbars (subtle) */
    .ctz-scroll::-webkit-scrollbar{ width:10px; height:10px; }
    .ctz-scroll::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.45); border-radius: 999px; border: 3px solid transparent; background-clip: content-box; }
    .dark .ctz-scroll::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.28); border: 3px solid transparent; background-clip: content-box; }
  </style>
</head>

<body class="font-outfit bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 overflow-x-hidden">

  <!-- Development Mode Banner -->
  <div
    x-data="{
      dismissed: false,
      init() {
        if (typeof Storage !== 'undefined') {
          const sessionDismissed = sessionStorage.getItem('devBannerDismissed') === 'true';

          const cachedDismissal = localStorage.getItem('devBannerDismissedTimestamp');
          if (cachedDismissal) {
            const dismissalTime = parseInt(cachedDismissal);
            const now = Date.now();
            const cacheDuration = 24 * 60 * 60 * 1000;
            if (now - dismissalTime < cacheDuration) { this.dismissed = true; return; }
            localStorage.removeItem('devBannerDismissedTimestamp');
          }

          if (sessionDismissed) this.dismissed = true;
        }
      },
      dismiss() {
        this.dismissed = true;
        if (typeof Storage !== 'undefined') {
          sessionStorage.setItem('devBannerDismissed', 'true');
          localStorage.setItem('devBannerDismissedTimestamp', Date.now().toString());
        }
      }
    }"
    x-show="!dismissed"
    x-cloak
    class="bg-yellow-500 dark:bg-yellow-600 border-b border-yellow-600 dark:border-yellow-700 text-white px-4 py-2.5 text-sm font-medium relative z-[60]"
  >
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-3 flex-1">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <span class="flex-1">
          <strong>Development Mode:</strong> This application is currently in development and has not been released yet. Features may change, and data may be reset.
        </span>
      </div>
      <button @click="dismiss()" class="flex-shrink-0 p-1 rounded hover:bg-yellow-600 dark:hover:bg-yellow-700 transition-colors" aria-label="Dismiss banner">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>

  {% if user.is_authenticated %}

    {% if request.resolver_match.url_name == 'landing' or request.path == '/' %}
      <!-- Authenticated Landing (no sidebar) -->
      <div class="flex flex-col min-h-screen">
        <nav class="bg-white/85 dark:bg-gray-950/60 backdrop-blur-xl border-b border-gray-200/70 dark:border-gray-800/70 md:sticky top-0 z-50">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
              <div class="flex items-center min-w-0">
                <a href="{% url 'core:dashboard' %}" class="flex items-center group transition-opacity hover:opacity-90">
                  <img src="{% static 'img/logo.png' %}" alt="Chase The Zones" class="h-10 w-auto transition-transform group-hover:scale-[1.03]">
                </a>

                <div class="hidden md:flex ml-10 space-x-1">
                  <a href="{% url 'core:landing' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition
                    {% if request.resolver_match.url_name == 'landing' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                      text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
                    {% endif %}">Home</a>

                  <a href="{% url 'plans:exercise_list' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">Exercises</a>
                  <a href="{% url 'tracker:weekly_plans' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">My Plans</a>
                  <a href="{% url 'workouts:history' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">Workouts</a>
                  <a href="{% url 'recommender:index' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">Recommender</a>
                  <a href="{% url 'annual_challenge:index' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">Annual Challenge</a>
                </div>
              </div>

              <div class="flex items-center space-x-2">
                <button @click="sidebarOpen = !sidebarOpen" class="md:hidden p-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10 transition">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                  </svg>
                </button>

                <button @click="toggleDark()" class="p-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10 transition" title="Toggle dark mode">
                  <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                  </svg>
                  <svg x-show="darkMode" x-cloak class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                  </svg>
                </button>

                <!-- User menu -->
                <div x-data="{ open: false }" class="relative">
                  <button @click="open=!open" class="flex items-center space-x-2 p-1.5 rounded-xl hover:bg-gray-100 dark:hover:bg-white/10 transition">
                    <div class="w-9 h-9 rounded-full bg-primary text-white grid place-items-center font-semibold text-sm shadow-sm">
                      {% if user.profile.full_name %}
                        {% with name=user.profile.full_name %}
                          {{ name|first|upper }}{% if " " in name %}{{ name|slice:"-1:"|first|upper }}{% endif %}
                        {% endwith %}
                      {% else %}
                        {{ user.email|slice:":2"|upper }}
                      {% endif %}
                    </div>
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400 hidden md:block transition-transform" :class="open ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>

                  <div x-show="open" @click.away="open=false" x-cloak class="absolute right-0 mt-2 w-52 bg-white dark:bg-gray-900 rounded-2xl shadow-xl border border-gray-200/70 dark:border-gray-800/70 overflow-hidden z-50">
                    <a href="{% url 'profile' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10">
                      <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                      </svg>
                      Profile
                    </a>
                    <a href="{% url 'core:dashboard' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10">
                      <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"></path>
                      </svg>
                      Dashboard
                    </a>
                    <div class="border-t border-gray-200/70 dark:border-gray-800/70"></div>
                    <form method="post" action="{% url 'account_logout' %}" class="m-0">
                      {% csrf_token %}
                      <button type="submit" class="w-full flex items-center px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-white/10">
                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        Log out
                      </button>
                    </form>
                  </div>
                </div>

              </div>
            </div>

            <!-- Mobile landing menu -->
            <div x-show="sidebarOpen" @click.away="sidebarOpen=false" x-cloak class="md:hidden border-t border-gray-200/70 dark:border-gray-800/70 py-3 bg-gray-50/60 dark:bg-gray-950/40 backdrop-blur">
              <div class="space-y-1 px-2">
                <a href="{% url 'core:landing' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition
                  {% if request.resolver_match.url_name == 'landing' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                    text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
                  {% endif %}">Home</a>
                <a href="{% url 'plans:exercise_list' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">Exercises</a>
                <a href="{% url 'tracker:weekly_plans' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">My Plans</a>
                <a href="{% url 'workouts:history' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">Workouts</a>
                <a href="{% url 'recommender:index' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">Recommender</a>
                <a href="{% url 'annual_challenge:index' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">Annual Challenge</a>
                <a href="{% url 'core:dashboard' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10">Dashboard</a>
              </div>
            </div>
          </div>
        </nav>

        <main class="flex-1">
          {% if messages %}
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
              {% for message in messages %}
                <div class="mb-2 p-4 rounded-2xl border
                  {% if message.tags == 'error' %}bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800 text-red-800 dark:text-red-200
                  {% elif message.tags == 'success' %}bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800 text-green-800 dark:text-green-200
                  {% elif message.tags == 'warning' %}bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200
                  {% else %}bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200{% endif %}">
                  {{ message }}
                </div>
              {% endfor %}
            </div>
          {% endif %}

      </main>
      {% include 'partials/footer.html' %}
    </div>

    {% else %}
      <!-- Authenticated App Shell (sidebar + topbar) -->
      <div class="flex min-h-screen bg-gray-50 dark:bg-gray-900">

        <!-- Mobile overlay -->
        <div x-show="sidebarOpen" x-cloak @click="sidebarOpen=false" class="fixed inset-0 z-40 bg-black/50 backdrop-blur-[1px] lg:hidden"></div>

        <!-- Sidebar -->
        <aside
          class="fixed inset-y-0 left-0 z-50 flex flex-col border-r border-gray-200/70 dark:border-gray-800/70 bg-white/85 dark:bg-gray-950/55 backdrop-blur-xl
                 transition-all duration-300 ease-out lg:sticky lg:translate-x-0"
          :class="[
            sidebarOpen ? 'translate-x-0' : '-translate-x-full',
            sidebarCollapsed ? 'w-[5.25rem]' : 'w-72'
          ]"
        >
          <!-- Brand -->
          <div class="h-16 px-3 flex items-center gap-2 border-b border-gray-200/70 dark:border-gray-800/70">
            <a href="{% url 'core:dashboard' %}" class="flex items-center gap-3 min-w-0">
              <img src="{% static 'img/icons/pwa/pwa-192.png' %}" class="h-9 w-9 rounded-xl shadow-sm" alt="CTZ">
              <div class="min-w-0" x-show="!sidebarCollapsed" x-cloak>
                <div class="text-sm font-semibold text-gray-900 dark:text-white leading-5 truncate">Chase The Zones</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 truncate">Fitness dashboard</div>
              </div>
            </a>

            <div class="ml-auto flex items-center gap-1">
              <button
                @click="toggleCollapse()"
                class="hidden lg:inline-flex p-2 rounded-xl text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white
                       hover:bg-gray-100 dark:hover:bg-white/10 transition"
                :title="sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        :d="sidebarCollapsed ? 'M4 6h16M4 12h16M4 18h16' : 'M15 19l-7-7 7-7'"></path>
                </svg>
              </button>

              <button
                @click="sidebarOpen=false"
                class="lg:hidden p-2 rounded-xl text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white
                       hover:bg-gray-100 dark:hover:bg-white/10 transition"
                title="Close"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Nav -->
          <nav class="flex-1 overflow-y-auto ctz-scroll px-2 py-3">
            <ul class="space-y-1">

              <!-- Dashboard -->
              <li>
                <a href="{% url 'core:dashboard' %}"
                   class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                   {% if request.resolver_match.url_name == 'dashboard' or request.path == '/' %}
                     bg-primary text-white shadow-sm
                   {% else %}
                     text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                   {% endif %}">
                  <span class="grid place-items-center w-10 h-10 rounded-xl
                    {% if request.resolver_match.url_name == 'dashboard' or request.path == '/' %}
                      bg-white/15
                    {% else %}
                      bg-gray-100 dark:bg-white/10
                    {% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"></path>
                    </svg>
                  </span>
                  <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Dashboard</span>
                  <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Dashboard</span>
                </a>
              </li>

              <!-- Plans / Challenges -->
              <li class="pt-4 mt-4 border-t border-gray-200/70 dark:border-gray-800/70">
                <div class="px-3 pb-2 text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500"
                     x-show="!sidebarCollapsed" x-cloak>Planning & tracking</div>
              </li>

              <li>
                <a href="{% url 'tracker:weekly_plans' %}"
                   class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                   {% if 'tracker' in request.path and 'plan' in request.path %}
                     bg-primary text-white shadow-sm
                   {% else %}
                     text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                   {% endif %}">
                  <span class="grid place-items-center w-10 h-10 rounded-xl
                    {% if 'tracker' in request.path and 'plan' in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2"></path>
                    </svg>
                  </span>
                  <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Weekly Plans</span>
                  <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Weekly Plans</span>
                </a>
              </li>

              <li>
                <a href="{% url 'challenges:challenges_list' %}"
                   class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                   {% if 'challenges' in request.path and 'team' not in request.path and 'admin' not in request.path %}
                     bg-primary text-white shadow-sm
                   {% else %}
                     text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                   {% endif %}">
                  <span class="grid place-items-center w-10 h-10 rounded-xl
                    {% if 'challenges' in request.path and 'team' not in request.path and 'admin' not in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 22a10 10 0 100-20 10 10 0 000 20z"></path>
                    </svg>
                  </span>
                  <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Challenges</span>
                  <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Challenges</span>
                </a>
              </li>

              <!-- Library -->
              <li class="pt-4 mt-4 border-t border-gray-200/70 dark:border-gray-800/70">
                <div class="px-3 pb-2 text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500"
                     x-show="!sidebarCollapsed" x-cloak>Library</div>
              </li>

              <li>
                <a href="{% url 'classes:library' %}"
                   class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                   {% if 'classes' in request.path %}
                     bg-primary text-white shadow-sm
                   {% else %}
                     text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                   {% endif %}">
                  <span class="grid place-items-center w-10 h-10 rounded-xl
                    {% if 'classes' in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13"></path>
                    </svg>
                  </span>
                  <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Class Library</span>
                  <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Class Library</span>
                </a>
              </li>

              <!-- Analytics -->
              <li class="pt-4 mt-4 border-t border-gray-200/70 dark:border-gray-800/70">
                <div class="px-3 pb-2 text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500"
                     x-show="!sidebarCollapsed" x-cloak>Analytics</div>
              </li>

              <li>
                <a href="{% url 'workouts:history' %}"
                   class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                   {% if 'workouts' in request.path and 'library' not in request.path %}
                     bg-primary text-white shadow-sm
                   {% else %}
                     text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                   {% endif %}">
                  <span class="grid place-items-center w-10 h-10 rounded-xl
                    {% if 'workouts' in request.path and 'library' not in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </span>
                  <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Workouts</span>
                  <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Workouts</span>
                </a>
              </li>

              <li>
                <a href="{% url 'recommender:index' %}"
                   class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                   {% if 'instructor-recommender' in request.path %}
                     bg-primary text-white shadow-sm
                   {% else %}
                     text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                   {% endif %}">
                  <span class="grid place-items-center w-10 h-10 rounded-xl
                    {% if 'instructor-recommender' in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20H7m10 0v-2a4 4 0 00-8 0v2m8-13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                  </span>
                  <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Recommender</span>
                  <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Recommender</span>
                </a>
              </li>

              <li>
                <a href="{% url 'annual_challenge:index' %}"
                   class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                   {% if 'annual-challenge' in request.path %}
                     bg-primary text-white shadow-sm
                   {% else %}
                     text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                   {% endif %}">
                  <span class="grid place-items-center w-10 h-10 rounded-xl
                    {% if 'annual-challenge' in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-2.2 0-4 1.8-4 4 0 2 1.5 3.6 3.4 3.9L12 21l.6-5.1c1.9-.3 3.4-1.9 3.4-3.9 0-2.2-1.8-4-4-4z"></path>
                    </svg>
                  </span>
                  <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Annual Challenge</span>
                  <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Annual Challenge</span>
                </a>
              </li>

              <li>
                <a href="{% url 'plans:metrics' %}"
                   class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                   {% if 'metrics' in request.path %}
                     bg-primary text-white shadow-sm
                   {% else %}
                     text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                   {% endif %}">
                  <span class="grid place-items-center w-10 h-10 rounded-xl
                    {% if 'metrics' in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m6 0V9a2 2 0 012-2h2a2 2 0 012 2v10"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 21V5a2 2 0 012-2h2"></path>
                    </svg>
                  </span>
                  <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Metrics</span>
                  <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Metrics</span>
                </a>
              </li>

              <!-- Guide (collapsible section) -->
              <li class="pt-4 mt-4 border-t border-gray-200/70 dark:border-gray-800/70" x-data="{ open: {% if 'guide' in request.path or 'pace-zones' in request.path %}true{% else %}false{% endif %} }">
                <button
                  @click="open = !open"
                  class="group relative flex items-center justify-between w-full rounded-xl px-3 py-2.5 text-sm font-medium transition
                  {% if 'guide' in request.path or 'pace-zones' in request.path %}
                    bg-primary text-white shadow-sm
                  {% else %}
                    text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                  {% endif %}"
                >
                  <div class="flex items-center gap-3">
                    <span class="grid place-items-center w-10 h-10 rounded-xl
                      {% if 'guide' in request.path or 'pace-zones' in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 6.253C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13"></path>
                      </svg>
                    </span>
                    <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Guide</span>
                    <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Guide</span>
                  </div>

                  <svg x-show="!sidebarCollapsed" x-cloak class="w-4 h-4 transition-transform" :class="{'rotate-180': open}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>

                <ul x-show="open && !sidebarCollapsed" x-transition x-cloak class="mt-2 ml-2 space-y-1">
                  <li>
                    <a href="{% url 'plans:guide' %}"
                       class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium transition
                       {% if request.resolver_match.url_name == 'guide' %}
                         bg-primary/10 text-primary dark:bg-primary/20
                       {% else %}
                         text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10
                       {% endif %}">
                      <span class="w-10"></span>
                      User Guide
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'plans:pace_zones_reference' %}"
                       class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium transition
                       {% if request.resolver_match.url_name == 'pace_zones_reference' %}
                         bg-primary/10 text-primary dark:bg-primary/20
                       {% else %}
                         text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10
                       {% endif %}">
                      <span class="w-10"></span>
                      Pace Zones Reference
                    </a>
                  </li>
                </ul>
              </li>

              <!-- Admin -->
              {% if user.is_staff or user.is_superuser %}
                <li class="pt-4 mt-4 border-t border-gray-200/70 dark:border-gray-800/70">
                  <div class="px-3 pb-2 text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500"
                       x-show="!sidebarCollapsed" x-cloak>Admin</div>
                </li>

                <li>
                  <a href="{% url 'challenges:admin_challenges_list' %}"
                     class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                     {% if 'admin' in request.path and 'team' not in request.path %}
                       bg-primary text-white shadow-sm
                     {% else %}
                       text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                     {% endif %}">
                    <span class="grid place-items-center w-10 h-10 rounded-xl
                      {% if 'admin' in request.path and 'team' not in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      </svg>
                    </span>
                    <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Challenge Admin</span>
                    <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Challenge Admin</span>
                  </a>
                </li>

                {% load team_tags %}
                {% get_user_teams user as user_teams %}
                {% if user_teams %}
                  <li>
                    <a href="{% url 'challenges:team_leader_overview' %}"
                       class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                       {% if 'team-leader' in request.path %}
                         bg-primary text-white shadow-sm
                       {% else %}
                         text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                       {% endif %}">
                      <span class="grid place-items-center w-10 h-10 rounded-xl
                        {% if 'team-leader' in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 7a4 4 0 110 8 4 4 0 010-8z"></path>
                        </svg>
                      </span>
                      <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Team Leader Overview</span>
                      <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Team Leader</span>
                    </a>
                  </li>

                  <li>
                    <a href="{% url 'challenges:team_admin' user_teams.0.id %}"
                       class="group relative flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition
                       {% if 'team' in request.path and 'admin' in request.path and 'overview' not in request.path %}
                         bg-primary text-white shadow-sm
                       {% else %}
                         text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/10
                       {% endif %}">
                      <span class="grid place-items-center w-10 h-10 rounded-xl
                        {% if 'team' in request.path and 'admin' in request.path and 'overview' not in request.path %}bg-white/15{% else %}bg-gray-100 dark:bg-white/10{% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20H7m10 0v-2a4 4 0 00-8 0v2"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 7a3 3 0 110 6 3 3 0 010-6z"></path>
                        </svg>
                      </span>
                      <span class="truncate" x-show="!sidebarCollapsed" x-cloak>Team Admin</span>
                      <span x-show="sidebarCollapsed" x-cloak class="pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-lg bg-gray-900 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100 transition">Team Admin</span>
                    </a>
                  </li>
                {% endif %}
              {% endif %}
            </ul>
          </nav>

          <!-- Sidebar footer (user) -->
          <div class="border-t border-gray-200/70 dark:border-gray-800/70 p-3">
            <div x-data="{ open:false }" class="relative">
              <button @click="open=!open" class="w-full flex items-center gap-3 p-2 rounded-2xl hover:bg-gray-100 dark:hover:bg-white/10 transition">
                <div class="w-10 h-10 rounded-full bg-primary text-white grid place-items-center font-semibold shadow-sm">
                  {% if user.profile.full_name %}
                    {% with name=user.profile.full_name %}
                      {{ name|first|upper }}{% if " " in name %}{{ name|slice:"-1:"|first|upper }}{% endif %}
                    {% endwith %}
                  {% else %}
                    {{ user.email|slice:":2"|upper }}
                  {% endif %}
                </div>

                <div class="min-w-0 flex-1 text-left" x-show="!sidebarCollapsed" x-cloak>
                  <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">
                    {% if user.profile.full_name %}{{ user.profile.full_name }}{% else %}{{ user.email }}{% endif %}
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Signed in</p>
                </div>

                <svg x-show="!sidebarCollapsed" x-cloak class="w-4 h-4 text-gray-500 dark:text-gray-400 transition-transform" :class="open ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>

              <div x-show="open" @click.away="open=false" x-cloak class="absolute bottom-full left-0 right-0 mb-2 bg-white dark:bg-gray-900 rounded-2xl shadow-xl border border-gray-200/70 dark:border-gray-800/70 overflow-hidden">
                <a href="{% url 'profile' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10">
                  <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  Profile
                </a>

                <div class="border-t border-gray-200/70 dark:border-gray-800/70"></div>

                <form method="post" action="{% url 'account_logout' %}" class="m-0">
                  {% csrf_token %}
                  <button type="submit" class="w-full flex items-center px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-white/10">
                    <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    Log out
                  </button>
                </form>
              </div>
            </div>
          </div>
        </aside>

        <!-- Main -->
        <div class="flex-1 min-w-0 flex flex-col">

          <!-- Topbar -->
          <header class="sticky top-0 z-30 bg-white/75 dark:bg-gray-950/45 backdrop-blur-xl border-b border-gray-200/70 dark:border-gray-800/70">
            <div class="h-16 px-4 sm:px-6 flex items-center justify-between">
              <div class="flex items-center gap-2 min-w-0">
                <button @click="toggleSidebar()" class="lg:hidden p-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10 transition" aria-label="Open sidebar">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                  </svg>
                </button>

                <div class="min-w-0">
                  <h1 class="text-lg font-semibold text-gray-900 dark:text-white truncate">{% block page_title %}Dashboard{% endblock %}</h1>
                  <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{% block page_subtitle %}{% endblock %}</p>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <button class="relative p-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10 transition" aria-label="Notifications">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1"></path>
                  </svg>
                  <span class="absolute top-2 right-2 block h-2 w-2 rounded-full bg-red-500"></span>
                </button>

                <button @click="toggleDark()" class="p-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10 transition" title="Toggle dark mode">
                  <svg x-show="!darkMode" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                  </svg>
                  <svg x-show="darkMode" x-cloak class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </header>

          <!-- Content -->
          <main class="flex-1 min-w-0 ctz-scroll">
            {% if messages %}
              <div class="px-4 sm:px-6 pt-6">
                {% for message in messages %}
                  <div class="mb-3 p-4 rounded-2xl border
                    {% if message.tags == 'error' %}bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800 text-red-800 dark:text-red-200
                    {% elif message.tags == 'success' %}bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800 text-green-800 dark:text-green-200
                    {% elif message.tags == 'warning' %}bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200
                    {% else %}bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200{% endif %}">
                    {{ message }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="px-4 sm:px-6 py-6">
              {% block content %}{% endblock %}
            </div>

            <div class="px-4 sm:px-6 pb-8">
              {% include 'partials/footer.html' %}
            </div>
          </main>
        </div>
      </div>
    {% endif %}

  {% else %}
    <!-- Non-authenticated Layout -->
    <nav class="bg-white/85 dark:bg-gray-950/60 backdrop-blur-xl border-b border-gray-200/70 dark:border-gray-800/70 md:sticky md:top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center">
            <a href="{% url 'core:dashboard' %}" class="flex items-center group transition-opacity hover:opacity-90">
              <img src="{% static 'img/logo.png' %}" alt="Chase The Zones" class="h-10 w-auto transition-transform group-hover:scale-[1.03]">
            </a>

            <div class="hidden md:flex ml-10 space-x-1">
              <a href="{% url 'core:landing' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition
                {% if request.resolver_match.url_name == 'landing' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                  text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
                {% endif %}">Home</a>

              <a href="{% url 'core:how_it_works' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition
                {% if request.resolver_match.url_name == 'how_it_works' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                  text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
                {% endif %}">How It Works</a>

              <a href="{% url 'core:features' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition
                {% if request.resolver_match.url_name == 'features' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                  text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
                {% endif %}">Features</a>

              <a href="{% url 'core:about' %}" class="px-4 py-2 text-sm font-medium rounded-xl transition
                {% if request.resolver_match.url_name == 'about' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                  text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
                {% endif %}">About</a>
            </div>

            <button @click="sidebarOpen = !sidebarOpen" class="md:hidden p-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10 transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
          </div>

          <div class="flex items-center space-x-2">
            <button @click="toggleDark()" class="p-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/10 transition" title="Toggle dark mode">
              <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
              </svg>
              <svg x-show="darkMode" x-cloak class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
              </svg>
            </button>

            <a href="{% url 'login' %}" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary rounded-xl transition hover:bg-gray-100 dark:hover:bg-white/10">Login</a>
            <a href="{% url 'register' %}" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-dark rounded-xl transition shadow-sm hover:shadow-md">Register</a>
          </div>
        </div>

        <div x-show="sidebarOpen" @click.away="sidebarOpen=false" x-cloak class="md:hidden border-t border-gray-200/70 dark:border-gray-800/70 py-3 bg-gray-50/60 dark:bg-gray-950/40 backdrop-blur">
          <div class="space-y-1 px-2">
            <a href="{% url 'core:landing' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition
              {% if request.resolver_match.url_name == 'landing' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
              {% endif %}">Home</a>
            <a href="{% url 'core:how_it_works' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition
              {% if request.resolver_match.url_name == 'how_it_works' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
              {% endif %}">How It Works</a>
            <a href="{% url 'core:features' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition
              {% if request.resolver_match.url_name == 'features' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
              {% endif %}">Features</a>
            <a href="{% url 'core:about' %}" class="block px-4 py-2.5 text-sm font-medium rounded-xl transition
              {% if request.resolver_match.url_name == 'about' %}text-primary bg-primary/10 dark:bg-primary/20 font-semibold{% else %}
                text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-white/10
              {% endif %}">About</a>
          </div>
        </div>
      </div>
    </nav>

    <main>
      {% if messages %}
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          {% for message in messages %}
            <div class="mb-3 p-4 rounded-2xl border
              {% if message.tags == 'error' %}bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800 text-red-800 dark:text-red-200
              {% elif message.tags == 'success' %}bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800 text-green-800 dark:text-green-200
              {% elif message.tags == 'warning' %}bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200
              {% else %}bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}


    </main>

    {% include 'partials/footer.html' %}
  {% endif %}

  <!-- Toast Notification Container -->
  <div x-data class="fixed top-20 right-4 z-50 space-y-2 max-w-sm">
    <template x-for="notification in $store.notifications.items" :key="notification.id">
      <div
        x-show="true"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-x-full"
        x-transition:enter-end="opacity-100 transform translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0 transform translate-x-full"
        class="px-6 py-4 rounded-2xl shadow-xl backdrop-blur-sm"
        :class="{
          'bg-blue-500 text-white': notification.type === 'info',
          'bg-green-500 text-white': notification.type === 'success',
          'bg-red-500 text-white': notification.type === 'error',
          'bg-yellow-500 text-white': notification.type === 'warning'
        }"
      >
        <div class="flex items-start justify-between gap-3">
          <span x-text="notification.message" class="flex-1"></span>
          <button @click="$store.notifications.remove(notification.id)" class="flex-shrink-0 hover:opacity-75 transition-opacity">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </template>
  </div>

  <!-- Video Modal -->
  <div class="video-modal" id="videoModal">
    <div class="video-modal-overlay" id="videoModalOverlay"></div>
    <div class="video-modal-content">
      <button class="video-modal-close" id="videoModalClose">&times;</button>
      <div class="video-modal-body">
        <iframe id="videoModalFrame" src="" frameborder="0" allowfullscreen loading="lazy"></iframe>
      </div>
    </div>
  </div>

  {% block extra_body %}{% endblock %}
</body>
</html>
