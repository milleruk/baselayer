{% extends "base.html" %}
{% load dict_filters %}
{% block title %}Assign Peloton Workouts - {{ challenge.name }}{% endblock %}

{% block content %}
<div class="dashboard-header">
  <div>
    <h1>Assign Peloton Workouts</h1>
    <p style="color: var(--text-muted); margin-top: 0.5rem;">
      Assign Peloton workout URLs for each day and activity type. Each day should have a different workout (no duplicates within a week).
    </p>
    <div class="workout-assignment-stats" id="workoutStats" style="margin-top: 1rem; display: flex; gap: 1.5rem; flex-wrap: wrap;">
      <div class="stat-item">
        <span class="stat-label">Total Needed:</span>
        <span class="stat-value" id="totalNeeded">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Assigned:</span>
        <span class="stat-value stat-assigned" id="totalAssigned">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Missing:</span>
        <span class="stat-value stat-missing" id="totalMissing">0</span>
      </div>
    </div>
  </div>
  <div>
    <a href="{% url 'tracker:admin_challenges_list' %}" class="btn btn-outline-light">Back to Challenges</a>
  </div>
</div>

<form method="post" id="workout-assignment-form" action="{% url 'tracker:admin_assign_workouts' challenge.id %}">
  {% csrf_token %}
  
  <!-- Template Tabs -->
  {% if workout_structure|length > 1 %}
  <div class="workout-tabs">
    {% for template_data in workout_structure %}
    <button type="button" 
            class="workout-tab {% if forloop.first %}active{% endif %}" 
            data-template-id="{{ template_data.template.id }}"
            onclick="switchTemplate({{ template_data.template.id }})">
      {{ template_data.template.name }}
    </button>
    {% endfor %}
  </div>
  {% endif %}
  
  {% for template_data in workout_structure %}
  <div class="template-content {% if not forloop.first %}hidden{% endif %}" data-template-id="{{ template_data.template.id }}">
    <div class="dashboard-section" style="margin-bottom: 2rem;">
      <div class="dashboard-section-title" style="margin-bottom: 1.5rem;">
        {{ template_data.template.name }}
        <span style="font-size: 0.85rem; color: var(--text-muted); font-weight: normal; margin-left: 1rem;">
          ({{ template_data.template.description|default:"No description" }})
        </span>
      </div>
    
    {% for week_data in template_data.weeks %}
    <div class="workout-week-section" data-week="{{ week_data.week_number }}" data-template="{{ template_data.template.id }}">
      <div class="workout-week-header">
        <div class="workout-week-title-row">
          <h3 class="workout-week-title">Week {{ week_data.week_number }}</h3>
          <button type="button" class="workout-week-toggle collapsed" data-week="{{ week_data.week_number }}" data-template="{{ template_data.template.id }}" aria-label="Toggle week">
            <span class="toggle-icon">‚ñº</span>
          </button>
        </div>
        <div class="workout-week-stats">
          <span class="week-stat-assigned" data-week="{{ week_data.week_number }}" data-template="{{ template_data.template.id }}">0</span> / 
          <span class="week-stat-total" data-week="{{ week_data.week_number }}" data-template="{{ template_data.template.id }}">0</span> assigned
        </div>
      </div>
      
      <div class="workout-week-content collapsed" id="week-{{ template_data.template.id }}-{{ week_data.week_number }}-content">
        {% for day_data in week_data.days %}
        {% if day_data.peloton_focus %}
        <div class="workout-day-card {% if day_data.assignments.ride or day_data.assignments.run or day_data.assignments.yoga or day_data.assignments.strength %}workout-day-has-assignment{% endif %}" 
             data-day="{{ day_data.day_of_week }}" 
             data-week="{{ week_data.week_number }}"
             data-template="{{ template_data.template.id }}">
          <div class="workout-day-title-row">
            <div class="workout-day-title">{{ day_data.day_label }}</div>
            <div class="workout-day-focus">{{ day_data.peloton_focus }}</div>
            {% if day_data.assignments.ride or day_data.assignments.run or day_data.assignments.yoga or day_data.assignments.strength %}
              <span class="workout-assigned-badge" title="Workout assigned">‚úì</span>
            {% endif %}
          </div>
          
          {% if day_data.has_ride %}
          <div class="workout-activity-section" data-activity="ride">
            <label class="workout-activity-label">
              <span class="workout-activity-icon">üö¥</span>
              Ride
              {% if day_data.allows_alternatives %}
                <span class="field-status" style="background: var(--accent); color: var(--dark); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.5rem;">Allows Alternatives</span>
              {% elif day_data.assignments.ride|length > 0 %}
                <span class="field-status filled">Filled</span>
              {% else %}
                <span class="field-status empty">Required</span>
              {% endif %}
            </label>
            
            {% for alt in day_data.assignments.ride %}
            <div class="workout-alternative-row" style="margin-bottom: 0.75rem; padding-left: 2rem;">
              {% if not forloop.first %}
              <div style="text-align: center; margin: 0.5rem 0;">
                <span style="background: var(--accent); color: var(--dark); padding: 0.4rem 1rem; border-radius: 15px; font-weight: 700; font-size: 0.85rem;">OR</span>
              </div>
              {% endif %}
              <div class="workout-input-group">
                <input 
                  type="url" 
                  name="workout_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_ride{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                  value="{{ alt.peloton_url }}"
                  placeholder="https://www.onepeloton.com/..."
                  class="workout-url-input {% if alt.peloton_url %}has-value{% endif %}"
                  data-template="{{ template_data.template.id }}"
                  data-week="{{ week_data.week_number }}"
                  data-activity="ride"
                  data-day="{{ day_data.day_of_week }}"
                >
                {% if alt.peloton_url %}
                  <a href="{{ alt.peloton_url }}" target="_blank" class="workout-preview-link" title="Preview workout">üîó</a>
                {% endif %}
              </div>
              <input 
                type="text" 
                  name="title_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_ride{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                value="{{ alt.workout_title }}"
                placeholder="Workout title (optional)"
                class="workout-title-input"
              >
              <input 
                type="number" 
                name="points_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_ride{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                value="{{ alt.points|default:50 }}"
                placeholder="Points"
                min="0"
                max="100"
                class="workout-points-input"
                style="width: 80px; margin-left: 0.5rem;"
                title="Points awarded for completing this workout"
              >
            </div>
            {% empty %}
            <div class="workout-alternative-row">
              <div class="workout-input-group">
                <input 
                  type="url" 
                  name="workout_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_ride"
                  value=""
                  placeholder="https://www.onepeloton.com/..."
                  class="workout-url-input"
                  data-template="{{ template_data.template.id }}"
                  data-week="{{ week_data.week_number }}"
                  data-activity="ride"
                  data-day="{{ day_data.day_of_week }}"
                >
              </div>
              <input 
                type="text" 
                name="title_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_ride"
                value=""
                placeholder="Workout title (optional)"
                class="workout-title-input"
              >
              <input 
                type="number" 
                name="points_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_ride"
                value="50"
                placeholder="Points"
                min="0"
                max="100"
                class="workout-points-input"
                style="width: 80px; margin-left: 0.5rem;"
                title="Points awarded for completing this workout"
              >
            </div>
            {% endfor %}
            
            {% if day_data.allows_alternatives %}
            <button type="button" class="btn-add-alternative" 
                    onclick="addWorkoutAlternative(this, '{{ template_data.template.id }}', '{{ week_data.week_number }}', '{{ day_data.day_of_week }}', 'ride')"
                    style="margin-top: 0.5rem; margin-left: 2rem; padding: 0.5rem 1rem; background: var(--dark); border: 1px dashed var(--border); color: var(--text-muted); cursor: pointer; font-size: 0.85rem;">
              + Add Alternative
            </button>
            {% endif %}
          </div>
          {% endif %}
          
          {% if day_data.has_run %}
          <div class="workout-activity-section" data-activity="run">
            <label class="workout-activity-label">
              <span class="workout-activity-icon">üèÉ</span>
              Run
              {% if day_data.allows_alternatives %}
                <span class="field-status" style="background: var(--accent); color: var(--dark); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.5rem;">Allows Alternatives</span>
              {% elif day_data.assignments.run|length > 0 %}
                <span class="field-status filled">Filled</span>
              {% else %}
                <span class="field-status empty">Required</span>
              {% endif %}
            </label>
            
            {% for alt in day_data.assignments.run %}
            <div class="workout-alternative-row" style="margin-bottom: 0.75rem; padding-left: 2rem;">
              {% if not forloop.first %}
              <div style="text-align: center; margin: 0.5rem 0;">
                <span style="background: var(--accent); color: var(--dark); padding: 0.4rem 1rem; border-radius: 15px; font-weight: 700; font-size: 0.85rem;">OR</span>
              </div>
              {% endif %}
              <div class="workout-input-group">
                <input 
                  type="url" 
                  name="workout_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_run{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                  value="{{ alt.peloton_url }}"
                  placeholder="https://www.onepeloton.com/..."
                  class="workout-url-input {% if alt.peloton_url %}has-value{% endif %}"
                  data-template="{{ template_data.template.id }}"
                  data-week="{{ week_data.week_number }}"
                  data-activity="run"
                  data-day="{{ day_data.day_of_week }}"
                >
                {% if alt.peloton_url %}
                  <a href="{{ alt.peloton_url }}" target="_blank" class="workout-preview-link" title="Preview workout">üîó</a>
                {% endif %}
              </div>
              <input 
                type="text" 
                  name="title_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_run{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                value="{{ alt.workout_title }}"
                placeholder="Workout title (optional)"
                class="workout-title-input"
              >
              <input 
                type="number" 
                name="points_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_run{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                value="{{ alt.points|default:50 }}"
                placeholder="Points"
                min="0"
                max="100"
                class="workout-points-input"
                style="width: 80px; margin-left: 0.5rem;"
                title="Points awarded for completing this workout"
              >
            </div>
            {% empty %}
            <div class="workout-alternative-row">
              <div class="workout-input-group">
                <input 
                  type="url" 
                  name="workout_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_run"
                  value=""
                  placeholder="https://www.onepeloton.com/..."
                  class="workout-url-input"
                  data-template="{{ template_data.template.id }}"
                  data-week="{{ week_data.week_number }}"
                  data-activity="run"
                  data-day="{{ day_data.day_of_week }}"
                >
              </div>
              <input 
                type="text" 
                name="title_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_run"
                value=""
                placeholder="Workout title (optional)"
                class="workout-title-input"
              >
              <input 
                type="number" 
                name="points_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_run"
                value="50"
                placeholder="Points"
                min="0"
                max="100"
                class="workout-points-input"
                style="width: 80px; margin-left: 0.5rem;"
                title="Points awarded for completing this workout"
              >
            </div>
            {% endfor %}
            
            {% if day_data.allows_alternatives %}
            <button type="button" class="btn-add-alternative" 
                    onclick="addWorkoutAlternative(this, '{{ template_data.template.id }}', '{{ week_data.week_number }}', '{{ day_data.day_of_week }}', 'run')"
                    style="margin-top: 0.5rem; margin-left: 2rem; padding: 0.5rem 1rem; background: var(--dark); border: 1px dashed var(--border); color: var(--text-muted); cursor: pointer; font-size: 0.85rem;">
              + Add Alternative
            </button>
            {% endif %}
          </div>
          {% endif %}
          
          {% if day_data.has_yoga %}
          <div class="workout-activity-section" data-activity="yoga">
            <label class="workout-activity-label">
              <span class="workout-activity-icon">üßò</span>
              Yoga
              {% if day_data.allows_alternatives %}
                <span class="field-status" style="background: var(--accent); color: var(--dark); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.5rem;">Allows Alternatives</span>
              {% elif day_data.assignments.yoga|length > 0 %}
                <span class="field-status filled">Filled</span>
              {% else %}
                <span class="field-status empty">Required</span>
              {% endif %}
            </label>
            
            {% for alt in day_data.assignments.yoga %}
            <div class="workout-alternative-row" style="margin-bottom: 0.75rem; padding-left: 2rem;">
              {% if not forloop.first %}
              <div style="text-align: center; margin: 0.5rem 0;">
                <span style="background: var(--accent); color: var(--dark); padding: 0.4rem 1rem; border-radius: 15px; font-weight: 700; font-size: 0.85rem;">OR</span>
              </div>
              {% endif %}
              <div class="workout-input-group">
                <input 
                  type="url" 
                  name="workout_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_yoga{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                  value="{{ alt.peloton_url }}"
                  placeholder="https://www.onepeloton.com/..."
                  class="workout-url-input {% if alt.peloton_url %}has-value{% endif %}"
                  data-template="{{ template_data.template.id }}"
                  data-week="{{ week_data.week_number }}"
                  data-activity="yoga"
                  data-day="{{ day_data.day_of_week }}"
                >
                {% if alt.peloton_url %}
                  <a href="{{ alt.peloton_url }}" target="_blank" class="workout-preview-link" title="Preview workout">üîó</a>
                {% endif %}
              </div>
              <input 
                type="text" 
                  name="title_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_yoga{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                value="{{ alt.workout_title }}"
                placeholder="Workout title (optional)"
                class="workout-title-input"
              >
              <input 
                type="number" 
                name="points_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_yoga{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                value="{{ alt.points|default:50 }}"
                placeholder="Points"
                min="0"
                max="100"
                class="workout-points-input"
                style="width: 80px; margin-left: 0.5rem;"
                title="Points awarded for completing this workout"
              >
            </div>
            {% empty %}
            <div class="workout-alternative-row">
              <div class="workout-input-group">
                <input 
                  type="url" 
                  name="workout_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_yoga"
                  value=""
                  placeholder="https://www.onepeloton.com/..."
                  class="workout-url-input"
                  data-template="{{ template_data.template.id }}"
                  data-week="{{ week_data.week_number }}"
                  data-activity="yoga"
                  data-day="{{ day_data.day_of_week }}"
                >
              </div>
              <input 
                type="text" 
                name="title_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_yoga"
                value=""
                placeholder="Workout title (optional)"
                class="workout-title-input"
              >
              <input 
                type="number" 
                name="points_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_yoga"
                value="50"
                placeholder="Points"
                min="0"
                max="100"
                class="workout-points-input"
                style="width: 80px; margin-left: 0.5rem;"
                title="Points awarded for completing this workout"
              >
            </div>
            {% endfor %}
            
            {% if day_data.allows_alternatives %}
            <button type="button" class="btn-add-alternative" 
                    onclick="addWorkoutAlternative(this, '{{ template_data.template.id }}', '{{ week_data.week_number }}', '{{ day_data.day_of_week }}', 'yoga')"
                    style="margin-top: 0.5rem; margin-left: 2rem; padding: 0.5rem 1rem; background: var(--dark); border: 1px dashed var(--border); color: var(--text-muted); cursor: pointer; font-size: 0.85rem;">
              + Add Alternative
            </button>
            {% endif %}
          </div>
          {% endif %}
          
          {% if day_data.has_strength %}
          <div class="workout-activity-section" data-activity="strength">
            <label class="workout-activity-label">
              <span class="workout-activity-icon">üí™</span>
              Strength
              {% if day_data.allows_alternatives %}
                <span class="field-status" style="background: var(--accent); color: var(--dark); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.5rem;">Allows Alternatives</span>
              {% elif day_data.assignments.strength|length > 0 %}
                <span class="field-status filled">Filled</span>
              {% else %}
                <span class="field-status empty">Required</span>
              {% endif %}
            </label>
            
            {% for alt in day_data.assignments.strength %}
            <div class="workout-alternative-row" style="margin-bottom: 0.75rem; padding-left: 2rem;">
              {% if not forloop.first %}
              <div style="text-align: center; margin: 0.5rem 0;">
                <span style="background: var(--accent); color: var(--dark); padding: 0.4rem 1rem; border-radius: 15px; font-weight: 700; font-size: 0.85rem;">OR</span>
              </div>
              {% endif %}
              <div class="workout-input-group">
                <input 
                  type="url" 
                  name="workout_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_strength{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                  value="{{ alt.peloton_url }}"
                  placeholder="https://www.onepeloton.com/..."
                  class="workout-url-input {% if alt.peloton_url %}has-value{% endif %}"
                  data-template="{{ template_data.template.id }}"
                  data-week="{{ week_data.week_number }}"
                  data-activity="strength"
                  data-day="{{ day_data.day_of_week }}"
                >
                {% if alt.peloton_url %}
                  <a href="{{ alt.peloton_url }}" target="_blank" class="workout-preview-link" title="Preview workout">üîó</a>
                {% endif %}
              </div>
              <input 
                type="text" 
                  name="title_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_strength{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                value="{{ alt.workout_title }}"
                placeholder="Workout title (optional)"
                class="workout-title-input"
              >
              <input 
                type="number" 
                name="points_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_strength{% if not forloop.first %}_alt{{ forloop.counter }}{% endif %}"
                value="{{ alt.points|default:50 }}"
                placeholder="Points"
                min="0"
                max="100"
                class="workout-points-input"
                style="width: 80px; margin-left: 0.5rem;"
                title="Points awarded for completing this workout"
              >
            </div>
            {% empty %}
            <div class="workout-alternative-row">
              <div class="workout-input-group">
                <input 
                  type="url" 
                  name="workout_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_strength"
                  value=""
                  placeholder="https://www.onepeloton.com/..."
                  class="workout-url-input"
                  data-template="{{ template_data.template.id }}"
                  data-week="{{ week_data.week_number }}"
                  data-activity="strength"
                  data-day="{{ day_data.day_of_week }}"
                >
              </div>
              <input 
                type="text" 
                name="title_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_strength"
                value=""
                placeholder="Workout title (optional)"
                class="workout-title-input"
              >
              <input 
                type="number" 
                name="points_{{ template_data.template.id }}_{{ week_data.week_number }}_{{ day_data.day_of_week }}_strength"
                value="50"
                placeholder="Points"
                min="0"
                max="100"
                class="workout-points-input"
                style="width: 80px; margin-left: 0.5rem;"
                title="Points awarded for completing this workout"
              >
            </div>
            {% endfor %}
            
            {% if day_data.allows_alternatives %}
            <button type="button" class="btn-add-alternative" 
                    onclick="addWorkoutAlternative(this, '{{ template_data.template.id }}', '{{ week_data.week_number }}', '{{ day_data.day_of_week }}', 'strength')"
                    style="margin-top: 0.5rem; margin-left: 2rem; padding: 0.5rem 1rem; background: var(--dark); border: 1px dashed var(--border); color: var(--text-muted); cursor: pointer; font-size: 0.85rem;">
              + Add Alternative
            </button>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endfor %}
    </div>
  </div>
  {% endfor %}
  
  <!-- Bonus Workouts Section (Same for all templates) -->
  <div class="dashboard-section" style="margin-top: 3rem; border-top: 2px solid var(--border); padding-top: 2rem;">
    <div class="dashboard-section-title" style="margin-bottom: 1.5rem;">
      Bonus Workouts
      <span style="font-size: 0.85rem; color: var(--text-muted); font-weight: normal; margin-left: 1rem;">
        (Same for all plan options)
      </span>
    </div>
    
    {% for week_num in week_range %}
    <div class="workout-week-section" data-week="{{ week_num }}" style="margin-bottom: 2rem;">
      <div class="workout-week-header">
        <div class="workout-week-title-row">
          <h3 class="workout-week-title">Week {{ week_num }} - Bonus Workout</h3>
          <button type="button" class="workout-week-toggle collapsed" data-week="{{ week_num }}" aria-label="Toggle week">
            <span class="toggle-icon">‚ñº</span>
          </button>
        </div>
      </div>
      
      <div class="workout-week-content collapsed" id="bonus-week-{{ week_num }}-content">
        {% with week_bonus=bonus_workouts|get_item:week_num %}
        <div class="workout-activity-row" style="margin-bottom: 1rem;">
          <label class="workout-activity-label">
            <span class="workout-activity-icon">{% if default_bonus_activity == "run" %}üèÉ{% else %}üö¥{% endif %}</span>
            {% if default_bonus_activity == "run" %}RUN{% else %}RIDE{% endif %}
            <span class="field-status" style="margin-left: 0.5rem; font-size: 0.75rem;">
              {% if week_bonus %}Filled{% else %}Optional{% endif %}
            </span>
          </label>
          <div class="workout-input-group">
            <input 
              type="hidden" 
              name="bonus_activity_{{ week_num }}"
              value="{{ default_bonus_activity }}"
            >
            <input 
              type="url" 
              name="bonus_workout_{{ week_num }}"
              value="{% if week_bonus %}{{ week_bonus.peloton_url }}{% endif %}"
              placeholder="Peloton workout URL (optional - leave empty for 'Any 30 min+ Peloton Workout')"
              class="workout-url-input"
              data-week="{{ week_num }}"
            >
            <input 
              type="text" 
              name="bonus_title_{{ week_num }}"
              value="{% if week_bonus %}{{ week_bonus.workout_title }}{% endif %}"
              placeholder="Workout title (optional)"
              class="workout-title-input"
            >
            <input 
              type="number" 
              name="bonus_points_{{ week_num }}"
              value="{% if week_bonus %}{{ week_bonus.points }}{% else %}10{% endif %}"
              placeholder="Points"
              class="workout-points-input"
              min="0"
              style="width: 80px;"
            >
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
            <em>Leave URL empty to allow users to choose "Any 30 min+ Peloton Workout"</em>
          </div>
        </div>
        {% endwith %}
      </div>
    </div>
    {% endfor %}
  </div>
  
  <div class="workout-form-footer">
    <div class="workout-form-actions">
      <a href="{% url 'tracker:admin_challenges_list' %}" class="btn btn-outline-light">Skip for Now</a>
      <button type="button" class="btn btn-accent" id="saveButton" onclick="saveWorkouts()">
        <span>Save Workout Assignments</span>
        <span class="save-button-stats" id="saveButtonStats"></span>
      </button>
    </div>
  </div>
</form>

<style>
/* Stats Section */
.workout-assignment-stats {
  padding: 1rem;
  background: var(--dark-light);
  border: 1px solid var(--border);
  border-radius: 0;
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.stat-label {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.stat-value {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text);
}

.stat-assigned {
  color: var(--accent);
}

.stat-missing {
  color: var(--primary);
}

/* Week Section */
.workout-week-section {
  margin-bottom: 1.5rem;
  background: var(--dark);
  border: 1px solid var(--border);
}

.workout-week-header {
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: background 0.3s;
}

.workout-week-header:hover {
  background: rgba(78, 205, 196, 0.05);
}

.workout-week-title-row {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.workout-week-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--accent);
  margin: 0;
}

.workout-week-toggle {
  background: transparent;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.25rem;
  transition: transform 0.3s;
}

.workout-week-toggle:hover {
  color: var(--accent);
}

.workout-week-toggle.collapsed .toggle-icon {
  transform: rotate(-90deg);
}

.toggle-icon {
  display: inline-block;
  transition: transform 0.3s;
  font-size: 0.8rem;
}

.workout-week-stats {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.workout-week-content {
  padding: 1.5rem;
  transition: max-height 0.3s ease-out;
  overflow: hidden;
}

.workout-week-content.collapsed {
  max-height: 0;
  padding: 0 1.5rem;
  overflow: hidden;
}

.workout-day-card {
  background: var(--dark-light);
  border-left: 3px solid var(--border);
  border-right: 1px solid var(--border);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  padding: 1.25rem;
  margin-bottom: 1rem;
  transition: all 0.3s;
}

.workout-day-card:hover {
  border-left-color: var(--accent);
}

.workout-day-card.workout-day-has-assignment {
  border-left-color: var(--accent);
  background: rgba(78, 205, 196, 0.05);
}

.workout-day-title-row {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.workout-day-title {
  font-weight: 700;
  font-size: 1rem;
  color: var(--text);
  min-width: 3rem;
}

.workout-day-focus {
  font-size: 0.9rem;
  color: var(--text-muted);
  font-style: italic;
  flex: 1;
}

.workout-assigned-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 1.5rem;
  height: 1.5rem;
  background: var(--accent);
  color: var(--dark);
  font-size: 0.75rem;
  font-weight: 700;
  border-radius: 0;
  flex-shrink: 0;
}

.workout-activity-row {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.workout-activity-row:last-child {
  margin-bottom: 0;
}

.workout-activity-label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.workout-activity-icon {
  font-size: 1rem;
}

.field-status {
  font-size: 0.7rem;
  padding: 0.2rem 0.5rem;
  border-radius: 0;
  font-weight: 700;
  text-transform: none;
  letter-spacing: 0;
}

.field-status.filled {
  background: rgba(78, 205, 196, 0.2);
  color: var(--accent);
}

.field-status.empty {
  background: rgba(255, 107, 107, 0.2);
  color: var(--primary);
}

.workout-input-group {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.workout-url-input {
  flex: 1;
  padding: 0.625rem;
  background: var(--dark);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 0.875rem;
  transition: all 0.3s;
}

.workout-url-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.2);
}

.workout-url-input.has-value {
  border-color: var(--accent);
}

.workout-preview-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  background: var(--dark);
  border: 1px solid var(--border);
  color: var(--text-muted);
  text-decoration: none;
  transition: all 0.3s;
  flex-shrink: 0;
}

.workout-preview-link:hover {
  background: var(--accent);
  border-color: var(--accent);
  color: var(--dark);
}

.workout-title-input {
  width: 100%;
  padding: 0.5rem;
  background: var(--dark);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 0.8rem;
  transition: border-color 0.3s;
}

.workout-title-input:focus {
  outline: none;
  border-color: var(--primary);
}

.workout-form-footer {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid var(--border);
}

.workout-form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  align-items: center;
}

.save-button-stats {
  font-size: 0.75rem;
  font-weight: normal;
  opacity: 0.8;
  margin-left: 0.5rem;
}

/* Template Tabs */
.workout-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  border-bottom: 2px solid var(--border);
  padding-bottom: 0;
}

.workout-tab {
  padding: 0.75rem 1.5rem;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--text-muted);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-bottom: -2px;
}

.workout-tab:hover {
  color: var(--text);
  background: rgba(78, 205, 196, 0.05);
}

.workout-tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
  background: transparent;
}

.template-content {
  display: block;
}

.template-content.hidden {
  display: none;
}

@media (max-width: 768px) {
  .workout-days-grid {
    grid-template-columns: 1fr;
  }
  
  .workout-week-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .workout-form-actions {
    flex-direction: column;
  }
  
  .workout-form-actions .btn {
    width: 100%;
  }
  
  .workout-tabs {
    flex-wrap: wrap;
    overflow-x: auto;
  }
  
  .workout-tab {
    padding: 0.625rem 1rem;
    font-size: 0.85rem;
  }
}
</style>

<script>
  // Function to add workout alternative
  window.addWorkoutAlternative = function(button, templateId, weekNum, dayNum, activityType) {
    const activitySection = button.closest('.workout-activity-section');
    const existingAlternatives = activitySection.querySelectorAll('.workout-alternative-row');
    const altIndex = existingAlternatives.length;
    
    // Create OR separator if not first alternative
    if (altIndex > 0) {
      const orDiv = document.createElement('div');
      orDiv.style.cssText = 'text-align: center; margin: 0.5rem 0;';
      orDiv.innerHTML = '<span style="background: var(--accent); color: var(--dark); padding: 0.4rem 1rem; border-radius: 15px; font-weight: 700; font-size: 0.85rem;">OR</span>';
      activitySection.insertBefore(orDiv, button);
    }
    
    // Create new alternative row
    const altRow = document.createElement('div');
    altRow.className = 'workout-alternative-row';
    altRow.style.cssText = 'margin-bottom: 0.75rem; padding-left: 2rem;';
    
    const inputGroup = document.createElement('div');
    inputGroup.className = 'workout-input-group';
    
    const urlInput = document.createElement('input');
    urlInput.type = 'url';
    urlInput.name = `workout_${templateId}_${weekNum}_${dayNum}_${activityType}_alt${altIndex}`;
    urlInput.placeholder = 'https://www.onepeloton.com/...';
    urlInput.className = 'workout-url-input';
    urlInput.setAttribute('data-template', templateId);
    urlInput.setAttribute('data-week', weekNum);
    urlInput.setAttribute('data-activity', activityType);
    urlInput.setAttribute('data-day', dayNum);
    
    const titleInput = document.createElement('input');
    titleInput.type = 'text';
    titleInput.name = `title_${templateId}_${weekNum}_${dayNum}_${activityType}_alt${altIndex}`;
    titleInput.placeholder = 'Workout title (optional)';
    titleInput.className = 'workout-title-input';
    
    inputGroup.appendChild(urlInput);
    altRow.appendChild(inputGroup);
    altRow.appendChild(titleInput);
    
    activitySection.insertBefore(altRow, button);
    
    // Add event listener for URL input to show preview link
    urlInput.addEventListener('input', function() {
      updateStats();
      const previewLink = inputGroup.querySelector('.workout-preview-link');
      if (this.value.trim()) {
        if (previewLink) {
          previewLink.href = this.value.trim();
        } else {
          const link = document.createElement('a');
          link.href = this.value.trim();
          link.target = '_blank';
          link.className = 'workout-preview-link';
          link.title = 'Preview workout';
          link.textContent = 'üîó';
          inputGroup.appendChild(link);
        }
      } else if (previewLink) {
        previewLink.remove();
      }
    });
  };

document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('workout-assignment-form');
  const urlInputs = form.querySelectorAll('.workout-url-input');
  
  // Update stats function
  function updateStats() {
    let totalNeeded = 0;
    let totalAssigned = 0;
    const weekStats = {};
    
    // Get currently visible template
    const visibleTemplate = document.querySelector('.template-content:not(.hidden)');
    const visibleTemplateId = visibleTemplate ? visibleTemplate.dataset.templateId : null;
    
    urlInputs.forEach(input => {
      // Only count inputs from visible template if tabs are active
      if (visibleTemplateId && input.dataset.template !== visibleTemplateId) {
        return;
      }
      
      const week = input.dataset.week;
      const template = input.dataset.template;
      const key = `${template}_${week}`;
      
      if (!weekStats[key]) {
        weekStats[key] = { needed: 0, assigned: 0 };
      }
      
      weekStats[key].needed++;
      totalNeeded++;
      
      if (input.value.trim()) {
        weekStats[key].assigned++;
        totalAssigned++;
        
        // Update input visual state
        input.classList.add('has-value');
        const dayCard = input.closest('.workout-day-card');
        if (dayCard) {
          dayCard.classList.add('workout-day-has-assignment');
        }
        
        // Show preview link if not exists
        const inputGroup = input.closest('.workout-input-group');
        if (inputGroup && !inputGroup.querySelector('.workout-preview-link')) {
          const link = document.createElement('a');
          link.href = input.value.trim();
          link.target = '_blank';
          link.className = 'workout-preview-link';
          link.title = 'Preview workout';
          link.textContent = 'üîó';
          inputGroup.appendChild(link);
        }
      } else {
        input.classList.remove('has-value');
        const dayCard = input.closest('.workout-day-card');
        if (dayCard) {
          // Check if any other inputs in this day have values
          const hasAnyValue = Array.from(dayCard.querySelectorAll('.workout-url-input')).some(inp => inp.value.trim());
          if (!hasAnyValue) {
            dayCard.classList.remove('workout-day-has-assignment');
          }
        }
        
        // Remove preview link
        const inputGroup = input.closest('.workout-input-group');
        const previewLink = inputGroup?.querySelector('.workout-preview-link');
        if (previewLink) {
          previewLink.remove();
        }
      }
    });
    
    // Update global stats
    document.getElementById('totalNeeded').textContent = totalNeeded;
    document.getElementById('totalAssigned').textContent = totalAssigned;
    document.getElementById('totalMissing').textContent = totalNeeded - totalAssigned;
    
    // Update week stats
    Object.keys(weekStats).forEach(key => {
      const [template, week] = key.split('_');
      const weekSection = document.querySelector(`[data-week="${week}"][data-template="${template}"]`);
      if (weekSection) {
        const assignedEl = weekSection.querySelector(`.week-stat-assigned[data-week="${week}"][data-template="${template}"]`);
        const totalEl = weekSection.querySelector(`.week-stat-total[data-week="${week}"][data-template="${template}"]`);
        if (assignedEl) assignedEl.textContent = weekStats[key].assigned;
        if (totalEl) totalEl.textContent = weekStats[key].needed;
      }
    });
    
    // Update save button
    const saveButtonStats = document.getElementById('saveButtonStats');
    if (saveButtonStats) {
      if (totalAssigned === totalNeeded) {
        saveButtonStats.textContent = '(Complete)';
        saveButtonStats.style.color = 'var(--accent)';
      } else {
        saveButtonStats.textContent = `(${totalAssigned}/${totalNeeded})`;
        saveButtonStats.style.color = 'var(--primary)';
      }
    }
  }
  
  // Update preview link when URL changes
  urlInputs.forEach(input => {
    input.addEventListener('input', function() {
      const inputGroup = this.closest('.workout-input-group');
      const previewLink = inputGroup?.querySelector('.workout-preview-link');
      
      if (this.value.trim()) {
        if (previewLink) {
          previewLink.href = this.value.trim();
        } else {
          const link = document.createElement('a');
          link.href = this.value.trim();
          link.target = '_blank';
          link.className = 'workout-preview-link';
          link.title = 'Preview workout';
          link.textContent = 'üîó';
          inputGroup.appendChild(link);
        }
      } else if (previewLink) {
        previewLink.remove();
      }
      
      updateStats();
    });
  });
  
  // Collapsible weeks
  document.querySelectorAll('.workout-week-toggle').forEach(toggle => {
    toggle.addEventListener('click', function() {
      const week = this.dataset.week;
      const template = this.dataset.template;
      let contentId;
      
      // Check if this is a bonus workout (no template attribute)
      if (!template) {
        contentId = `bonus-week-${week}-content`;
      } else {
        contentId = `week-${template}-${week}-content`;
      }
      
      const content = document.getElementById(contentId);
      if (content) {
        content.classList.toggle('collapsed');
        this.classList.toggle('collapsed');
      }
    });
  });
  
  // Template tab switching
  window.switchTemplate = function(templateId) {
    // Hide all template contents
    document.querySelectorAll('.template-content').forEach(content => {
      content.classList.add('hidden');
    });
    
    // Show selected template
    const selectedContent = document.querySelector(`.template-content[data-template-id="${templateId}"]`);
    if (selectedContent) {
      selectedContent.classList.remove('hidden');
    }
    
    // Update tab states
    document.querySelectorAll('.workout-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    const selectedTab = document.querySelector(`.workout-tab[data-template-id="${templateId}"]`);
    if (selectedTab) {
      selectedTab.classList.add('active');
    }
    
    // Update stats for visible template
    updateStats();
  };
  
  // AJAX save function
  window.saveWorkouts = function() {
    const form = document.getElementById('workout-assignment-form');
    const formData = new FormData(form);
    const saveButton = document.getElementById('saveButton');
    const originalText = saveButton.innerHTML;
    
    // Disable button and show loading state
    saveButton.disabled = true;
    saveButton.innerHTML = '<span>Saving...</span>';
    
    // Validate duplicates first
    const urlInputs = form.querySelectorAll('.workout-url-input');
    const weekGroups = {};
    
    urlInputs.forEach(input => {
      if (input.value.trim()) {
        const template = input.dataset.template;
        const week = input.dataset.week;
        const key = `${template}_${week}`;
        
        if (!weekGroups[key]) {
          weekGroups[key] = [];
        }
        
        weekGroups[key].push({
          url: input.value.trim().toLowerCase(),
          activity: input.dataset.activity,
          day: input.dataset.day,
          input: input
        });
      }
    });
    
    // Check for duplicates
    let hasDuplicates = false;
    let duplicateMessage = '';
    
    Object.keys(weekGroups).forEach(key => {
      const urls = weekGroups[key].map(item => item.url);
      const uniqueUrls = new Set(urls);
      
      if (urls.length !== uniqueUrls.size) {
        hasDuplicates = true;
        const [template, week] = key.split('_');
        duplicateMessage += `Week ${week}: Duplicate workout URLs found. Each day should have a different workout.\n`;
        
        // Highlight duplicate inputs
        weekGroups[key].forEach(item => {
          if (urls.filter(u => u === item.url).length > 1) {
            item.input.style.borderColor = 'var(--primary)';
            item.input.style.boxShadow = '0 0 0 2px rgba(255, 107, 107, 0.3)';
          }
        });
      }
    });
    
    if (hasDuplicates) {
      alert(duplicateMessage || 'Duplicate workouts found. Each day should have a different workout.');
      saveButton.disabled = false;
      saveButton.innerHTML = originalText;
      
      // Remove highlighting after 3 seconds
      setTimeout(() => {
        urlInputs.forEach(input => {
          input.style.borderColor = '';
          input.style.boxShadow = '';
        });
      }, 3000);
      
      return;
    }
    
    // Submit via AJAX
    fetch(form.action || window.location.href, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
      credentials: 'same-origin'
    })
    .then(response => {
      // Check if response is JSON (AJAX) or HTML (redirect)
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        return response.json();
      } else {
        // HTML response - check if redirected
        if (response.redirected || response.ok) {
          return { success: true, redirected: true, url: response.url };
        }
        return response.text().then(text => ({ success: false, html: text }));
      }
    })
    .then(data => {
      if (data.success) {
        if (data.redirected) {
          // Redirect to show success message
          window.location.href = data.url || "{% url 'tracker:admin_challenges_list' %}";
        } else {
          // JSON response - show success message
          const message = data.message || `Workout assignments saved! (${data.created || 0} created, ${data.updated || 0} updated)`;
          
          // Show success notification
          showNotification(message, 'success');
          
          // Update stats
          updateStats();
          
          // Re-enable button
          saveButton.disabled = false;
          saveButton.innerHTML = originalText;
        }
      } else {
        throw new Error('Save failed');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while saving. Please try again.');
      saveButton.disabled = false;
      saveButton.innerHTML = originalText;
    });
  };
  
  // Simple notification function
  function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      background: ${type === 'success' ? 'var(--accent)' : 'var(--primary)'};
      color: var(--dark);
      border-radius: 0;
      font-weight: 700;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  // Add CSS animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);
  
  // Validate no duplicate URLs within a week (keep for form fallback)
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    saveWorkouts();
    return false;
    const weekGroups = {};
    
    urlInputs.forEach(input => {
      if (input.value.trim()) {
        const template = input.dataset.template;
        const week = input.dataset.week;
        const key = `${template}_${week}`;
        
        if (!weekGroups[key]) {
          weekGroups[key] = [];
        }
        
        weekGroups[key].push({
          url: input.value.trim().toLowerCase(),
          activity: input.dataset.activity,
          day: input.dataset.day,
          input: input
        });
      }
    });
    
    // Check for duplicates within each week
    let hasDuplicates = false;
    let duplicateMessage = '';
    
    Object.keys(weekGroups).forEach(key => {
      const urls = weekGroups[key].map(item => item.url);
      const uniqueUrls = new Set(urls);
      
      if (urls.length !== uniqueUrls.size) {
        hasDuplicates = true;
        const duplicates = urls.filter((url, index) => urls.indexOf(url) !== index);
        const [template, week] = key.split('_');
        duplicateMessage += `Week ${week}: Duplicate workout URLs found. Each day should have a different workout.\n`;
        
        // Highlight duplicate inputs
        weekGroups[key].forEach(item => {
          if (duplicates.includes(item.url)) {
            item.input.style.borderColor = 'var(--primary)';
            item.input.style.boxShadow = '0 0 0 2px rgba(255, 107, 107, 0.3)';
          }
        });
      }
    });
    
    if (hasDuplicates) {
      e.preventDefault();
      alert(duplicateMessage || 'Duplicate workouts found. Each day should have a different workout.');
      
      // Remove highlighting after 3 seconds
      setTimeout(() => {
        urlInputs.forEach(input => {
          input.style.borderColor = '';
          input.style.boxShadow = '';
        });
      }, 3000);
      
      return false;
    }
  });
  
  // Initial stats update
  updateStats();
});
</script>
{% endblock %}
