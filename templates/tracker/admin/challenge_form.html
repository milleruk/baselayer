{% extends "base.html" %}
{% load dict_filters %}
{% block title %}Admin - {% if form_action == 'create' %}Create{% else %}Edit{% endif %} Challenge{% endblock %}

{% block content %}
<div class="dashboard-header" style="padding-bottom: 1.5rem;">
  <div>
    <h1>{% if form_action == 'create' %}Create{% else %}Edit{% endif %} Challenge</h1>
    <p style="color: var(--text-muted); margin-top: 0.5rem;">
      {% if form_action == 'create' %}
        Create a new challenge with dates, templates, and settings
      {% else %}
        Update challenge details and configuration
      {% endif %}
    </p>
  </div>
</div>

<form method="post" enctype="multipart/form-data" class="challenge-form">
  {% csrf_token %}
  
  <div class="challenge-form-grid">
    <!-- Left Column: Main Content -->
    <div class="challenge-form-main">
      <!-- Basic Information -->
      <div class="form-section">
        <div class="form-section-header">
          <h2>Basic Information</h2>
        </div>
        <div class="form-section-content">
          <div class="form-row">
            <div class="form-group full-width">
              <label>Challenge Name *</label>
              <input type="text" name="name" value="{% if challenge %}{{ challenge.name }}{% endif %}" required
                     placeholder="e.g., Foundation Builder">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group full-width">
              <label>Description</label>
              <textarea name="description" rows="3" placeholder="Describe the challenge goals and structure...">{% if challenge %}{{ challenge.description }}{% endif %}</textarea>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Challenge Type</label>
              <select name="challenge_type">
                <option value="mini" {% if challenge and challenge.challenge_type == 'mini' %}selected{% endif %}>Mini Challenge</option>
                <option value="team" {% if challenge and challenge.challenge_type == 'team' %}selected{% endif %}>Team Challenge</option>
                <option value="individual" {% if challenge and challenge.challenge_type == 'individual' %}selected{% endif %}>Individual Challenge</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Categories</label>
              <input type="text" name="categories" value="{% if challenge %}{{ challenge.categories }}{% endif %}"
                     placeholder="cycling, running, strength, yoga">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Time Period -->
      <div class="form-section">
        <div class="form-section-header">
          <h2>Time Period</h2>
          <p class="form-section-subtitle">Challenges cannot overlap. Signup deadline must be before start date.</p>
        </div>
        <div class="form-section-content">
          <div class="form-row">
            <div class="form-group">
              <label>Start Date *</label>
              <input type="date" name="start_date" value="{% if challenge %}{{ challenge.start_date|date:'Y-m-d' }}{% endif %}" required>
            </div>
            
            <div class="form-group">
              <label>End Date *</label>
              <input type="date" name="end_date" value="{% if challenge %}{{ challenge.end_date|date:'Y-m-d' }}{% endif %}" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Signup Opens Date</label>
              <input type="date" name="signup_opens_date" value="{% if challenge and challenge.signup_opens_date %}{{ challenge.signup_opens_date|date:'Y-m-d' }}{% endif %}">
              <small>When users can start signing up (defaults to start date)</small>
            </div>
            
            <div class="form-group">
              <label>Signup Deadline</label>
              <input type="date" name="signup_deadline" value="{% if challenge and challenge.signup_deadline %}{{ challenge.signup_deadline|date:'Y-m-d' }}{% endif %}">
              <small>Last date users can sign up</small>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Plan Templates -->
      <div class="form-section">
        <div class="form-section-header">
          <h2>Plan Templates</h2>
          <p class="form-section-subtitle">Select which plan templates are available for this challenge. Users will choose from these when joining.</p>
        </div>
        <div class="form-section-content">
          <div class="form-group full-width">
            <label>Available Templates *</label>
            <div class="template-checkbox-grid">
              {% for template in templates %}
                <label class="template-checkbox-item">
                  <input type="checkbox" name="available_templates" value="{{ template.id }}"
                         {% if challenge and template in challenge.available_templates.all %}checked{% endif %}>
                  <span>{{ template.name }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
          
          <div class="form-group full-width">
            <label>Default Template (Recommended)</label>
            <select name="default_template">
              <option value="">None</option>
              {% for template in templates %}
                <option value="{{ template.id }}" {% if challenge and challenge.default_template == template %}selected{% endif %}>{{ template.name }}</option>
              {% endfor %}
            </select>
            <small>This template will be marked as "RECOMMENDED" when users join.</small>
          </div>
        </div>
      </div>
      
      <!-- Week Unlock Control -->
      {% if challenge %}
      <div class="form-section">
        <div class="form-section-header">
          <h2>Week Unlock Control</h2>
          <p class="form-section-subtitle">Control which weeks are live/unlocked. Users can only access unlocked weeks to prevent completing challenges too quickly.</p>
        </div>
        <div class="form-section-content">
          <div class="week-unlock-grid">
            {% for week_num in challenge.week_range %}
              {% with unlock=week_unlocks|get_item:week_num %}
              <div class="week-unlock-card">
                <div class="week-unlock-header">
                  <label class="week-unlock-label">
                    <input type="checkbox" name="week_unlocked_{{ week_num }}" value="1" class="week-unlock-checkbox" {% if unlock and unlock.is_unlocked %}checked{% endif %}>
                    <span class="week-number">Week {{ week_num }}</span>
                  </label>
                  <span class="week-status-badge {% if unlock and unlock.is_unlocked %}unlocked{% else %}locked{% endif %}">
                    {% if unlock and unlock.is_unlocked %}Unlocked{% else %}Locked{% endif %}
                  </span>
                </div>
                <div class="week-unlock-date-field">
                  <label>Auto-unlock Date <small>(optional)</small></label>
                  <input type="date" name="week_unlock_date_{{ week_num }}" class="week-unlock-date"
                         value="{% if unlock and unlock.unlock_date %}{{ unlock.unlock_date|date:'Y-m-d' }}{% endif %}">
                </div>
              </div>
              {% endwith %}
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    
    <!-- Right Column: Sidebar -->
    <div class="challenge-form-sidebar">
      <!-- Status & Visibility -->
      <div class="form-section">
        <div class="form-section-header">
          <h2>Status & Visibility</h2>
        </div>
        <div class="form-section-content">
          <div class="form-checkbox-item">
            <label>
              <input type="checkbox" name="is_active" {% if not challenge or challenge.is_active %}checked{% endif %}>
              <div>
                <span class="checkbox-label">Active</span>
                <small>Active challenges are included in overlap validation and can be joined by users.</small>
              </div>
            </label>
          </div>
          
          <div class="form-checkbox-item">
            <label>
              <input type="checkbox" name="is_visible" {% if not challenge or challenge.is_visible %}checked{% endif %}>
              <div>
                <span class="checkbox-label">Visible</span>
                <small>Visible challenges appear in the challenges list for users to join.</small>
              </div>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Challenge Image -->
      <div class="form-section">
        <div class="form-section-header">
          <h2>Challenge Image</h2>
        </div>
        <div class="form-section-content">
          {% if challenge and challenge.image %}
            <div class="current-image-preview">
              <div class="image-label">Current Image:</div>
              <img src="{{ challenge.image.url }}" alt="{{ challenge.name }}">
            </div>
          {% endif %}
          
          <div class="form-group full-width">
            <label>Upload New Image</label>
            <input type="file" name="image" accept="image/*" class="file-input">
          </div>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="form-actions">
        <a href="{% url 'tracker:admin_challenges_list' %}" class="btn btn-outline-light">Cancel</a>
        {% if form_action == 'edit' and challenge.available_templates.exists %}
          <a href="{% url 'tracker:admin_assign_workouts' challenge.id %}" class="btn btn-secondary">ðŸš´ Assign Workouts</a>
        {% endif %}
        <button type="submit" class="btn btn-accent">{% if form_action == 'create' %}Create{% else %}Update{% endif %} Challenge</button>
      </div>
    </div>
  </div>
</form>

<style>
.challenge-form {
  max-width: 1400px;
  margin: 0 auto;
}

.challenge-form-grid {
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 2rem;
  align-items: start;
}

.challenge-form-main {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.challenge-form-sidebar {
  position: sticky;
  top: 90px;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.form-section {
  background: var(--dark-light);
  border: 1px solid var(--border);
  border-radius: 0;
  overflow: hidden;
}

.form-section-header {
  padding: 1.25rem 1.5rem;
  background: rgba(78, 205, 196, 0.1);
  border-bottom: 1px solid var(--border);
}

.form-section-header h2 {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
  margin: 0;
}

.form-section-subtitle {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin: 0.5rem 0 0 0;
}

.form-section-content {
  padding: 1.5rem;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.form-row:last-child {
  margin-bottom: 0;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--text);
}

.form-group small {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

.form-group input[type="text"],
.form-group input[type="date"],
.form-group select,
.form-group textarea {
  padding: 0.75rem;
  background: var(--dark);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 0.95rem;
  transition: border-color 0.3s;
}

.form-group input[type="text"]:focus,
.form-group input[type="date"]:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--accent);
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.template-checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 0.75rem;
  max-height: 300px;
  overflow-y: auto;
  padding: 1rem;
  background: var(--dark);
  border: 1px solid var(--border);
}

.template-checkbox-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--dark-light);
  transition: all 0.3s;
}

.template-checkbox-item:hover {
  border-color: var(--accent);
  background: rgba(78, 205, 196, 0.1);
}

.template-checkbox-item input[type="checkbox"] {
  cursor: pointer;
}

.week-unlock-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
}

.week-unlock-card {
  padding: 1.25rem;
  background: var(--dark);
  border: 1px solid var(--border);
  border-radius: 0;
  transition: all 0.3s;
}

.week-unlock-card:hover {
  border-color: var(--accent);
}

.week-unlock-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
}

.week-unlock-label {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  cursor: pointer;
  flex: 1;
}

.week-unlock-label input[type="checkbox"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
}

.week-number {
  font-weight: 700;
  font-size: 1rem;
  color: var(--text);
}

.week-status-badge {
  padding: 0.35rem 0.85rem;
  font-size: 0.75rem;
  font-weight: 700;
  border-radius: 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.week-status-badge.locked {
  background: var(--primary);
  color: var(--dark);
}

.week-status-badge.unlocked {
  background: var(--accent);
  color: var(--dark);
}

.week-unlock-date-field {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.week-unlock-date-field label {
  font-size: 0.85rem;
  color: var(--text-muted);
  font-weight: 600;
}

.week-unlock-date-field small {
  font-weight: normal;
  opacity: 0.7;
}

.week-unlock-date-field input[type="date"] {
  padding: 0.5rem;
  background: var(--dark-light);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 0.85rem;
}

.form-checkbox-item {
  margin-bottom: 1rem;
}

.form-checkbox-item:last-child {
  margin-bottom: 0;
}

.form-checkbox-item label {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  cursor: pointer;
}

.form-checkbox-item input[type="checkbox"] {
  margin-top: 0.25rem;
  cursor: pointer;
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}

.form-checkbox-item .checkbox-label {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--text);
  display: block;
  margin-bottom: 0.25rem;
}

.form-checkbox-item small {
  font-size: 0.75rem;
  color: var(--text-muted);
  display: block;
  line-height: 1.4;
}

.current-image-preview {
  margin-bottom: 1rem;
}

.image-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.current-image-preview img {
  max-width: 100%;
  max-height: 200px;
  border: 1px solid var(--border);
  display: block;
}

.file-input {
  padding: 0.75rem;
  background: var(--dark);
  border: 1px solid var(--border);
  color: var(--text);
  cursor: pointer;
}

.form-actions {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.form-actions .btn {
  width: 100%;
  justify-content: center;
}

.btn-secondary {
  background: rgba(78, 205, 196, 0.2);
  border-color: var(--secondary);
  color: var(--secondary);
}

.btn-secondary:hover {
  background: rgba(78, 205, 196, 0.3);
}

@media (max-width: 1024px) {
  .challenge-form-grid {
    grid-template-columns: 1fr;
  }
  
  .challenge-form-sidebar {
    position: static;
  }
}

@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .week-unlock-grid {
    grid-template-columns: 1fr;
  }
  
  .template-checkbox-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Update status badge when checkbox changes
  document.querySelectorAll('.week-unlock-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const card = this.closest('.week-unlock-card');
      const badge = card.querySelector('.week-status-badge');
      if (this.checked) {
        badge.textContent = 'Unlocked';
        badge.classList.remove('locked');
        badge.classList.add('unlocked');
      } else {
        badge.textContent = 'Locked';
        badge.classList.remove('unlocked');
        badge.classList.add('locked');
      }
    });
  });
});
</script>
{% endblock %}
