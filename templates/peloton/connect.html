{% extends "base.html" %}
{% block title %}Connect Peloton{% endblock %}
{% block page_title %}Connect Peloton Account{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Connect Peloton Account</h1>
  <p class="text-gray-600 dark:text-gray-400">Link your Peloton account to sync your workout data</p>
</div>

<div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
  <form method="post" class="space-y-6">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
      <div class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
        {% for error in form.non_field_errors %}
          <p class="text-sm text-red-800 dark:text-red-200">{{ error }}</p>
        {% endfor %}
      </div>
    {% endif %}
    
    <!-- Learn More Section -->
    <details class="mb-6 p-4 bg-gray-50 dark:bg-gray-900/30 border border-gray-200 dark:border-gray-700 rounded-lg">
      <summary class="cursor-pointer text-blue-600 dark:text-blue-400 font-medium hover:text-blue-800 dark:hover:text-blue-300 flex items-center gap-2">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>
        <span>How does the secure connection work? (Click to learn more)</span>
      </summary>
      <div class="mt-4 pl-7 space-y-4">
        <div class="border-l-2 border-blue-200 dark:border-blue-800 pl-4">
          <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">ðŸ”’ Secure OAuth2 Authentication</h4>
          <ul class="text-sm text-gray-700 dark:text-gray-300 space-y-2 list-disc list-inside">
            <li><strong>OAuth2 Protocol:</strong> We use Peloton's official OAuth2 protocol (the same technology used by banks and major apps)</li>
            <li><strong>Your Password Stays Private:</strong> Your credentials are sent directly to Peloton's servers, not stored by us</li>
            <li><strong>Encrypted Tokens:</strong> We only store encrypted access tokens that allow us to fetch your workout data</li>
            <li><strong>You Stay in Control:</strong> You can disconnect your account at any time</li>
          </ul>
        </div>
        
        <div class="border-l-2 border-green-200 dark:border-green-800 pl-4">
          <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">ðŸ“‹ What Happens When You Connect:</h4>
          <ol class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
            <li><strong>Step 1:</strong> You enter your Peloton username and password below</li>
            <li><strong>Step 2:</strong> We securely authenticate with Peloton's OAuth2 API (same as the mobile app uses)</li>
            <li><strong>Step 3:</strong> Peloton sends us an encrypted access token (not your password)</li>
            <li><strong>Step 4:</strong> We use this token to sync your workouts automatically</li>
          </ol>
        </div>
      </div>
    </details>
    
    <!-- Security Disclaimer -->
    <div class="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg mb-6">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>
        <div>
          <h3 class="text-sm font-semibold text-blue-900 dark:text-blue-200 mb-1">Security & Privacy</h3>
          <p class="text-sm text-blue-800 dark:text-blue-300 leading-relaxed">
            Your username and password are <strong>not stored</strong> on our servers. We use them only to securely authenticate with Peloton's API and obtain an access token. All communication with Peloton's API is encrypted via HTTPS. Your workout data is then stored locally in your account. You can disconnect your account at any time.
          </p>
        </div>
      </div>
    </div>
    
    <!-- Username/Password Fields -->
    <div>
      <label for="{{ form.username.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        {{ form.username.label }}
      </label>
      <input 
        type="text" 
        name="{{ form.username.name }}" 
        id="{{ form.username.id_for_label }}"
        value="{{ form.username.value|default:'' }}"
        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter your Peloton username or email"
        required
      >
      {% if form.username.help_text %}
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.username.help_text }}</p>
      {% endif %}
      {% if form.username.errors %}
        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.username.errors.0 }}</p>
      {% endif %}
    </div>
    
    <div>
      <label for="{{ form.password.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        {{ form.password.label }}
      </label>
      <input 
        type="password" 
        name="{{ form.password.name }}" 
        id="{{ form.password.id_for_label }}"
        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter your Peloton password"
        required
      >
      {% if form.password.help_text %}
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.password.help_text }}</p>
      {% endif %}
      {% if form.password.errors %}
        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.password.errors.0 }}</p>
      {% endif %}
    </div>
    
    <div class="flex gap-4">
      <button 
        type="submit" 
        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors"
      >
        Connect Account
      </button>
      <a 
        href="{% url 'peloton:status' %}" 
        class="px-6 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-medium rounded-lg transition-colors"
      >
        Cancel
      </a>
    </div>
  </form>
  
  {% if connection and connection.is_active %}
    <div class="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
      <p class="text-sm text-yellow-800 dark:text-yellow-200">
        <strong>Note:</strong> Connecting a new account will replace your existing Peloton connection.
      </p>
    </div>
  {% endif %}
</div>
{% endblock %}
