{% extends "base_app.html" %}
{% load medal_tags %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}

{% block content %}

<style>
  /* Subtle page polish without touching your URLs/logic */
  @keyframes ctZFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-2px); }
  }
  @keyframes ctZShimmer {
    0% { transform: translateX(-120%); opacity: .0; }
    20% { opacity: .35; }
    60% { opacity: .15; }
    100% { transform: translateX(120%); opacity: 0; }
  }
  .ctz-card {
    border-radius: 1rem;
    border: 1px solid rgb(229 231 235);
    background: rgb(255 255 255);
    box-shadow: 0 1px 2px rgba(0,0,0,.05);
  }
  .dark .ctz-card {
    border-color: rgb(55 65 81);
    background: rgb(31 41 55);
    box-shadow: 0 1px 2px rgba(0,0,0,.35);
  }
  .ctz-glow {
    position: relative;
    overflow: hidden;
  }
  .ctz-glow::after{
    content:"";
    position:absolute;
    inset:-40%;
    background:
      radial-gradient(circle at 30% 30%, rgba(59,130,246,.18), transparent 55%),
      radial-gradient(circle at 80% 20%, rgba(236,72,153,.10), transparent 55%),
      radial-gradient(circle at 60% 80%, rgba(34,197,94,.10), transparent 55%);
    pointer-events:none;
  }
  .ctz-shimmer::before{
    content:"";
    position:absolute;
    top:-40%;
    bottom:-40%;
    width:40%;
    left:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
    transform: translateX(-120%);
    animation: ctZShimmer 4.5s ease-in-out infinite;
    pointer-events:none;
  }
  .dark .ctz-shimmer::before{
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
  }
  .ctz-chip {
    display:inline-flex;
    align-items:center;
    gap:.5rem;
    padding:.25rem .6rem;
    border-radius: 999px;
    border: 1px solid rgb(229 231 235);
    background: rgb(249 250 251);
    font-size: .75rem;
    font-weight: 600;
    color: rgb(55 65 81);
  }
  .dark .ctz-chip{
    border-color: rgb(55 65 81);
    background: rgba(255,255,255,.04);
    color: rgba(255,255,255,.85);
  }
  .ctz-btn-press {
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .ctz-btn-press:hover { transform: translateY(-1px); }
  .ctz-btn-press:active { transform: translateY(0px); }
  .ctz-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(0,0,0,.08), transparent);
  }
  .dark .ctz-divider {
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
  }

  /* Make Chart canvases look intentional even before render */
  .ctz-chart-wrap {
    border-radius: 1rem;
    border: 1px solid rgb(229 231 235);
    background: rgba(255,255,255,.65);
    backdrop-filter: blur(6px);
  }
  .dark .ctz-chart-wrap {
    border-color: rgb(55 65 81);
    background: rgba(17,24,39,.35);
  }

  /* Small HTMX loading flourish */
  .ctz-loading {
    opacity: .0;
    transform: translateY(-2px);
    transition: opacity .2s ease, transform .2s ease;
  }
  .htmx-request .ctz-loading {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<!-- Time Period Filter & Refresh Controls -->
<div class="ctz-card ctz-glow ctz-shimmer relative p-4 sm:p-5 mb-6">
  <div class="relative z-10 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">

    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
      <div class="flex items-center gap-2">
        <span class="ctz-chip">
          <span aria-hidden="true">‚è±Ô∏è</span>
          Time Period
        </span>
        <span class="text-xs text-gray-500 dark:text-gray-400 hidden sm:inline">
          Pick a window and we‚Äôll do the math.
        </span>
      </div>

      <div class="-mx-2 sm:mx-0 overflow-x-auto">
        <div class="inline-flex rounded-xl border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-800/70 p-1 whitespace-nowrap shadow-sm">
          <button
            hx-get="{% url 'core:dashboard' %}?period=7d"
            hx-target="#dashboard-content"
            hx-swap="innerHTML"
            hx-indicator="#refresh-indicator"
            hx-push-url="true"
            class="period-filter ctz-btn-press px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold rounded-lg transition-colors {% if selected_period == '7d' %}bg-primary text-white shadow{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100/80 dark:hover:bg-gray-700/60{% endif %}"
            data-period="7d"
          >
            Last 7 Days
          </button>
          <button
            hx-get="{% url 'core:dashboard' %}?period=30d"
            hx-target="#dashboard-content"
            hx-swap="innerHTML"
            hx-indicator="#refresh-indicator"
            hx-push-url="true"
            class="period-filter ctz-btn-press px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold rounded-lg transition-colors {% if selected_period == '30d' %}bg-primary text-white shadow{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100/80 dark:hover:bg-gray-700/60{% endif %}"
            data-period="30d"
          >
            Last 30 Days
          </button>
          <button
            hx-get="{% url 'core:dashboard' %}?period=90d"
            hx-target="#dashboard-content"
            hx-swap="innerHTML"
            hx-indicator="#refresh-indicator"
            hx-push-url="true"
            class="period-filter ctz-btn-press px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold rounded-lg transition-colors {% if selected_period == '90d' %}bg-primary text-white shadow{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100/80 dark:hover:bg-gray-700/60{% endif %}"
            data-period="90d"
          >
            Last 90 Days
          </button>
          <button
            hx-get="{% url 'core:dashboard' %}?period=all"
            hx-target="#dashboard-content"
            hx-swap="innerHTML"
            hx-indicator="#refresh-indicator"
            hx-push-url="true"
            class="period-filter ctz-btn-press px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold rounded-lg transition-colors {% if selected_period == 'all' %}bg-primary text-white shadow{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100/80 dark:hover:bg-gray-700/60{% endif %}"
            data-period="all"
          >
            All Time
          </button>
        </div>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row sm:items-center gap-3">
      <!-- Lightweight ‚Äúloading‚Äù hint (auto shows on HTMX request via CSS above) -->
      <div class="ctz-loading hidden lg:flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
        <span class="inline-block w-2 h-2 rounded-full bg-primary" style="animation: ctZFloat 1.6s ease-in-out infinite;"></span>
        Updating stats‚Ä¶
      </div>

      <!-- Refresh Button -->
      <button
        hx-get="{% url 'core:dashboard' %}?period={{ selected_period }}"
        hx-target="#dashboard-content"
        hx-swap="innerHTML"
        hx-indicator="#refresh-indicator"
        class="ctz-btn-press inline-flex items-center justify-center gap-2 px-3 sm:px-4 py-2 bg-white/90 dark:bg-gray-800/70 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/60 transition-colors w-full sm:w-auto shadow-sm"
        title="Refresh dashboard"
      >
        <svg id="refresh-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span class="hidden sm:inline font-semibold">Refresh</span>
        <svg id="refresh-indicator" class="htmx-indicator w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Dashboard Content Container -->
<div id="dashboard-content">

  <!-- Active Challenge Banner - Top of Page -->
  {% if active_challenge_instance %}
  <div class="rounded-2xl border-2 border-yellow-400/50 dark:border-yellow-500/50 bg-gradient-to-r from-gray-800 to-gray-900 dark:from-gray-900 dark:to-gray-800 p-6 mb-6 shadow-2xl relative overflow-hidden">
    <!-- Glowing border effect -->
    <div class="absolute inset-0 rounded-2xl border-2 border-yellow-400/30 dark:border-yellow-500/30 shadow-[0_0_26px_rgba(250,204,21,0.32)]"></div>

    <!-- Extra subtle sparkles -->
    <div class="absolute -top-10 -right-10 w-40 h-40 bg-yellow-400/10 rounded-full blur-2xl"></div>
    <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-yellow-400/10 rounded-full blur-2xl"></div>

    <div class="relative z-10 flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
      <div class="flex items-start gap-4 flex-1 min-w-0">
        <!-- Challenge Icon/Image -->
        <div class="flex-shrink-0">
          {% if active_challenge_instance.challenge.image %}
            <img src="{{ active_challenge_instance.challenge.image.url }}" alt="{{ active_challenge_instance.challenge.name }}" class="w-16 h-16 rounded-xl object-cover border-2 border-yellow-400/50 shadow-lg">
          {% else %}
            <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center text-2xl border-2 border-yellow-400/50 shadow-lg">
              üèÜ
            </div>
          {% endif %}
        </div>

        <!-- Challenge Info -->
        <div class="flex-1 min-w-0">
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <span class="px-2.5 py-1 text-xs font-bold text-yellow-300 bg-yellow-400/10 border border-yellow-400/30 rounded-lg uppercase tracking-wide">
              SIGNED UP AND READY TO GO
            </span>
            <span class="text-xs text-gray-300/80">Keep it spicy. Consistency wins. üòâ</span>
          </div>

          <h2 class="text-2xl md:text-3xl font-bold text-white mb-2 truncate">{{ active_challenge_instance.challenge.name }}</h2>

          {% if team_info %}
            <p class="text-sm text-gray-300 mb-1">You're on team: <span class="font-semibold text-yellow-300">{{ team_info.name }}</span></p>
          {% elif active_challenge_instance.challenge.challenge_type %}
            <p class="text-sm text-gray-300 mb-1">{{ active_challenge_instance.challenge.challenge_type|title }} Challenge</p>
          {% endif %}

          <div class="grid grid-cols-2 sm:flex sm:flex-wrap items-center gap-3 mt-3">
            <div class="flex items-center gap-2 bg-white/5 border border-white/10 rounded-lg px-3 py-2">
              <span class="text-xs text-gray-300">Progress</span>
              <span class="text-sm font-semibold text-yellow-300">{{ active_challenge_instance.completion_rate|floatformat:0 }}%</span>
            </div>
            <div class="flex items-center gap-2 bg-white/5 border border-white/10 rounded-lg px-3 py-2">
              <span class="text-xs text-gray-300">Points</span>
              <span class="text-sm font-semibold text-yellow-300">{{ active_challenge_instance.total_points }}</span>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="mt-4 w-full bg-gray-700/50 rounded-full h-2.5 overflow-hidden">
            <div class="bg-yellow-400 h-2.5 rounded-full transition-all duration-300" style="width: {{ active_challenge_instance.completion_rate }}%"></div>
          </div>
        </div>
      </div>

      <!-- Right side: actions + toggle (kept in the banner but visually tidy) -->
      <div class="flex-shrink-0 w-full lg:w-auto">
        <div class="flex flex-col sm:flex-row lg:flex-col gap-2">
          {% if team_info %}
            <a href="{% url 'challenges:team_admin' team_info.id %}" class="ctz-btn-press inline-flex items-center justify-center px-6 py-3 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl">
              View Team Page
              <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </a>
          {% endif %}
          <a href="{% url 'challenges:challenge_detail' active_challenge_instance.challenge.id %}" class="ctz-btn-press inline-flex items-center justify-center px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-xl transition-all duration-200">
            View Challenge
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>

          <!-- Hide Manual Workouts Toggle (same logic, nicer wrap) -->
          <div class="mt-2 lg:mt-3 flex items-center justify-between gap-3 rounded-xl bg-white/5 border border-white/10 px-4 py-3">
            <div class="min-w-0">
              <div class="text-sm font-semibold text-white">Hide Manual Workouts</div>
              <div class="text-xs text-gray-300/80">Keep charts ‚Äúclean‚Äù (or hide the guilty entries).</div>
            </div>

            <label class="relative inline-flex items-center cursor-pointer">
              <input
                id="hide-manual-toggle"
                type="checkbox"
                class="sr-only peer"
                {% if request.GET.hide_manual == '1' %}checked{% endif %}
                onchange="toggleHideManual(this)"
              />
              <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:bg-yellow-400/80 transition-colors"></div>
              <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <script>
      function toggleHideManual(checkbox) {
        const url = new URL(window.location.href);
        if (checkbox.checked) {
          url.searchParams.set('hide_manual', '1');
        } else {
          url.searchParams.delete('hide_manual');
        }
        // Always preserve period param
        if (!url.searchParams.get('period')) {
          url.searchParams.set('period', '{{ selected_period }}');
        }
        // Use HTMX to reload dashboard content
        htmx.ajax('GET', url.toString(), {target: '#dashboard-content', swap: 'innerHTML'});
      }
    </script>
  </div>
  {% endif %}

  <!-- Include Stats Partial -->
  {% include 'plans/partials/dashboard_stats.html' %}

  <!-- Include Charts Partial -->
  <div class="ctz-chart-wrap p-3 sm:p-4 mt-5">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
        <span class="ctz-chip"><span aria-hidden="true">üìà</span> Insights</span>
        <span class="text-xs text-gray-500 dark:text-gray-400 hidden sm:inline">Trends, frequency, and breakdowns.</span>
      </div>
      <div class="text-xs text-gray-400 dark:text-gray-500">Period: <span class="font-semibold text-gray-600 dark:text-gray-300">{{ selected_period }}</span></div>
    </div>
    <div class="ctz-divider mb-4"></div>
    {% include 'plans/partials/dashboard_charts.html' %}
  </div>

  <!-- Recent Workouts Table -->
  <div class="mt-6 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 sm:p-6 shadow-sm">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
      <div class="flex items-center gap-2">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Recent Workouts</h3>
        <span class="ctz-chip"><span aria-hidden="true">üßæ</span> Latest</span>
      </div>
      <a href="{% url 'workouts:history' %}" class="text-sm font-semibold text-primary hover:text-primary-dark inline-flex items-center gap-1">
        See all
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    </div>
    {% include 'plans/partials/dashboard_recent_workouts.html' %}
  </div>

</div>
<!-- Close Dashboard Content Container -->

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Store chart instances globally so we can destroy them
  let chartInstances = {
    frequency: null,
    type: null,
    trends: null
  };

  // Initialize charts function
  function initializeCharts() {
    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const textColor = isDark ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.8)';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';

    // Get chart data from script tag
    const chartDataEl = document.getElementById('chart-data');
    if (!chartDataEl) return;

    let chartData;
    try {
      chartData = JSON.parse(chartDataEl.textContent || '{}');
    } catch (e) {
      return;
    }

    const workouts_by_week = chartData.workouts_by_week || [];
    const workouts_by_type = chartData.workouts_by_type || {};

    // Destroy existing charts before creating new ones
    if (chartInstances.frequency) {
      chartInstances.frequency.destroy();
      chartInstances.frequency = null;
    }
    if (chartInstances.type) {
      chartInstances.type.destroy();
      chartInstances.type = null;
    }
    if (chartInstances.trends) {
      chartInstances.trends.destroy();
      chartInstances.trends = null;
    }

    // Workout Frequency Chart
    const frequencyCtx = document.getElementById('workoutFrequencyChart');
    if (frequencyCtx) {
      const frequencyLabels = workouts_by_week.map(w => {
        const date = new Date(w.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      const frequencyCounts = workouts_by_week.map(w => w.count);

      chartInstances.frequency = new Chart(frequencyCtx, {
        type: 'bar',
        data: {
          labels: frequencyLabels,
          datasets: [{
            label: 'Workouts',
            data: frequencyCounts,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: 'rgb(59, 130, 246)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1, color: textColor },
              grid: { color: gridColor }
            },
            x: {
              ticks: { color: textColor },
              grid: { display: false }
            }
          }
        }
      });
    }

    // Workout Type Breakdown Chart
    const typeCtx = document.getElementById('workoutTypeChart');
    if (typeCtx) {
      const typeLabels = Object.keys(workouts_by_type);
      const typeCounts = Object.values(workouts_by_type);

      const colors = [
        'rgba(59, 130, 246, 0.8)',   // Blue
        'rgba(34, 197, 94, 0.8)',    // Green
        'rgba(234, 179, 8, 0.8)',    // Yellow
        'rgba(239, 68, 68, 0.8)',    // Red
        'rgba(168, 85, 247, 0.8)',   // Purple
        'rgba(236, 72, 153, 0.8)',   // Pink
        'rgba(14, 165, 233, 0.8)',   // Sky
        'rgba(251, 146, 60, 0.8)',   // Orange
      ];

      chartInstances.type = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
          labels: typeLabels,
          datasets: [{
            data: typeCounts,
            backgroundColor: colors.slice(0, typeLabels.length),
            borderWidth: 2,
            borderColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: textColor, padding: 15 }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Output Trends Chart
    const trendsCtx = document.getElementById('outputTrendsChart');
    if (trendsCtx) {
      const trendsLabels = workouts_by_week.map(w => {
        const date = new Date(w.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      const outputData = workouts_by_week.map(w => w.total_output || 0);
      const caloriesData = workouts_by_week.map(w => w.total_calories || 0);

      chartInstances.trends = new Chart(trendsCtx, {
        type: 'line',
        data: {
          labels: trendsLabels,
          datasets: [{
            label: 'Total Output (kJ)',
            data: outputData,
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            yAxisID: 'y',
            tension: 0.4,
            fill: true
          }, {
            label: 'Total Calories',
            data: caloriesData,
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            yAxisID: 'y1',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top', labels: { color: textColor } },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { ticks: { color: textColor }, grid: { color: gridColor } },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Output (kJ)', color: textColor },
              ticks: { color: textColor },
              grid: { color: gridColor }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Calories', color: textColor },
              ticks: { color: textColor },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }
  }

  // Initialize charts on page load
  document.addEventListener('DOMContentLoaded', initializeCharts);

  // Function to update active button states
  function updateActiveButton(period) {
    document.querySelectorAll('.period-filter').forEach(btn => {
      const btnPeriod = btn.getAttribute('data-period');
      if (btnPeriod === period) {
        btn.classList.add('bg-primary', 'text-white', 'shadow');
        btn.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100/80', 'dark:hover:bg-gray-700/60');
      } else {
        btn.classList.remove('bg-primary', 'text-white', 'shadow');
        btn.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100/80', 'dark:hover:bg-gray-700/60');
      }
    });
  }

  // Re-initialize charts after HTMX swaps
  document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'dashboard-content') {
      // Wait for DOM to settle, then initialize charts
      setTimeout(initializeCharts, 100);

      // Update active filter button states - extract period from the request URL
      const xhr = event.detail.xhr;
      if (xhr && xhr.responseURL) {
        const url = new URL(xhr.responseURL);
        const period = url.searchParams.get('period') || '7d';
        updateActiveButton(period);
      }
    }
  });

  // Also update buttons on direct click (for immediate visual feedback)
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.period-filter').forEach(btn => {
      btn.addEventListener('click', function() {
        const period = this.getAttribute('data-period');
        updateActiveButton(period);
      });
    });
  });
</script>
{% endblock %}
