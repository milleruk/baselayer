{% extends "base_app.html" %}
{% load static %}
{% load medal_tags dict_filters %}
{% block title %}Performance Metrics{% endblock %}
{% block page_title %}Performance Metrics{% endblock %}

{% block extra_scripts %}
  {% include "base/_scripts_charts.html" %}
{% endblock %}

{% block content %}
<script>
// Make global loader visible immediately (before DOMContentLoaded)
var loader = document.getElementById('global-loader');
if (loader) {
  loader.classList.remove('hidden');
  if (window.setRandomLoaderMessage) window.setRandomLoaderMessage();
}
</script>

<div id="metrics-content" class="opacity-0 transition-opacity duration-300">
  <!-- Skeleton loader for metrics -->
  <div id="metrics-skeleton" class="animate-pulse">
    <div class="h-8 w-1/3 bg-gray-200 dark:bg-gray-700 rounded mb-4"></div>
    <div class="h-4 w-1/2 bg-gray-200 dark:bg-gray-700 rounded mb-6"></div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="h-40 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
      <div class="h-40 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
    </div>
    <div class="h-64 bg-gray-200 dark:bg-gray-700 rounded-xl mb-8"></div>
  </div>
  <div id="metrics-real-content" style="display:none">
<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Performance Metrics</h1>
  <p class="text-gray-600 dark:text-gray-400">Track your progress and celebrate your achievements</p>
</div>

<!-- Top Section: Personal Records and This Month -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Personal Records -->
  <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-lg">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Personal Records</h2>
      <div class="flex gap-2">
        <button class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 bg-transparent rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors pr-period-btn" data-period="1">1 Month</button>
        <button class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 bg-transparent rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors pr-period-btn" data-period="2">2 Months</button>
        <button class="px-4 py-2 text-sm font-medium text-gray-900 dark:text-gray-900 bg-yellow-400 dark:bg-yellow-400 rounded-lg pr-period-btn active" data-period="3">3 Months</button>
      </div>
    </div>
    
    <div class="grid grid-cols-5 gap-4 mb-6">
      <div class="text-center">
        <div class="inline-block px-4 py-2 bg-purple-600 dark:bg-purple-600 rounded-lg mb-3 transform rotate-[-2deg] shadow-md">
          <div class="text-xs font-bold text-white uppercase tracking-wide transform rotate-[2deg]">1 MIN POWER</div>
        </div>
        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1 pr-value" data-interval="1min">‚Äî</div>
        <div class="text-sm text-gray-600 dark:text-gray-400 font-medium">W</div>
      </div>
      <div class="text-center">
        <div class="inline-block px-4 py-2 bg-purple-600 dark:bg-purple-600 rounded-lg mb-3 transform rotate-[1deg] shadow-md">
          <div class="text-xs font-bold text-white uppercase tracking-wide transform rotate-[-1deg]">3 MIN POWER</div>
        </div>
        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1 pr-value" data-interval="3min">‚Äî</div>
        <div class="text-sm text-gray-600 dark:text-gray-400 font-medium">W</div>
      </div>
      <div class="text-center">
        <div class="inline-block px-4 py-2 bg-purple-600 dark:bg-purple-600 rounded-lg mb-3 shadow-md">
          <div class="text-xs font-bold text-white uppercase tracking-wide">5 MIN POWER</div>
        </div>
        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1 pr-value" data-interval="5min">‚Äî</div>
        <div class="text-sm text-gray-600 dark:text-gray-400 font-medium">W</div>
      </div>
      <div class="text-center">
        <div class="inline-block px-4 py-2 bg-purple-600 dark:bg-purple-600 rounded-lg mb-3 transform rotate-[-1deg] shadow-md">
          <div class="text-xs font-bold text-white uppercase tracking-wide transform rotate-[1deg]">10 MIN POWER</div>
        </div>
        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1 pr-value" data-interval="10min">‚Äî</div>
        <div class="text-sm text-gray-600 dark:text-gray-400 font-medium">W</div>
      </div>
      <div class="text-center">
        <div class="inline-block px-4 py-2 bg-purple-600 dark:bg-purple-600 rounded-lg mb-3 transform rotate-[2deg] shadow-md">
          <div class="text-xs font-bold text-white uppercase tracking-wide transform rotate-[-2deg]">20 MIN POWER</div>
        </div>
        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1 pr-value" data-interval="20min">‚Äî</div>
        <div class="text-sm text-gray-600 dark:text-gray-400 font-medium">W</div>
      </div>
    </div>
    
    <div class="p-4 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-700 rounded-lg text-sm text-gray-600 dark:text-gray-400">
      Your best power outputs across different time intervals.
    </div>
  </div>

  <!-- This Month -->
  <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 shadow-lg">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-3">This Month</h2>
    <div class="flex items-center gap-3 mb-4">
      <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">Discipline:</span>
      <div class="flex gap-2">
        <button class="px-3 py-1.5 text-xs font-medium text-white bg-primary rounded-lg month-discipline-btn active" data-discipline="cycling">Cycling</button>
        <button class="px-3 py-1.5 text-xs font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors month-discipline-btn" data-discipline="running">Tread</button>
      </div>
    </div>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-3 space-y-3">
      <!-- Distance -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Distance</span>
        </div>
        <div class="flex items-center gap-6">
          <div class="text-right">
            <div class="text-xs text-gray-500 dark:text-gray-400">Monthly</div>
            <div class="text-sm font-semibold text-gray-900 dark:text-white month-distance cycling-data">{{ cycling_monthly_distance|floatformat:1 }}</div>
            <div class="text-sm font-semibold text-gray-900 dark:text-white month-distance running-data hidden">{{ running_monthly_distance|floatformat:1 }}</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500 dark:text-gray-400">Yearly</div>
            <div class="text-sm font-semibold text-gray-700 dark:text-gray-300 year-distance cycling-data">{{ cycling_yearly_distance|floatformat:1 }}</div>
            <div class="text-sm font-semibold text-gray-700 dark:text-gray-300 year-distance running-data hidden">{{ running_yearly_distance|floatformat:1 }}</div>
          </div>
        </div>
      </div>
      
      <!-- Output -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Output</span>
        </div>
        <div class="flex items-center gap-6">
          <div class="text-right">
            <div class="text-xs text-gray-500 dark:text-gray-400">Monthly</div>
            <div class="text-sm font-semibold text-gray-900 dark:text-white month-output cycling-data">{{ cycling_monthly_output|floatformat:0 }}</div>
            <div class="text-sm font-semibold text-gray-900 dark:text-white month-output running-data hidden">{{ running_monthly_output|floatformat:0 }}</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500 dark:text-gray-400">Yearly</div>
            <div class="text-sm font-semibold text-gray-700 dark:text-gray-300 year-output cycling-data">{{ cycling_yearly_output|floatformat:0 }}</div>
            <div class="text-sm font-semibold text-gray-700 dark:text-gray-300 year-output running-data hidden">{{ running_yearly_output|floatformat:0 }}</div>
          </div>
        </div>
      </div>
      
      <!-- TSS -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">TSS</span>
        </div>
        <div class="flex items-center gap-6">
          <div class="text-right">
            <div class="text-xs text-gray-500 dark:text-gray-400">Monthly</div>
            <div class="text-sm font-semibold text-gray-900 dark:text-white month-tss cycling-data">{{ cycling_monthly_tss|floatformat:0 }}</div>
            <div class="text-sm font-semibold text-gray-900 dark:text-white month-tss running-data hidden">{{ running_monthly_tss|floatformat:0 }}</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500 dark:text-gray-400">Yearly</div>
            <div class="text-sm font-semibold text-gray-700 dark:text-gray-300 year-tss cycling-data">{{ cycling_yearly_tss|floatformat:0 }}</div>
            <div class="text-sm font-semibold text-gray-700 dark:text-gray-300 year-tss running-data hidden">{{ running_yearly_tss|floatformat:0 }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Achievements & Milestones Section -->
<div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-lg mb-8">
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Achievements & Milestones</h2>
    <div class="flex gap-2">
      <button class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg metrics-tab-btn active" data-tab="achievements">Achievements</button>
      <button class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors metrics-tab-btn" data-tab="milestones">Milestones</button>
    </div>
  </div>
  
  <div id="achievements-tab" class="metrics-tab-content">
    {% if fully_completed_challenges %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for challenge_instance in fully_completed_challenges %}
          <div class="text-center p-6 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50 shadow-md hover:shadow-lg transition-shadow">
            {% block content %}
            <script>
            // Show global loader immediately
            var loader = document.getElementById('global-loader');
            if (loader) {
              loader.classList.remove('hidden');
              if (window.setRandomLoaderMessage) window.setRandomLoaderMessage();
            }
            </script>

            <div id="metrics-async-content"
                 hx-get="{% url 'plans:metrics_content' %}"
                 hx-trigger="load"
                 hx-target="#metrics-async-content"
                 hx-swap="innerHTML">
              <!-- Optionally, a skeleton or spinner can go here for instant feedback -->
            </div>
            {% endblock %}
      </div>
    {% endif %}
    <div id="pw-tread-current" class="mb-4" style="display: none;">
      {% if current_tread_pw %}
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2 font-medium">Current tread:</div>
        <div class="px-4 py-3 text-white bg-primary rounded-lg font-bold text-lg inline-block">
          {{ current_tread_pw }} W/kg
        </div>
      {% else %}
        <div class="text-center py-4 text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
          <div class="text-sm">No tread FTP data available. Add tread FTP entries to see power-to-weight ratio.</div>
        </div>
      {% endif %}
    </div>
    
    <!-- History Table -->
    <div class="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide mb-2">History</div>
    
    <!-- Cycling History Table -->
    <div id="pw-cycling-history" class="overflow-x-auto">
      {% if pw_history_cycling %}
        <table class="min-w-full text-xs">
          <thead>
            <tr class="border-b border-gray-200 dark:border-gray-700">
              <th class="text-left py-2 px-2 text-gray-600 dark:text-gray-400 font-semibold">Date</th>
              <th class="text-left py-2 px-2 text-gray-600 dark:text-gray-400 font-semibold">FTP</th>
              <th class="text-left py-2 px-2 text-gray-600 dark:text-gray-400 font-semibold">Weight</th>
              <th class="text-left py-2 px-2 text-gray-600 dark:text-gray-400 font-semibold">P/W</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in pw_history_cycling %}
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <td class="py-2 px-2 text-gray-900 dark:text-white">{{ entry.date }}</td>
                <td class="py-2 px-2 text-gray-900 dark:text-white">
                  {% if entry.ftp %}{{ entry.ftp }} W{% else %}‚Äî{% endif %}
                </td>
                <td class="py-2 px-2 text-gray-900 dark:text-white">
                  {% if entry.weight %}{{ entry.weight|floatformat:1 }} lbs{% else %}‚Äî{% endif %}
                </td>
                <td class="py-2 px-2 text-gray-900 dark:text-white">
                  {% if entry.pw_ratio %}{{ entry.pw_ratio }} W/kg{% else %}‚Äî{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="text-xs text-gray-600 dark:text-gray-400">
          Historical data will appear here once you add FTP and weight entries.
        </div>
      {% endif %}
    </div>
    
    <!-- Tread History Table -->
    <div id="pw-tread-history" class="overflow-x-auto" style="display: none;">
      {% if pw_history_tread %}
        <table class="min-w-full text-xs">
          <thead>
            <tr class="border-b border-gray-200 dark:border-gray-700">
              <th class="text-left py-2 px-2 text-gray-600 dark:text-gray-400 font-semibold">Date</th>
              <th class="text-left py-2 px-2 text-gray-600 dark:text-gray-400 font-semibold">FTP</th>
              <th class="text-left py-2 px-2 text-gray-600 dark:text-gray-400 font-semibold">Weight</th>
              <th class="text-left py-2 px-2 text-gray-600 dark:text-gray-400 font-semibold">P/W</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in pw_history_tread %}
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <td class="py-2 px-2 text-gray-900 dark:text-white">{{ entry.date }}</td>
                <td class="py-2 px-2 text-gray-900 dark:text-white">
                  {% if entry.ftp %}{{ entry.ftp }} W{% else %}‚Äî{% endif %}
                </td>
                <td class="py-2 px-2 text-gray-900 dark:text-white">
                  {% if entry.weight %}{{ entry.weight|floatformat:1 }} lbs{% else %}‚Äî{% endif %}
                </td>
                <td class="py-2 px-2 text-gray-900 dark:text-white">
                  {% if entry.pw_ratio %}{{ entry.pw_ratio }} W/kg{% else %}‚Äî{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="text-center py-8 text-gray-600 dark:text-gray-400">
          <div class="text-4xl mb-2">üìä</div>
          <div class="text-sm">No data to show. Add tread FTP entries to see power-to-weight history.</div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Average Heartbeat -->
  <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-lg">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white">Average Heart Rate</h3>
      <div class="flex items-center gap-2">
        <a href="{% url 'workouts:history' %}" class="text-sm text-primary hover:text-primary-dark font-medium">View Details ‚Üí</a>
      </div>
    </div>
    
    <div class="flex items-center gap-4 mb-6">
      <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">Period:</span>
      <div class="flex gap-2">
        <button class="px-3 py-1.5 text-xs font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors hr-period-btn" data-period="1">1M</button>
        <button class="px-3 py-1.5 text-xs font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors hr-period-btn" data-period="2">2M</button>
        <button class="px-3 py-1.5 text-xs font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors hr-period-btn" data-period="3">3M</button>
        <button class="px-3 py-1.5 text-xs font-medium text-white bg-primary rounded-lg hr-period-btn active" data-period="0">This Month</button>
      </div>
    </div>
    
    {% if hr_this_month.overall or hr_1m.overall or hr_2m.overall or hr_3m.overall %}
      <div class="space-y-4">
        <!-- Workout Type Breakdown -->
        <div class="space-y-3">
          <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700 hr-cycling-row" {% if not hr_this_month.Cycling and not hr_1m.Cycling and not hr_2m.Cycling and not hr_3m.Cycling %}style="display: none;"{% endif %}>
            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Cycling</span>
            <div class="px-4 py-2 bg-primary rounded-full">
              <span class="text-base font-bold text-white hr-value cycling-hr">{{ hr_this_month.Cycling|default:"‚Äî" }}</span>
              <span class="text-xs text-white/90 ml-1">bpm</span>
            </div>
          </div>
          <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700 hr-tread-row" {% if not hr_this_month.Tread and not hr_1m.Tread and not hr_2m.Tread and not hr_3m.Tread %}style="display: none;"{% endif %}>
            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Tread</span>
            <div class="px-4 py-2 bg-primary rounded-full">
              <span class="text-base font-bold text-white hr-value tread-hr">{{ hr_this_month.Tread|default:"‚Äî" }}</span>
              <span class="text-xs text-white/90 ml-1">bpm</span>
            </div>
          </div>
        </div>
        
        <!-- Separator -->
        <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>
        
        <!-- Overall Average -->
        <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-2 font-medium hr-period-label">This Month</div>
          <div class="flex items-center gap-3">
            <span class="text-base font-semibold text-gray-700 dark:text-gray-300">Overall Average:</span>
            <div class="flex items-baseline gap-1">
              <span class="text-3xl font-bold text-gray-900 dark:text-white hr-overall">{{ hr_this_month.overall|default:"‚Äî" }}</span>
              <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">bpm</span>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="text-center py-8 text-gray-600 dark:text-gray-400">
        <div class="text-4xl mb-2">‚ù§Ô∏è</div>
        <div class="text-sm">Heart rate data will appear here once workouts with heart rate are synced.</div>
      </div>
    {% endif %}
  </div>
</div>

<!-- FTP & Pace Progression - Three Separate Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <!-- Cycling FTP Card -->
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white">Cycling FTP</h3>
    </div>
    {% if ftp_entries %}
      <div class="relative" style="height: 300px;">
        <canvas id="ftpChart"></canvas>
      </div>
    {% else %}
      <div class="text-center py-12 text-gray-600 dark:text-gray-400">
        <div class="text-4xl mb-2">üìä</div>
        <p class="text-sm">No FTP data yet. Add FTP entries in your <a href="{% url 'profile' %}#tab-ftp-pace" class="text-primary hover:underline">profile settings</a>.</p>
      </div>
    {% endif %}
  </div>
  
  <!-- Running Pace Targets Card -->
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white">Running Pace Targets</h3>
    </div>
    {% if running_pace_entries %}
      <div class="relative" style="height: 300px;">
        <canvas id="runningPaceChart"></canvas>
      </div>
    {% else %}
      <div class="text-center py-12 text-gray-600 dark:text-gray-400">
        <div class="text-4xl mb-2">üèÉ</div>
        <p class="text-sm">No running pace data yet. Add pace entries in your <a href="{% url 'profile' %}#tab-ftp-pace" class="text-primary hover:underline">profile settings</a>.</p>
      </div>
    {% endif %}
  </div>
  
  <!-- Walking Pace Targets Card -->
  <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white">Walking Pace Targets</h3>
    </div>
    {% if walking_pace_entries %}
      <div class="relative" style="height: 300px;">
        <canvas id="walkingPaceChart"></canvas>
      </div>
    {% else %}
      <div class="text-center py-12 text-gray-600 dark:text-gray-400">
        <div class="text-4xl mb-2">üö∂</div>
        <p class="text-sm">No walking pace data yet. Add pace entries in your <a href="{% url 'profile' %}#tab-ftp-pace" class="text-primary hover:underline">profile settings</a>.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Time in Zones Section -->
<div class="mb-8">
  <!-- Cycling Time in Zones -->
  <div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Time in Zones</h2>
    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Cycling</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Current Month -->
      <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
        <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Current Month</h4>
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="cycling-month-total">{{ cycling_zones_month.total_formatted }}</div>
        <div class="relative" style="height: 250px;">
          <canvas id="cyclingZonesMonthChart"></canvas>
        </div>
        <div class="mt-4 space-y-2" id="cycling-month-legend"></div>
      </div>
      
      <!-- Current Year -->
      <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
        <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Current Year</h4>
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="cycling-year-total">{{ cycling_zones_year.total_formatted }}</div>
        <div class="relative" style="height: 250px;">
          <canvas id="cyclingZonesYearChart"></canvas>
        </div>
        <div class="mt-4 space-y-2" id="cycling-year-legend"></div>
      </div>
      
      <!-- All Time -->
      <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
        <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">All Time</h4>
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="cycling-all-total">{{ cycling_zones_all.total_formatted }}</div>
        <div class="relative" style="height: 250px;">
          <canvas id="cyclingZonesAllChart"></canvas>
        </div>
        <div class="mt-4 space-y-2" id="cycling-all-legend"></div>
      </div>
    </div>
  </div>
  
  <!-- Running Time in Zones -->
  <div class="mb-8">
    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Running</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Current Month -->
      <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
        <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Current Month</h4>
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="running-month-total">{{ running_zones_month.total_formatted }}</div>
        <div class="relative" style="height: 250px;">
          <canvas id="runningZonesMonthChart"></canvas>
        </div>
        <div class="mt-4 space-y-2" id="running-month-legend"></div>
      </div>
      
      <!-- Current Year -->
      <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
        <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Current Year</h4>
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="running-year-total">{{ running_zones_year.total_formatted }}</div>
        <div class="relative" style="height: 250px;">
          <canvas id="runningZonesYearChart"></canvas>
        </div>
        <div class="mt-4 space-y-2" id="running-year-legend"></div>
      </div>
      
      <!-- All Time -->
      <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
        <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">All Time</h4>
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="running-all-total">{{ running_zones_all.total_formatted }}</div>
        <div class="relative" style="height: 250px;">
          <canvas id="runningZonesAllChart"></canvas>
        </div>
        <div class="mt-4 space-y-2" id="running-all-legend"></div>
      </div>
    </div>
  </div>
</div>
</div> <!-- End metrics-content -->

<!-- Note: This script remains inline as it uses Django template variables extensively -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Tab switching for Achievements/Milestones
  document.querySelectorAll('.metrics-tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const tabName = this.dataset.tab;
      
      // Update buttons
      document.querySelectorAll('.metrics-tab-btn').forEach(b => {
        b.classList.remove('active', 'bg-primary', 'text-white');
        b.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      });
      this.classList.add('active', 'bg-primary', 'text-white');
      this.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      
      // Update content
      document.getElementById('achievements-tab').classList.toggle('hidden', tabName !== 'achievements');
      document.getElementById('milestones-tab').classList.toggle('hidden', tabName !== 'milestones');
    });
  });
  
  // Personal Records period buttons
  const prData = {
    1: {{ personal_records_1m|safe }},
    2: {{ personal_records_2m|safe }},
    3: {{ personal_records_3m|safe }}
  };
  
  let prChart = null;
  
  function updatePersonalRecords(period) {
    const records = prData[period] || {};
    const intervals = ['1min', '3min', '5min', '10min', '20min'];
    const labels = ['1 Min', '3 Min', '5 Min', '10 Min', '20 Min'];
    const values = intervals.map(i => records[i] || 0);
    
    // Update text values
    document.querySelectorAll('.pr-value').forEach(el => {
      const interval = el.dataset.interval;
      const value = records[interval] || 0;
      el.textContent = value > 0 ? value : '‚Äî';
      // Update the "W" label visibility
      const wLabel = el.nextElementSibling;
      if (wLabel && value > 0) {
        wLabel.style.display = 'block';
      } else if (wLabel) {
        wLabel.style.display = 'none';
      }
    });
    
    // Update chart
    if (prChart) {
      prChart.data.datasets[0].data = values;
      prChart.update('none');
    }
  }
  
  // Initialize Personal Records Chart
  const prCtx = document.getElementById('personalRecordsChart');
  if (prCtx) {
    const isDark = document.documentElement.classList.contains('dark');
    const textColor = isDark ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.8)';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
    
    const initialData = prData[3] || {};
    const intervals = ['1min', '3min', '5min', '10min', '20min'];
    const labels = ['1 Min', '3 Min', '5 Min', '10 Min', '20 Min'];
    const initialValues = intervals.map(i => initialData[i] || 0);
    
    prChart = new Chart(prCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Power (W)',
          data: initialValues,
          backgroundColor: 'rgba(59, 130, 246, 0.7)',
          borderColor: 'rgb(59, 130, 246)',
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: isDark ? 'rgba(31, 41, 55, 0.95)' : 'rgba(255, 255, 255, 0.95)',
            titleColor: textColor,
            bodyColor: textColor,
            borderColor: isDark ? 'rgba(75, 85, 99, 1)' : 'rgba(229, 231, 235, 1)',
            borderWidth: 1,
            padding: 12,
            callbacks: {
              label: function(context) {
                return context.parsed.y > 0 ? context.parsed.y + ' W' : 'No data';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              color: textColor,
              font: {
                size: 11
              }
            },
            grid: {
              color: gridColor
            }
          },
          x: {
            ticks: {
              color: textColor,
              font: {
                size: 11
              }
            },
            grid: {
              display: false
            }
          }
        }
      }
    });
  }
  
  document.querySelectorAll('.pr-period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const period = parseInt(this.dataset.period);
      this.parentElement.querySelectorAll('.pr-period-btn').forEach(b => {
        b.classList.remove('bg-yellow-400', 'dark:bg-yellow-400', 'text-gray-900', 'dark:text-gray-900', 'active');
        b.classList.add('bg-transparent', 'text-gray-600', 'dark:text-gray-400');
      });
      this.classList.add('bg-yellow-400', 'dark:bg-yellow-400', 'text-gray-900', 'dark:text-gray-900', 'active');
      this.classList.remove('bg-transparent', 'text-gray-600', 'dark:text-gray-400');
      updatePersonalRecords(period);
    });
  });
  
  // Initialize with 3 months (default)
  updatePersonalRecords(3);
  
  // Heart Rate period buttons
  const hrData = {
    0: {{ hr_this_month|safe }},
    1: {{ hr_1m|safe }},
    2: {{ hr_2m|safe }},
    3: {{ hr_3m|safe }}
  };
  
  const periodLabels = {
    0: 'This Month',
    1: '1 Month',
    2: '2 Months',
    3: '3 Months'
  };
  
  function updateHeartRate(period) {
    const data = hrData[period] || {};
    const label = periodLabels[period] || 'This Month';
    
    // Update cycling HR
    const cyclingHr = document.querySelector('.cycling-hr');
    if (cyclingHr) {
      const value = data.Cycling || 0;
      cyclingHr.textContent = value > 0 ? value : '‚Äî';
      // Show/hide cycling row based on data
      const cyclingRow = document.querySelector('.hr-cycling-row');
      if (cyclingRow) {
        cyclingRow.style.display = value > 0 ? 'flex' : 'none';
      }
    }
    
    // Update tread HR
    const treadHr = document.querySelector('.tread-hr');
    if (treadHr) {
      const value = data.Tread || 0;
      treadHr.textContent = value > 0 ? value : '‚Äî';
      // Show/hide tread row based on data
      const treadRow = document.querySelector('.hr-tread-row');
      if (treadRow) {
        treadRow.style.display = value > 0 ? 'flex' : 'none';
      }
    }
    
    // Update overall HR
    const overallHr = document.querySelector('.hr-overall');
    if (overallHr) {
      const value = data.overall || 0;
      overallHr.textContent = value > 0 ? value : '‚Äî';
    }
    
    // Update period label
    const periodLabel = document.querySelector('.hr-period-label');
    if (periodLabel) {
      periodLabel.textContent = label;
    }
  }
  
  document.querySelectorAll('.hr-period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const period = parseInt(this.dataset.period);
      this.parentElement.querySelectorAll('.hr-period-btn').forEach(b => {
        b.classList.remove('bg-primary', 'text-white', 'active');
        b.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      });
      this.classList.add('bg-primary', 'text-white', 'active');
      this.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      updateHeartRate(period);
    });
  });
  
  // Initialize with "This Month" (default)
  updateHeartRate(0);
  
  // This Month discipline buttons
  document.querySelectorAll('.month-discipline-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const discipline = this.dataset.discipline;
      this.parentElement.querySelectorAll('.month-discipline-btn').forEach(b => {
        b.classList.remove('bg-primary', 'text-white', 'active');
        b.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      });
      this.classList.add('bg-primary', 'text-white', 'active');
      this.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      
      // Show/hide values based on discipline
      if (discipline === 'cycling') {
        document.querySelectorAll('.cycling-data').forEach(el => el.classList.remove('hidden'));
        document.querySelectorAll('.running-data').forEach(el => el.classList.add('hidden'));
      } else {
        document.querySelectorAll('.cycling-data').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.running-data').forEach(el => el.classList.remove('hidden'));
      }
    });
  });
  
  // Power to Weight activity buttons (Cycling/Tread)
  document.querySelectorAll('.pw-activity-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const activity = this.dataset.activity;
      
      // Update button styles
      this.parentElement.querySelectorAll('.pw-activity-btn').forEach(b => {
        b.classList.remove('bg-primary', 'text-white', 'active');
        b.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      });
      this.classList.add('bg-primary', 'text-white', 'active');
      this.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      
      // Show/hide current values based on activity
      const cyclingCurrent = document.getElementById('pw-cycling-current');
      const treadCurrent = document.getElementById('pw-tread-current');
      const cyclingHistory = document.getElementById('pw-cycling-history');
      const treadHistory = document.getElementById('pw-tread-history');
      
      if (activity === 'cycling') {
        if (cyclingCurrent) cyclingCurrent.style.display = 'block';
        if (treadCurrent) treadCurrent.style.display = 'none';
        if (cyclingHistory) cyclingHistory.style.display = 'block';
        if (treadHistory) treadHistory.style.display = 'none';
      } else if (activity === 'tread') {
        if (cyclingCurrent) cyclingCurrent.style.display = 'none';
        if (treadCurrent) treadCurrent.style.display = 'block';
        if (cyclingHistory) cyclingHistory.style.display = 'none';
        if (treadHistory) treadHistory.style.display = 'block';
      }
    });
  });
  
  // Helper function to detect dark mode
  function isDarkMode() {
    return document.documentElement.classList.contains('dark');
  }
  
  // Initialize FTP Chart
  {% if ftp_entries %}
  const ftpCtx = document.getElementById('ftpChart');
  if (ftpCtx) {
    const ftpData = {
      labels: [
        {% for entry in ftp_entries %}
          "{{ entry.recorded_date|date:'m/d/y' }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      datasets: [{
        label: 'FTP (Watts)',
        data: [
          {% for entry in ftp_entries %}
            {{ entry.ftp_value }}{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        backgroundColor: 'rgba(70, 95, 255, 0.8)',
        borderColor: 'rgba(70, 95, 255, 1)',
        borderWidth: 1
      }]
    };
    
    const textColor = isDarkMode() ? '#e5e7eb' : '#374151';
    const gridColor = isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const tickColor = isDarkMode() ? '#9ca3af' : '#6b7280';
    
    new Chart(ftpCtx, {
      type: 'bar',
      data: ftpData,
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: isDarkMode() ? 'rgba(31, 41, 55, 0.95)' : 'rgba(255, 255, 255, 0.95)',
            titleColor: textColor,
            bodyColor: textColor,
            borderColor: isDarkMode() ? 'rgba(75, 85, 99, 1)' : 'rgba(229, 231, 235, 1)',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return context.parsed.x + ' W';
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'FTP (Watts)',
              color: textColor
            },
            grid: {
              color: gridColor
            },
            ticks: {
              color: tickColor
            }
          },
          y: {
            title: {
              display: false
            },
            grid: {
              display: false
            },
            ticks: {
              color: tickColor
            }
          }
        }
      }
    });
  }
  {% endif %}
  
  // Initialize Running Pace Chart
  {% if running_pace_entries %}
  const runningPaceCtx = document.getElementById('runningPaceChart');
  if (runningPaceCtx) {
    const runningPaceEntries = [];
    
    {% for entry in running_pace_entries %}
      runningPaceEntries.push({
        dateStr: "{{ entry.recorded_date|date:'m/d/y' }}",
        dateSort: "{{ entry.recorded_date|date:'Y-m-d' }}",
        level: {{ entry.level }}
      });
    {% endfor %}
    
    // Sort by date
    runningPaceEntries.sort((a, b) => a.dateSort.localeCompare(b.dateSort));
    
    const runningPaceData = {
      labels: runningPaceEntries.map(e => e.dateStr),
      datasets: [{
        label: 'Pace Level',
        data: runningPaceEntries.map(e => e.level),
        backgroundColor: 'rgba(34, 197, 94, 0.8)',
        borderColor: 'rgba(34, 197, 94, 1)',
        borderWidth: 1
      }]
    };
    
    const textColor = isDarkMode() ? '#e5e7eb' : '#374151';
    const gridColor = isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const tickColor = isDarkMode() ? '#9ca3af' : '#6b7280';
    
    new Chart(runningPaceCtx, {
      type: 'bar',
      data: runningPaceData,
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: isDarkMode() ? 'rgba(31, 41, 55, 0.95)' : 'rgba(255, 255, 255, 0.95)',
            titleColor: textColor,
            bodyColor: textColor,
            borderColor: isDarkMode() ? 'rgba(75, 85, 99, 1)' : 'rgba(229, 231, 235, 1)',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return 'Level ' + context.parsed.x;
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            max: 10,
            title: {
              display: true,
              text: 'Pace Level',
              color: textColor
            },
            grid: {
              color: gridColor
            },
            ticks: {
              color: tickColor,
              stepSize: 1
            }
          },
          y: {
            title: {
              display: false
            },
            grid: {
              display: false
            },
            ticks: {
              color: tickColor
            }
          }
        }
      }
    });
  }
  {% endif %}
  
  // Initialize Walking Pace Chart
  {% if walking_pace_entries %}
  const walkingPaceCtx = document.getElementById('walkingPaceChart');
  if (walkingPaceCtx) {
    const walkingPaceEntries = [];
    
    {% for entry in walking_pace_entries %}
      walkingPaceEntries.push({
        dateStr: "{{ entry.recorded_date|date:'m/d/y' }}",
        dateSort: "{{ entry.recorded_date|date:'Y-m-d' }}",
        level: {{ entry.level }}
      });
    {% endfor %}
    
    // Sort by date
    walkingPaceEntries.sort((a, b) => a.dateSort.localeCompare(b.dateSort));
    
    const walkingPaceData = {
      labels: walkingPaceEntries.map(e => e.dateStr),
      datasets: [{
        label: 'Pace Level',
        data: walkingPaceEntries.map(e => e.level),
        backgroundColor: 'rgba(34, 197, 94, 0.8)',
        borderColor: 'rgba(34, 197, 94, 1)',
        borderWidth: 1
      }]
    };
    
    const textColor = isDarkMode() ? '#e5e7eb' : '#374151';
    const gridColor = isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const tickColor = isDarkMode() ? '#9ca3af' : '#6b7280';
    
    new Chart(walkingPaceCtx, {
      type: 'bar',
      data: walkingPaceData,
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: isDarkMode() ? 'rgba(31, 41, 55, 0.95)' : 'rgba(255, 255, 255, 0.95)',
            titleColor: textColor,
            bodyColor: textColor,
            borderColor: isDarkMode() ? 'rgba(75, 85, 99, 1)' : 'rgba(229, 231, 235, 1)',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return 'Level ' + context.parsed.x;
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            max: 10,
            title: {
              display: true,
              text: 'Pace Level',
              color: textColor
            },
            grid: {
              color: gridColor
            },
            ticks: {
              color: tickColor,
              stepSize: 1
            }
          },
          y: {
            title: {
              display: false
            },
            grid: {
              display: false
            },
            ticks: {
              color: tickColor
            }
          }
        }
      }
    });
  }
  {% endif %}
  
  // Cycling Zone Colors (matching Peloton standard)
  const CYCLING_ZONE_COLORS = {
    1: '#4c6ef5',  // Blue - Recovery
    2: '#22c55e',  // Green - Endurance
    3: '#f59e0b',  // Orange - Tempo
    4: '#ef4444',  // Red - Threshold
    5: '#ec4899',  // Pink/Purple - VO2 Max
    6: '#a855f7',  // Light Purple - Anaerobic
    7: '#9333ea',  // Darker Purple - Neuromuscular
  };
  
  // Running Zone Colors
  const RUNNING_ZONE_COLORS = {
    'recovery': '#4c6ef5',  // Blue
    'easy': '#22c55e',     // Green
    'moderate': '#fbbf24', // Yellow-Orange
    'challenging': '#f59e0b', // Orange
    'hard': '#ef4444',     // Red
    'very_hard': '#a855f7', // Purple
    'max': '#ec4899',      // Pink
  };
  
  // Helper function to create donut chart
  function createZoneChart(canvasId, zoneData, colors, legendId) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;
    
    // Prepare data
    const labels = [];
    const data = [];
    const backgroundColors = [];
    
    // For cycling, zones are numbered 1-7
    if (zoneData.zones && typeof zoneData.zones[1] !== 'undefined') {
      // Cycling zones
      for (let zone = 1; zone <= 7; zone++) {
        const zoneInfo = zoneData.zones[zone];
        labels.push(zoneInfo.name);
        data.push(zoneInfo.time_seconds);
        backgroundColors.push(colors[zone] || '#888');
      }
    } else {
      // Running zones
      const zoneOrder = ['recovery', 'easy', 'moderate', 'challenging', 'hard', 'very_hard', 'max'];
      for (const zoneKey of zoneOrder) {
        const zoneInfo = zoneData.zones[zoneKey];
        if (zoneInfo) {
          labels.push(zoneInfo.name);
          data.push(zoneInfo.time_seconds);
          backgroundColors.push(colors[zoneKey] || '#888');
        }
      }
    }
    
    // Create legend
    const legendEl = document.getElementById(legendId);
    if (legendEl) {
      legendEl.innerHTML = '';
      labels.forEach((label, index) => {
        // Get the correct zone key based on whether it's cycling or running
        let zoneKey;
        if (typeof zoneData.zones[1] !== 'undefined') {
          // Cycling zones (numbered 1-7)
          zoneKey = index + 1;
        } else {
          // Running zones (named)
          zoneKey = ['recovery', 'easy', 'moderate', 'challenging', 'hard', 'very_hard', 'max'][index];
        }
        const timeFormatted = zoneData.zones[zoneKey].time_formatted;
        const color = backgroundColors[index];
        const legendItem = document.createElement('div');
        legendItem.className = 'flex items-center justify-between text-sm';
        legendItem.innerHTML = `
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full" style="background-color: ${color};"></div>
            <span class="text-gray-700 dark:text-gray-300">${label}</span>
          </div>
          <span class="text-gray-600 dark:text-gray-400 font-medium">${timeFormatted}</span>
        `;
        legendEl.appendChild(legendItem);
      });
    }
    
    const isDark = isDarkMode();
    const textColor = isDark ? '#e5e7eb' : '#374151';
    
    return new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: backgroundColors,
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: isDark ? 'rgba(31, 41, 55, 0.95)' : 'rgba(255, 255, 255, 0.95)',
            titleColor: textColor,
            bodyColor: textColor,
            borderColor: isDark ? 'rgba(75, 85, 99, 1)' : 'rgba(229, 231, 235, 1)',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                let zoneKey;
                if (typeof zoneData.zones[1] !== 'undefined') {
                  zoneKey = context.dataIndex + 1;
                } else {
                  zoneKey = ['recovery', 'easy', 'moderate', 'challenging', 'hard', 'very_hard', 'max'][context.dataIndex];
                }
                const timeFormatted = zoneData.zones[zoneKey].time_formatted;
                return `${label}: ${timeFormatted} (${percentage}%)`;
              }
            }
          }
        },
        cutout: '60%'
      }
    });
    // No code after this return
  }
  
  // Track chart creation - wrap createZoneChart to count charts
  let chartsCreated = 0;
  const expectedCharts = document.querySelectorAll('canvas').length;
  const originalCreateZoneChart = createZoneChart;
  
  createZoneChart = function(...args) {
    const result = originalCreateZoneChart.apply(this, args);
    chartsCreated++;
    
    // If all expected charts are created, hide loading overlay
    if (chartsCreated >= expectedCharts || expectedCharts === 0) {
      setTimeout(() => {
        hideLoadingOverlay();
      }, 500);
    }
    
    return result;
  };
  
  // Initialize Cycling Zone Charts
  {% if cycling_zones_month %}
  const cyclingZonesMonthData = {{ cycling_zones_month|safe }};
  createZoneChart('cyclingZonesMonthChart', cyclingZonesMonthData, CYCLING_ZONE_COLORS, 'cycling-month-legend');
  {% endif %}
  
  {% if cycling_zones_year %}
  const cyclingZonesYearData = {{ cycling_zones_year|safe }};
  createZoneChart('cyclingZonesYearChart', cyclingZonesYearData, CYCLING_ZONE_COLORS, 'cycling-year-legend');
  {% endif %}
  
  {% if cycling_zones_all %}
  const cyclingZonesAllData = {{ cycling_zones_all|safe }};
  createZoneChart('cyclingZonesAllChart', cyclingZonesAllData, CYCLING_ZONE_COLORS, 'cycling-all-legend');
  {% endif %}
  
  // Initialize Running Zone Charts
  {% if running_zones_month %}
  const runningZonesMonthData = {{ running_zones_month|safe }};
  createZoneChart('runningZonesMonthChart', runningZonesMonthData, RUNNING_ZONE_COLORS, 'running-month-legend');
  {% endif %}
  
  {% if running_zones_year %}
  const runningZonesYearData = {{ running_zones_year|safe }};
  createZoneChart('runningZonesYearChart', runningZonesYearData, RUNNING_ZONE_COLORS, 'running-year-legend');
  {% endif %}
  
  {% if running_zones_all %}
  const runningZonesAllData = {{ running_zones_all|safe }};
  createZoneChart('runningZonesAllChart', runningZonesAllData, RUNNING_ZONE_COLORS, 'running-all-legend');
  {% endif %}
  
  // Hide global loader and skeleton, show real content after charts are initialized
  function showMetricsContent() {
    var loader = document.getElementById('global-loader');
    var skeleton = document.getElementById('metrics-skeleton');
    var realContent = document.getElementById('metrics-real-content');
    var content = document.getElementById('metrics-content');
    if (loader) loader.classList.add('hidden');
    if (skeleton) skeleton.style.display = 'none';
    if (realContent) realContent.style.display = '';
    if (content) content.style.opacity = '1';
  }

  // Call after all charts are ready
  showMetricsContent();

  // Fallback: Hide loader and skeleton after 3s if something goes wrong
  setTimeout(() => {
    showMetricsContent();
  }, 3000);
});
</script>
{% endblock %}
